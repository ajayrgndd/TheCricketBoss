<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    /* [Style unchanged ‚Äî omitted for brevity] */
  </style>
</head>
<body>

  <!-- Top bar & bottom nav will be injected by shared-ui.js -->

  <div class="main">
    <h2>Welcome back!</h2>
    <div class="preparation-section">
      <h3>Match Preparation</h3>
      <div id="trainingStatus">Checking training status...</div>
      <a href="training.html"><button id="goTrainingBtn">Go to Training</button></a>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { loadSharedUI } from "./shared-ui.js";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    async function distributeDailyLoginXP(userId) {
      const today = new Date().toISOString().split("T")[0];

      const { data, error } = await supabase
        .from("profiles")
        .select("last_xp_login_date")
        .eq("id", userId)
        .single();

      if (error) {
        console.error("‚ùå Could not fetch login date:", error.message);
        return;
      }

      if (data?.last_xp_login_date !== today) {
        await addManagerXP(userId, "daily_login");

        const { error: updateErr } = await supabase
          .from("profiles")
          .update({ last_xp_login_date: today })
          .eq("id", userId);

        if (updateErr) {
          console.error("‚ùå Could not update login date:", updateErr.message);
        }
      } else {
        console.log("üïò Daily XP already claimed today.");
      }
    }

    async function main() {
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        window.location.href = "login.html";
        return;
      }

      const { data: profile } = await supabase
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (!profile || !profile.manager_name?.trim() || !profile.team_name?.trim()) {
        console.warn("‚ö†Ô∏è Profile incomplete. Redirecting...");
        window.location.href = "profile-setup.html";
        return;
      }

      // Load UI top bar + bottom nav
      loadSharedUI({
        manager_name: profile.manager_name,
        xp: profile.xp ?? 0,
        coins: profile.coins ?? 0,
        cash: profile.cash ?? 0
      });

      // Daily XP
      await distributeDailyLoginXP(user.id);

      const { data: team } = await supabase
        .from("teams")
        .select("*")
        .eq("owner_id", user.id)
        .single();

      const { data: lastMatch } = await supabase
        .from("matches")
        .select("*")
        .or(`home_team_id.eq.${team.id},away_team_id.eq.${team.id}`)
        .order("date", { ascending: false })
        .limit(1)
        .single();

      const lastMatchDate = lastMatch?.date || "1970-01-01";

      const { data: trainingLogs } = await supabase
        .from("training_logs")
        .select("*")
        .eq("team_id", team.id)
        .gte("created_at", lastMatchDate);

      const trainedPlayers = new Set(trainingLogs?.map(t => t.player_id));
      const trainingCompleted = trainedPlayers.size >= 3;

      const statusDiv = document.getElementById("trainingStatus");
      const goBtn = document.getElementById("goTrainingBtn");

      if (trainingCompleted) {
        statusDiv.innerHTML = "‚úÖ <strong>Training Completed</strong> (3 players trained)";
        goBtn.disabled = true;
      } else {
        statusDiv.innerHTML = "‚ùå <strong>Training Pending</strong> ‚Äì Train 3 players before next match";
        goBtn.disabled = false;
      }
    }

    main();
  </script>
</body>
</html>
