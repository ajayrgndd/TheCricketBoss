<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding-bottom: 70px; /* space for bottom nav */
    }

    .main {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }

    .welcome {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 20px;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .grid-item {
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .grid-item h3 {
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .grid-item p {
      font-size: 0.9rem;
      margin-bottom: 10px;
    }

    .grid-item button {
      padding: 10px 16px;
      font-size: 0.9rem;
      background: #00e676;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .grid-item button:disabled {
      background: #555;
      color: #aaa;
      cursor: not-allowed;
    }

    @media (max-width: 480px) {
      .grid-item {
        padding: 14px;
      }

      .grid-item h3 {
        font-size: 0.95rem;
      }

      .grid-item button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Top bar & bottom nav will be injected by shared-ui.js -->

  <div class="main">
    <div class="welcome">üëã Welcome back, Manager!</div>

    <div class="grid-container">
<!-- Next Fixture Block -->
<div class="grid-item" id="fixture-block">
  <h3>Next Fixture</h3>
  <p id="fixture-details">Loading upcoming match...</p>
  <a href="matches.html">
    <button>üìÖ View Full Fixtures</button>
  </a>
</div>

      <!-- Match Preparation Block -->
      <div class="grid-item">
        <h3>Match Preparation</h3>
        <p id="trainingStatus">Checking training status...</p>
        <a href="training.html">
          <button id="goTrainingBtn">Go to Training</button>
        </a>
      </div>

      <!-- Friendly Match Block -->
      <div class="grid-item">
        <h3>Practice Game</h3>
        <p>Try a friendly match before your league game.</p>
        <a href="book-friendly.html">
          <button>üìñ Book Friendly Match</button>
        </a>
      </div>

      <!-- You can add more blocks here later -->
      <!-- Example: Stadium, League, Scout, XP History etc. -->

    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { loadSharedUI, addManagerXP } from "./js/shared-ui.js";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    async function distributeDailyLoginXP(userId) {
      const today = new Date().toISOString().split("T")[0];
      const { data, error } = await supabase
        .from("profiles")
        .select("last_xp_login_date")
        .eq("user_id", userId)
        .single();

      if (error) {
        console.error("‚ùå Could not fetch login date:", error.message);
        return;
      }

      if (data?.last_xp_login_date !== today) {
        await addManagerXP(supabase, userId, "daily_login");

        const { error: updateErr } = await supabase
          .from("profiles")
          .update({ last_xp_login_date: today })
          .eq("user_id", userId);

        if (updateErr) {
          console.error("‚ùå Could not update login date:", updateErr.message);
        }
      } else {
        console.log("üïò Daily XP already claimed today.");
      }
    }

    async function main() {
      const { data: { user }, error: authError } = await supabase.auth.getUser();
      if (authError || !user) {
        window.location.href = "login.html";
        return;
      }

      const { data: profile } = await supabase
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (!profile || !profile.manager_name?.trim() || !profile.team_name?.trim()) {
        console.warn("‚ö†Ô∏è Profile incomplete. Redirecting...");
        window.location.href = "profile-setup.html";
        return;
      }

      loadSharedUI({
        supabase,
        manager_name: profile.manager_name,
        xp: profile.xp ?? 0,
        coins: profile.coins ?? 0,
        cash: profile.cash ?? 0
      });

      await distributeDailyLoginXP(user.id);

      const { data: team } = await supabase
        .from("teams")
        .select("*")
        .eq("owner_id", user.id)
        .single();

      const { data: lastMatch } = await supabase
        .from("matches")
        .select("*")
        .or(`home_team_id.eq.${team.id},away_team_id.eq.${team.id}`)
        .order("date", { ascending: false })
        .limit(1)
        .single();

      const lastMatchDate = lastMatch?.date || "1970-01-01";

      const { data: trainingLogs } = await supabase
        .from("training_logs")
        .select("*")
        .eq("team_id", team.id)
        .gte("created_at", lastMatchDate);

      const trainedPlayers = new Set(trainingLogs?.map(t => t.player_id));
      const trainingCompleted = trainedPlayers.size >= 3;

      const statusDiv = document.getElementById("trainingStatus");
      const goBtn = document.getElementById("goTrainingBtn");

      if (trainingCompleted) {
        statusDiv.innerHTML = "‚úÖ <strong>Training Completed</strong> (3 players trained)";
        goBtn.disabled = true;
      } else {
        statusDiv.innerHTML = "‚ùå <strong>Training Pending</strong> ‚Äì Train 3 players before next match";
        goBtn.disabled = false;
      }
    }

    main();
  </script>
</body>
</html>
