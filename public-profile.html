<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Public Profile â€“ TheCricketBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    :root {
      --bg:#1e1b3a; --card:#2d2a4a; --muted:#444; --accent:#00e676;
      --text:#fff; --text-dim:#cfd3ff; --link:#8affc3;
      --topbar-h: 60px; /* fallback height for sticky tabs */
    }
    body { margin:0; background:var(--bg); color:var(--text); font-family:'Segoe UI',sans-serif; }

    /* Tabs sit under the fixed top bar injected by shared-ui.js */
    .tabs{
      position:sticky; top:var(--topbar-h); z-index:5;
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;
      background:rgba(30,27,58,.95); backdrop-filter:blur(6px);
      padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.06);
      margin-bottom:16px;
    }
    .tab{ text-align:center; background:var(--card); color:var(--text);
      border-radius:10px; padding:10px 6px; text-decoration:none; font-weight:600;
      border:1px solid rgba(255,255,255,.08); cursor:pointer; }
    .tab.active{ outline:2px solid var(--accent); color:#000; background:#8affc3; }

    .main{ padding:20px 16px 90px; max-width:900px; margin:auto; }
    h2{ text-align:center; margin:20px 0 16px; }

    .section{ background:var(--card); padding:16px; border-radius:12px; margin-bottom:20px;
      border:1px solid rgba(255,255,255,.06); }
    .section h3{ margin:0 0 10px; border-bottom:1px solid var(--muted); padding-bottom:8px; font-size:18px; }
    .info-row{ display:flex; justify-content:space-between; margin:6px 0; color:var(--text-dim); }
    .info-row span:last-child{ color:var(--text); }
    .progress-bar{ height:10px; background:#444; border-radius:6px; overflow:hidden; margin-top:8px; }
    .progress-fill{ height:100%; width:0%; background:var(--accent); transition:width .5s ease; }

    /* Ratings */
    .ratings{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    .rating-card{ background:rgba(0,0,0,.15); border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:12px; display:grid; grid-template-columns:auto 1fr; align-items:center; gap:10px; }
    .rating-card img{ width:28px; height:28px; display:block; }
    .rating-value{ font-size:20px; font-weight:800; line-height:1.1; }
    .rating-label{ font-size:12px; opacity:.9; margin-top:2px; color:var(--text-dim); }

    /* Players table (public-safe) */
    .table{ width:100%; border-collapse:separate; border-spacing:0; }
    .table th, .table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left; font-size:14px; }
    .table th{ color:var(--text-dim); font-weight:600; }
    .chip{ padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08); font-size:12px; }

    /* Matches lists */
    .list{ display:grid; gap:10px; }
    .match-card{ display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px; border-radius:12px; background:rgba(0,0,0,.15); border:1px solid rgba(255,255,255,.06); }
    .muted{ color:var(--text-dim); font-size:13px; }
    .btn{ background:var(--accent); color:#000; border:none; border-radius:8px; padding:8px 12px; font-weight:700; cursor:pointer; }
    a.team-link{ color:var(--link); text-decoration:none; }
    a.team-link:hover{ text-decoration:underline; }

    @media (max-width:900px){ .ratings{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:600px){
      .tabs{ grid-template-columns:1fr 1fr 1fr; }
      .hide-sm{ display:none; }
      .table th.hide-sm, .table td.hide-sm{ display:none; }
    }
  </style>
</head>
<body>
  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab active" data-tab="profile">PROFILE</button>
    <button class="tab" data-tab="players">PLAYERS</button>
    <button class="tab" data-tab="matches">MATCHES</button>
  </nav>

  <div class="main">
    <h2 id="pageTitle">ðŸ‘¥ PUBLIC TEAM PROFILE</h2>

    <!-- PROFILE TAB -->
    <section class="tab-pane" id="pane-profile">
      <div class="section">
        <h3>Team & Manager</h3>
        <div class="info-row"><span>Manager:</span><span id="mgrName">â€“</span></div>
        <div class="info-row"><span>Team:</span><span id="teamName">â€“</span></div>
        <div class="info-row"><span>Region:</span><span id="region">â€“</span></div>
        <div class="info-row"><span>League:</span><span id="leagueInfo">â€“</span></div>
        <div class="info-row"><span>Level:</span><span id="level">â€“</span></div>
        <div class="info-row"><span>XP:</span><span id="xpValue">â€“</span></div>
        <div class="progress-bar"><div id="xpBar" class="progress-fill"></div></div>
      </div>

      <div class="section">
        <h3>Team Ratings</h3>
        <div class="ratings">
          <div class="rating-card">
            <img src="assets/rating/ovr.png" alt="OVR"/>
            <div><div class="rating-value" id="ovrValue">â€“</div><div class="rating-label">Overall</div></div>
          </div>
          <div class="rating-card">
            <img src="assets/rating/bat.png" alt="Bat"/>
            <div><div class="rating-value" id="batValue">â€“</div><div class="rating-label">Batting</div></div>
          </div>
          <div class="rating-card">
            <img src="assets/rating/ball.png" alt="Ball"/>
            <div><div class="rating-value" id="ballValue">â€“</div><div class="rating-label">Bowling</div></div>
          </div>
          <div class="rating-card">
            <img src="assets/rating/wk.png" alt="WK"/>
            <div><div class="rating-value" id="wkValue">â€“</div><div class="rating-label">Wicketkeeping</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PLAYERS TAB (public-safe fields only) -->
    <section class="tab-pane" id="pane-players" style="display:none">
      <div class="section">
        <h3>Players</h3>
        <div class="muted" style="margin-bottom:8px">Public view: skill ratings are hidden.</div>
        <div class="table-wrap">
          <table class="table" id="playersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th class="hide-sm">Age</th>
                <th>Region</th>
                <th>Role</th>
                <th class="hide-sm">Form</th>
                <th>XP</th>
                <th>Fitness</th>
                <th>Skill 1</th>
                <th>Skill 2</th>
                <th class="hide-sm">Bat Style</th>
                <th class="hide-sm">Bowl Style</th>
                <th>Salary</th>
                <th>Market Value</th>
              </tr>
            </thead>
            <tbody id="playersBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MATCHES TAB -->
    <section class="tab-pane" id="pane-matches" style="display:none">
      <div class="section">
        <h3>League Matches</h3>
        <div class="list" id="leagueList"></div>
      </div>
      <div class="section">
        <h3>Friendlies</h3>
        <div class="list" id="friendlyList"></div>
      </div>
    </section>
  </div>

  <script type="module">
    import { loadSharedUI } from './js/shared-ui.js';
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    // ---- UI helpers
    const qs = (s, el=document)=> el.querySelector(s);
    const qsa = (s, el=document)=> [...el.querySelectorAll(s)];
    const toNum = (v) => (v == null ? 0 : Number(v));

    // Tabs
    qsa('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        qsa('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const name = btn.dataset.tab;
        qsa('.tab-pane').forEach(p=> p.style.display = (p.id === `pane-${name}`) ? '' : 'none');
      });
    });

    // Ratings helpers
    function pickByLineupOrAuto(allPlayers, lineup) {
      const byId = new Map(allPlayers.map(p => [p.id, p]));
      let xi = [];
      if (lineup && Array.isArray(lineup.playing_xi) && lineup.playing_xi.length) {
        xi = lineup.playing_xi.map(id => byId.get(id)).filter(Boolean);
      } else {
        const sorted = [...allPlayers].sort((a,b)=>
          (toNum(b.batting)+toNum(b.bowling)+toNum(b.keeping)) -
          (toNum(a.batting)+toNum(a.bowling)+toNum(a.keeping))
        );
        xi = sorted.slice(0, Math.min(11, sorted.length));
      }
      const sortBy = (arr,key)=> [...arr].sort((a,b)=> toNum(b[key])-toNum(a[key]));
      let wk = null;
      if (lineup && lineup.keeper) wk = byId.get(lineup.keeper) || null;
      if (!wk) wk = sortBy(xi.length?xi:allPlayers,'keeping')[0]||null;
      const poolForAR = (xi.length?xi:allPlayers).filter(p => !wk || p.id !== wk.id);
      let ar = null;
      if (poolForAR.length) {
        ar = [...poolForAR].sort((a,b)=> (toNum(b.batting)+toNum(b.bowling)) - (toNum(a.batting)+toNum(a.bowling)))[0];
      }
      const batters = sortBy(xi.length?xi:allPlayers,'batting').filter(p=> !wk || p.id!==wk.id).slice(0,4);
      const bowlers = sortBy(xi.length?xi:allPlayers,'bowling').filter(p=> (!wk || p.id!==wk.id) && (!ar || p.id!==ar.id)).slice(0,5);
      return { xi, wk, ar, batters, bowlers };
    }
    function computeRatings({ xi, wk, ar, batters, bowlers }) {
      const toN = toNum;
      const batSum = batters.reduce((s,p)=> s+toN(p.batting),0) + (wk?toN(wk.batting):0) + (ar?toN(ar.batting):0);
      const batAvg = (batters.length + (wk?1:0) + (ar?1:0)) ? (batSum/6) : 0;
      const ballSum = bowlers.reduce((s,p)=> s+toN(p.bowling),0) + (ar?toN(ar.bowling):0);
      const ballAvg = (bowlers.length + (ar?1:0)) ? (ballSum/6) : 0;
      const wkVal = wk ? toN(wk.keeping) : 0;
      return { bat:batAvg, ball:ballAvg, wk:wkVal, ovr:(batAvg+ballAvg+wkVal)/3 };
    }
    const round1 = (x)=> (Math.round(x*10)/10).toFixed(1);
    function getManagerLevel(xp) {
      if (xp >= 13500) return "The Boss";
      if (xp >= 8500) return "Ultimate";
      if (xp >= 5500) return "World Class";
      if (xp >= 3500) return "Supreme";
      if (xp >= 1750) return "Master";
      if (xp >= 750) return "Professional";
      if (xp >= 250) return "Expert";
      return "Beginner";
    }

    async function main() {
      // 1) Mount the shared top bar with the VIEWER's info
      const { data: { user: viewer } } = await supabase.auth.getUser().catch(()=>({data:{user:null}}));
      if (viewer) {
        try {
          const { data: myProfile } = await supabase
            .from('profiles')
            .select('manager_name,xp,coins,cash')
            .eq('user_id', viewer.id)
            .maybeSingle();

          // Mount the topbar/bottom-nav
          await loadSharedUI({
            supabase,
            manager_name: myProfile?.manager_name ?? 'Manager',
            xp: myProfile?.xp ?? 0,
            coins: myProfile?.coins ?? 0,
            cash: myProfile?.cash ?? 0,
            user_id: viewer.id
          });
        } catch (e) {
          // Even if this fails, rest of page works
          console.warn('Topbar load skipped:', e?.message || e);
        }
      }

      // 2) Resolve which TEAM to show (URL ?team=â€¦ or viewerâ€™s team)
      const urlTeamId = new URLSearchParams(location.search).get('team');
      let team = null;

      if (urlTeamId) {
        const { data: t } = await supabase.from('teams').select('*').eq('id', urlTeamId).single();
        team = t;
      } else if (viewer) {
        const { data: t } = await supabase.from('teams').select('*').eq('owner_id', viewer.id).single();
        team = t;
      }
      if (!team) {
        document.querySelector('.main').innerHTML =
          `<div class="section"><h3>Team not found</h3><p class="muted">Provide ?team=&lt;TEAM_ID&gt; in the URL.</p></div>`;
        return;
      }

      // 3) Load profile by team_id (public being viewed)
      const { data: profile } = await supabase.from('profiles').select('*').eq('team_id', team.id).maybeSingle();

      // League info (optional)
      let leagueName = "â€”";
      if (team.league_id) {
        const { data: league } = await supabase.from('leagues').select('name,tier').eq('id', team.league_id).single();
        if (league) leagueName = `${league.name} (${league.tier})`;
      } else if (team.tier) {
        leagueName = team.tier;
      }

      // Players (hidden skills in UI)
      const { data: players } = await supabase
        .from('players')
        .select('id,name,role,form,experience,fitness,age_years,region,skill1,skill2,batting_style,bowling_style,salary,market_price,batting,bowling,keeping')
        .eq('team_id', team.id);

      // Lineup (if exists)
      const { data: lineup } = await supabase
        .from('lineups')
        .select('playing_xi,keeper,captain,team_id')
        .eq('team_id', team.id)
        .maybeSingle();

      // PROFILE tab fill
      document.getElementById('pageTitle').textContent = 'ðŸ‘¥ PUBLIC TEAM PROFILE';
      document.getElementById('mgrName').textContent = profile?.manager_name ?? team.manager_name ?? 'â€“';
      document.getElementById('teamName').textContent = profile?.team_name ?? team.team_name ?? 'â€“';
      document.getElementById('region').textContent = profile?.region ?? team.region ?? 'â€“';
      document.getElementById('leagueInfo').textContent = leagueName;

      const xp = profile?.xp ?? 0;
      document.getElementById('level').textContent = getManagerLevel(xp);
      document.getElementById('xpValue').textContent = `${xp} XP`;

      const levels = { Beginner:0, Expert:250, Professional:750, Master:1750, Supreme:3500, "World Class":5500, Ultimate:8500, "The Boss":13500 };
      const nextLvlXP = Object.values(levels).find(x => x > xp) ?? 13500;
      const prevLvlXP = [...Object.values(levels)].reverse().find(x => x <= xp) ?? 0;
      const pct = Math.max(0, Math.min(100, Math.round(((xp - prevLvlXP)/(nextLvlXP - prevLvlXP))*100)));
      document.getElementById('xpBar').style.width = pct + '%';

      // Ratings
      const selection = pickByLineupOrAuto(players||[], lineup||null);
      const r = computeRatings(selection);
      document.getElementById('ovrValue').textContent  = round1(r.ovr);
      document.getElementById('batValue').textContent  = round1(r.bat);
      document.getElementById('ballValue').textContent = round1(r.ball);
      document.getElementById('wkValue').textContent   = round1(r.wk);

      // PLAYERS table (public-safe)
      const tbody = document.getElementById('playersBody');
      tbody.innerHTML = '';
      (players||[]).forEach(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}</td>
          <td class="hide-sm">${(p.age_years ?? 'â€“')}</td>
          <td>${(p.region ?? 'â€“')}</td>
          <td><span class="chip">${(p.role || (p.is_wk?'WK':'')) ?? 'â€“'}</span></td>
          <td class="hide-sm">${(p.form ?? 'â€“')}</td>
          <td>${(p.experience ?? 'â€“')}</td>
          <td>${(p.fitness ?? 'â€“')}</td>
          <td>${(p.skill1 ?? 'â€“')}</td>
          <td>${(p.skill2 ?? 'â€“')}</td>
          <td class="hide-sm">${(p.batting_style ?? 'â€“')}</td>
          <td class="hide-sm">${(p.bowling_style ?? 'â€“')}</td>
          <td>â‚¹${(p.salary ?? 'â€“')}</td>
          <td>â‚¹${(p.market_price ?? 'â€“')}</td>
        `;
        tbody.appendChild(tr);
      });

      // MATCHES (League fixtures & Friendlies)
      const teamId = team.id;

      const { data: fixtures } = await supabase
        .from('fixtures')
        .select('id,date,start_time,home_team_id,away_team_id,winner_team_id,status')
        .or(`home_team_id.eq.${teamId},away_team_id.eq.${teamId}`)
        .order('date', { ascending:false })
        .limit(20);

      const { data: friendlies } = await supabase
        .from('matches')
        .select('id,date,start_time,home_team_id,away_team_id,winner_team_id,status')
        .or(`home_team_id.eq.${teamId},away_team_id.eq.${teamId}`)
        .order('date', { ascending:false })
        .limit(20);

      const teamNameCache = new Map([[team.id, team.team_name]]);
      async function nameOf(id){
        if (!id) return 'â€”';
        if (teamNameCache.has(id)) return teamNameCache.get(id);
        const { data: t } = await supabase.from('teams').select('team_name').eq('id', id).single();
        const n = t?.team_name ?? 'â€”';
        teamNameCache.set(id, n); return n;
      }

      async function renderMatchList(list, targetEl, type){
        targetEl.innerHTML = '';
        for (const m of (list||[])) {
          const ht = await nameOf(m.home_team_id);
          const at = await nameOf(m.away_team_id);
          const isDone = !!m.winner_team_id || m.status === 'finished' || m.status === 'completed';
          const status = isDone ? 'Completed' : 'Scheduled';
          const card = document.createElement('div');
          card.className = 'match-card';
          card.innerHTML = `
            <div>
              <div>
                <strong><a class="team-link" href="public-profile.html?team=${m.home_team_id}">${ht}</a></strong>
                &nbsp;vs&nbsp;
                <strong><a class="team-link" href="public-profile.html?team=${m.away_team_id}">${at}</a></strong>
              </div>
              <div class="muted">${m.date} â€¢ ${m.start_time} â€¢ ${type === 'league' ? 'League' : 'Friendly'} â€¢ ${status}</div>
            </div>
            <div>
              <a class="btn" href="public_matchscore.html?type=${type}&id=${m.id}">View Scoreboard</a>
            </div>
          `;
          targetEl.appendChild(card);
        }
      }

      await renderMatchList(fixtures, document.getElementById('leagueList'), 'league');
      await renderMatchList(friendlies, document.getElementById('friendlyList'), 'friendly');
    }

    main();
  </script>
</body>
</html>
