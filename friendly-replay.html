<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendly Replay ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    .badge-friendly{background:#1b4332;color:#d1fae5;border-color:#24543f}
    .chip-done{background:#334155;color:#e2e8f0;border:1px solid #3b475f;border-radius:6px;padding:4px 10px;font-size:.75rem}
    .muted{opacity:.75}
    .tabs{display:flex;gap:6px;border-bottom:2px solid #1d263a;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}
    .panel{display:none}
    .panel.show{display:block}
    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:12px;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center;vertical-align:top}
    th{background:#192238}
    td.left{text-align:left}
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.05rem;display:flex;gap:12px;align-items:center}
    .feed{display:flex;flex-direction:column;gap:8px}
    .ball{padding:12px;border:1px dashed #26314b;border-radius:10px;background:#0f1522}
    .ball .head{font-weight:700;margin-bottom:6px}
    .tag{font-size:.7rem;border-radius:6px;padding:2px 8px;border:1px solid #334155;background:#152035;margin-left:8px}
    .wkt{background:#3a0e14;border-color:#521b24;color:#ffd6d6}
    .b4{background:#123d27;border-color:#1c593a;color:#b8ffd6}
    .b6{background:#0e2e57;border-color:#1a4886;color:#cfe8ff}
    .sub{opacity:.9;margin-top:4px}
    .skillbar{display:flex;gap:2px;margin-top:4px}
    .skillbar .seg{width:6px;height:10px;border-radius:2px;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
    .namecell{display:flex;flex-direction:column;align-items:flex-start;gap:2px}
    .nm{line-height:1.1}
    .toss-line .toss-banner{background:#222a68;color:#fff;text-align:center;font-weight:bold;padding:10px;margin:8px 0;border-radius:6px;font-size:16px;letter-spacing:.5px}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <div class="wrap">
    <div class="head">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge badge-friendly">Friendly</span>
        <span id="replay-date" class="muted">--</span>
      </div>
      <span class="chip-done">Completed</span>
    </div>

    <h2 id="match-title">Home vs Away</h2>
    <div class="muted" id="match-sub">Kickoff ‚Äî --</div>

    <div class="tabs" style="margin-top:12px">
      <button id="tab-replay">REPLAY</button>
      <button id="tab-score" class="active">SCORECARD</button>
      <button id="tab-summary">SUMMARY</button>
    </div>

    <!-- REPLAY -->
    <section id="replay-panel" class="panel">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btn-play">‚ñ∂ Play</button>
          <button id="btn-pause" disabled>‚è∏ Pause</button>
          <button id="btn-next">‚è© Next ball</button>
          <button id="btn-skip-over">‚è≠ Next over</button>
          <button id="btn-restart">üîÅ Restart</button>
          <div style="flex:1"></div>
          <label>Speed
            <select id="speed">
              <option value="1200">Slow</option>
              <option value="700" selected>Normal</option>
              <option value="350">Fast</option>
            </select>
          </label>
        </div>
      </div>

      <!-- toss banner placeholder for REPLAY -->
      <div id="toss-banner-inline"></div>

      <!-- Mini score strip (always visible on REPLAY tab) -->
      <div class="score-strip">
        <div class="big" id="mini-a"><span id="mini-a-name">Team A</span> <span id="mini-a-score">0/0 - 0.0 ov</span></div>
        <div class="big" id="mini-b"><span id="mini-b-name">Team B</span> <span id="mini-b-score">0/0 - 0.0 ov</span></div>
      </div>

      <div class="card">
        <div id="comm-feed" class="feed"></div>
      </div>
    </section>

    <!-- SCORECARD (final) -->
    <!-- toss banner placeholder for SCORECARD (we will render here as well) -->
    <div id="toss-banner-score"></div>

    <section id="score-panel" class="panel show">
      <div class="card">
        <div id="headline-a" style="font-weight:800;font-size:1.05rem;">‚Äî</div>
        <div id="headline-b" style="font-weight:800;font-size:1.05rem;margin-top:6px;">‚Äî</div>
      </div>

      <div id="sc-in1" class="card">
        <h3 id="in1-name">Innings 1</h3>
        <div class="muted" id="in1-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat1"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl1"></tbody>
        </table>
      </div>

      <div id="sc-in2" class="card">
        <h3 id="in2-name">Innings 2</h3>
        <div class="muted" id="in2-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat2"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl2"></tbody>
        </table>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary-panel" class="panel">
      <div class="card">
        <h3>Match Summary</h3>
        <div id="result-line" style="margin:6px 0 12px 0;font-weight:700"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-home-name" class="muted">Home</div>
            <div id="sum-home-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-home-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-home-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-away-name" class="muted">Away</div>
            <div id="sum-away-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-away-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-away-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    loadSmoothUI("top-bar","bottom-nav");
  </script>

  <!-- Replay Logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ---------- Helpers & State ---------- */
    const qs = new URLSearchParams(location.search);
    const matchId = qs.get("id");

    // Use the same project URL + key you use elsewhere
    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE",
      { global: { headers: { "x-match-id": matchId ?? "" } } }
    );

    /* Tabs */
    const tabs = {
      replay: document.getElementById("tab-replay"),
      score: document.getElementById("tab-score"),
      summary: document.getElementById("tab-summary")
    };
    const panels = {
      replay: document.getElementById("replay-panel"),
      score: document.getElementById("score-panel"),
      summary: document.getElementById("summary-panel")
    };
    const activate = (k) => {
      ["replay","score","summary"].forEach(t=>{
        tabs[t].classList.toggle("active", t===k);
        panels[t].classList.toggle("show", t===k);
      });
    };
    activate("score");
    tabs.replay.onclick = ()=> activate("replay");
    tabs.score.onclick = ()=> activate("score");
    tabs.summary.onclick = ()=> activate("summary");

    /* Element refs */
    const titleEl = document.getElementById("match-title");
    const subEl   = document.getElementById("match-sub");
    const replayDate = document.getElementById("replay-date");
    const headlineA = document.getElementById("headline-a");
    const headlineB = document.getElementById("headline-b");
    const in1Name = document.getElementById("in1-name");
    const in2Name = document.getElementById("in2-name");
    const in1Tot  = document.getElementById("in1-total");
    const in2Tot  = document.getElementById("in2-total");
    const bat1 = document.getElementById("bat1");
    const bat2 = document.getElementById("bat2");
    const bowl1 = document.getElementById("bowl1");
    const bowl2 = document.getElementById("bowl2");
    const miniAName = document.getElementById("mini-a-name");
    const miniAScore = document.getElementById("mini-a-score");
    const miniBName = document.getElementById("mini-b-name");
    const miniBScore = document.getElementById("mini-b-score");
    const commFeed = document.getElementById("comm-feed");
    const tossBannerContainer = document.getElementById("toss-banner-inline");
    const tossBannerScoreContainer = document.getElementById("toss-banner-score");

    const resLine = document.getElementById("result-line");
    const sumHomeName = document.getElementById("sum-home-name");
    const sumHomeScore = document.getElementById("sum-home-score");
    const sumAwayName = document.getElementById("sum-away-name");
    const sumAwayScore = document.getElementById("sum-away-score");
    const sumHomeTopBat = document.getElementById("sum-home-topbat");
    const sumHomeTopBowl = document.getElementById("sum-home-topbowl");
    const sumAwayTopBat = document.getElementById("sum-away-topbat");
    const sumAwayTopBowl = document.getElementById("sum-away-topbowl");

    /* State */
    const roles = {};
    let players = {};
    let names = {};
    let match = null;
    let allBalls = [];
    let shown = 0;
    let timer = null;
    let delay = 700;
    const liveBatRuns = new Map();

    /* Skill helpers (same palette/logic as other pages) */
    const PALETTE = ["#f8f532","#f3e61c","#e9d60e","#d4cf10","#b0d022","#7ec14a","#49a769","#2f9ea6","#1d78c6","#1850a1","#1a2f7a","#5d2f7a","#a9483c","#cc1f1f"];
    function shortName(full){
      if(!full) return "‚Äî";
      const parts = String(full).trim().split(/\s+/).filter(Boolean);
      if(parts.length === 1) return parts[0];
      const last = parts.pop();
      const initials = parts.map(w => (w[0]||'').toUpperCase()).filter(Boolean).join(' ');
      return `${initials} ${last}`;
    }
    function boostMap(){ return (match?.sim_state?.player_boosts) || (match?.sim_state?.boosts) || {}; }
    function skillScore(pid, kind){
      const p = players[pid] || {};
      const base = kind === "bat" ? Number(p.batting)||0 : kind === "bowl" ? Number(p.bowling)||0 : Math.max(Number(p.batting)||0, Number(p.bowling)||0);
      const b = Number(boostMap()[pid]) || 0;
      return Math.max(0, base + b);
    }
    function segmentsFor(score){
      const maxScore = 100;
      const frac = Math.max(0, Math.min(1, score/maxScore));
      let n = Math.round(frac * PALETTE.length);
      return Math.max(1, Math.min(PALETTE.length, n));
    }
    function colorBarHTML(pid, kind){
      const segs = segmentsFor(skillScore(pid, kind));
      const blocks = PALETTE.slice(0,segs).map(c=>`<span class="seg" style="background:${c}"></span>`).join("");
      return `<div class="skillbar" title="Skill+Boost: ${skillScore(pid,kind).toFixed(1)}">${blocks}</div>`;
    }
    function nameWithBadges(pid){
      if(!pid) return "‚Äî";
      const p = players[pid];
      if(!p) return `Player ${String(pid).slice(0,8)}`;
      const r = roles[p.team_id] || {};
      const tags = [];
      if (r.captain === pid) tags.push("C");
      if (r.keeper === pid) tags.push("WK");
      const nm = shortName(p.name);
      return `${nm}${tags.length?` (${tags.join(", ")})`:''}`;
    }
    function nameCell(pid, kind){
      return `<div class="namecell"><div class="nm">${nameWithBadges(pid)}</div>${colorBarHTML(pid, kind)}</div>`;
    }

    /* Utilities (totals, agg) */
    const isLegal = (b) => { const t = (b.delivery_type||"legal").toLowerCase(); return t !== "wide" && t !== "noball" && t !== "toss"; };
    function oversTxt(balls){ return `${Math.floor(balls/6)}.${balls%6}`; }
    function overLabel(ball){ return `${ball.over_number - 1}.${ball.ball_in_over}`; }
    function totals(list, inn){
      const arr = list.filter(b => b.innings === inn);
      const legal = arr.filter(isLegal).length;
      return {
        runs: arr.reduce((s,b)=> s + (b.runs_scored||0) + (b.extras||0), 0),
        wkts: arr.reduce((s,b)=> s + (b.wicket?1:0), 0),
        legal
      };
    }
    function aggBat(list, inn){
      const map = {};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id = b.striker_id; if(!id) return;
        const m = map[id] ||= {r:0,b:0,f:0,s:0};
        m.r += b.runs_scored||0;
        if(isLegal(b)){ m.b++; if (b.runs_scored===4) m.f++; if (b.runs_scored===6) m.s++; }
      });
      return map;
    }
    function aggBowl(list, inn){
      const map = {};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id = b.bowler_id; if(!id) return;
        const m = map[id] ||= {r:0,b:0,w:0};
        m.r += (b.runs_scored||0) + (b.extras||0);
        if (isLegal(b)) m.b++;
        const t = (b.dismissal_type||"").toLowerCase();
        if (b.wicket && t !== "runout" && t !== "run-out") m.w++;
      });
      return map;
    }
    function dismissalMap(list, inn){
      const map = {};
      list.filter(b=>b.innings===inn && b.wicket && b.dismissed_batsman_id).forEach(b=>{
        map[b.dismissed_batsman_id] = { type:(b.dismissal_type||"").toLowerCase(), bowler:b.bowler_id||null, fielder:b.fielder_id||null };
      });
      return map;
    }

    /* ===== Toss helpers (copied & normalized) ===== */
    function normalizeTossFromPayload(matchRow){
      if(!matchRow) return null;
      let resultObj = null, simObj = null;
      try { resultObj = typeof matchRow.result === 'string' ? JSON.parse(matchRow.result) : matchRow.result; } catch(e){ resultObj = null; }
      try { simObj = typeof matchRow.sim_state === 'string' ? JSON.parse(matchRow.sim_state) : matchRow.sim_state; } catch(e){ simObj = null; }

      if (matchRow.toss_winner_team_id || matchRow.toss_decision) {
        return { winner_team_id: matchRow.toss_winner_team_id || null, decision: matchRow.toss_decision || null, text: null };
      }
      if (matchRow.toss) {
        return { winner_team_id: matchRow.toss.winner_team_id || matchRow.toss.winner || null, decision: matchRow.toss.decision || matchRow.toss.elected || null, text: matchRow.toss.text || null };
      }
      if (resultObj && resultObj.toss) {
        const t = resultObj.toss;
        return { winner_team_id: t.winner_team_id || t.winner || null, decision: t.decision || t.elected || null, text: t.text || null };
      }
      if (simObj && simObj.toss) {
        const t = simObj.toss;
        return { winner_team_id: t.winner_team_id || t.winner || null, decision: t.decision || t.elected || null, text: t.text || null };
      }
      return null;
    }

    function renderTossBanner(matchRow, commentaryList){
      const normalized = normalizeTossFromPayload(matchRow);
      // prefer an explicit toss commentary row if present
      const cbToss = (commentaryList||[]).find(c => (c.delivery_type||'').toLowerCase() === 'toss' && (c.commentary||'').trim());
      let text = null;
      if (cbToss && cbToss.commentary && !/^toss not available$/i.test(String(cbToss.commentary).trim())) {
        text = cbToss.commentary;
      } else if (normalized && normalized.winner_team_id) {
        const winnerId = String(normalized.winner_team_id);
        const winnerName = names[winnerId] || matchRow?.home_team_name || matchRow?.away_team_name || winnerId;
        const decisionText = (normalized.decision||'').toLowerCase() === 'bowl' || (normalized.decision||'').toLowerCase() === 'field' ? 'bowl first' : 'bat first';
        text = `üé≤ ${winnerName} won the toss and chose to ${decisionText}.`;
      } else if (normalized && normalized.text) {
        text = normalized.text;
        if (!/üé≤/.test(text)) text = `üé≤ ${text}`;
      } else {
        text = null;
      }

      if (!text) {
        if (tossBannerContainer) tossBannerContainer.innerHTML = "";
        if (tossBannerScoreContainer) tossBannerScoreContainer.innerHTML = "";
        return;
      }
      const bannerHtml = `<div class="toss-line"><div class="toss-banner">${text}</div></div>`;
      if (tossBannerContainer) tossBannerContainer.innerHTML = bannerHtml;
      if (tossBannerScoreContainer) tossBannerScoreContainer.innerHTML = bannerHtml;
    }

    function ensureTossInCommentary(matchRow, commentaryArray){
      if (!Array.isArray(commentaryArray)) commentaryArray = [];
      if (commentaryArray.some(c => (c.delivery_type||'').toLowerCase() === 'toss')) return commentaryArray;
      const normalized = normalizeTossFromPayload(matchRow);
      let text = 'Toss not available';
      if (normalized && normalized.winner_team_id) {
        const friendly = names[String(normalized.winner_team_id)] || `Team ${String(normalized.winner_team_id).slice(0,8)}`;
        text = `Toss: ${friendly} won the toss and elected to ${normalized.decision || 'bat'}.`;
      } else if (matchRow?.result?.toss?.text) {
        text = matchRow.result.toss.text;
      } else if (matchRow?.sim_state?.toss?.text) {
        text = matchRow.sim_state.toss.text;
      }
      const tossRow = {
        match_id: matchRow?.id,
        over_number: 0,
        ball_in_over: 0,
        innings: 0,
        striker_id: null,
        non_striker_id: null,
        bowler_id: null,
        runs_scored: 0,
        extras: 0,
        wicket: false,
        dismissed_batsman_id: null,
        commentary: text,
        created_at: new Date(Date.now() - 1000).toISOString(),
        fielder_id: null,
        delivery_type: 'toss',
        extras_detail: {}
      };
      return [tossRow, ...commentaryArray];
    }

    function filterInitialNoisyLines(commentaryArray){
      if (!Array.isArray(commentaryArray)) return commentaryArray;
      const noiseRegex = /\bcomes into the attack\b/i;
      const firstRealIdx = commentaryArray.findIndex(c => {
        const dt = (c.delivery_type || '').toLowerCase();
        if (dt === 'toss') return false;
        if (['legal','wide','noball','bye'].includes(dt)) return true;
        if (typeof c.over_number === 'number' && c.over_number > 0) return true;
        return false;
      });
      const cutoff = firstRealIdx === -1 ? 3 : firstRealIdx + 1;
      return commentaryArray.filter((c,i) => {
        if (i < cutoff && typeof c.commentary === 'string' && noiseRegex.test(c.commentary)) return false;
        return true;
      });
    }

    /* Rendering helper functions */
    function rowBat(tbody, map, dm){
      tbody.innerHTML = "";
      Object.entries(map).forEach(([pid,st])=>{
        const nmCell = nameCell(pid, "bat");
        const sr = st.b ? ((st.r/st.b)*100).toFixed(1) : "0.0";
        const d = dm[pid];
        let dis = "not out";
        if (d) {
          const bow = nameWithBadges(d.bowler); const fld = nameWithBadges(d.fielder);
          if (d.type==="bowled") dis = `b ${bow}`;
          else if (d.type==="lbw") dis = `lbw b ${bow}`;
          else if (d.type==="caught"){
            if (d.fielder && d.bowler && d.fielder===d.bowler) dis = `c & b ${bow}`;
            else if (d.fielder) dis = `c ${fld} b ${bow}`;
            else dis = `c b ${bow}`;
          } else if (d.type==="runout"||d.type==="run-out") dis = d.fielder ? `run out (${nameWithBadges(d.fielder)})` : "run out";
          else dis = bow ? `b ${bow}` : "out";
        }
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nmCell}</td><td class="left">${dis}</td><td>${st.r}</td><td>${st.b}</td><td>${st.f}</td><td>${st.s}</td><td>${sr}</td></tr>`);
      });
    }

    function rowBowl(tbody, map){
      tbody.innerHTML = "";
      Object.entries(map).forEach(([pid,st])=>{
        const nmCell = nameCell(pid, "bowl");
        const ov = `${Math.floor(st.b/6)}.${st.b%6}`;
        const eco = st.b ? (st.r/(st.b/6)).toFixed(1) : "0.0";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nmCell}</td><td>${ov}</td><td>${st.r}</td><td>${st.w}</td><td>${eco}</td></tr>`);
      });
    }

    function randomLine(b){
      const c = (b.commentary||"").trim();
      if (c && !/^runs?\s*:/i.test(c) && !/^out!?$/i.test(c)) return c;
      if (b.wicket) {
        const arr = ["Gone! Big breakthrough.","Edged and taken!","Bowled him!"];
        return arr[Math.floor(Math.random()*arr.length)];
      }
      const pool = {0:["Dot ball.","Beaten!","Good length ‚Äî no run.","Wide Yorker!!! Batsman is just a spectator here, no runs","Well directed Bouncer, No Runs","Batsman tries for a Big Hit, but misses. no runs","Swings and misses, no runs","A dot ball to start the over, and the pressure's on!",
"The bowler's coming into the game, one dot ball at a time!",
"No runs, but the fielding's been superb!",
"The batsman's struggling to find the gaps, dot ball after dot ball!",
"A crucial dot ball to stem the flow of runs!",
"The bowler's tightening up, and the dot balls are piling up!",
"No runs off this delivery, and the batsman's getting frustrated!",
"The dot ball's giving the bowlers a chance to regroup!",
"A well-executed dot ball, and the pressure's building!",
"The batsman's finding it tough to score, dot ball after dot ball!",
"The bowler's getting into a rhythm, and the dot balls are flowing!",
"A dot ball to end the over, and the bowlers are celebrating!",
"No runs, but the excitement's building!",
"The dot ball's a crucial part of the game, and the bowler's executing it well!",
"The batsman's under pressure, and the dot balls are adding to it!",
"A well-bowled dot ball, and the bowlers are on top!",
"The fielding's been top-notch, and the dot balls are a testament to it!",
"A dot ball to start the day, and the bowlers are looking sharp!",
"No runs off this delivery, and the batsman's getting anxious!",
"The bowler's using the field well, and the dot balls are coming!",
"A crucial dot ball to slow down the run rate!",
"The batsman's struggling to find the gaps, and the dot balls are piling up!",
"A well-executed dot ball, and the bowlers are gaining confidence!",
"The dot ball's a vital part of the game, and the bowler's mastering it!",
"No runs, but the tension's building!",
"The bowler's getting into a groove, and the dot balls are flowing!",
"A dot ball to end the over, and the bowlers are smiling!",
"The batsman's under pressure, and the dot balls are adding to it!",
"A well-bowled dot ball, and the bowlers are in control!",
"The fielding's been superb, and the dot balls are a bonus!",
"A dot ball to start the over, and the bowlers are looking sharp!",
"No runs off this delivery, and the batsman's getting frustrated!",
"The bowler's using the field well, and the dot balls are coming!",
"A crucial dot ball to stem the flow of runs!",
"The batsman's finding it tough to score, dot ball after dot ball!",
"The bowler's getting into a rhythm, and the dot balls are piling up!",
"A dot ball to end the day, and the bowlers are looking good!",
"No runs, but the excitement's building for the next delivery!",
"The dot ball's a crucial part of the game, and the bowler's executing it well!",
"The batsman's under pressure, and the dot balls are adding to it!",
"A well-bowled dot ball, and the bowlers are on top of the game!",
"The fielding's been top-notch, and the dot balls are a testament to it!",
"A dot ball to start the match, and the bowlers are looking sharp!",
"No runs off this delivery, and the batsman's getting anxious!",
"The bowler's using the field well, and the dot balls are coming!",
"A crucial dot ball to slow down the run rate!",
"The batsman's struggling to find the gaps, and the dot balls are piling up!",
"A well-executed dot ball, and the bowlers are gaining confidence!",
"The dot ball's a vital part of the game, and the bowler's mastering it!"],1:["Just a single.","Nudged for one.","Oh Oh, What a save, saved 3 runs for his team. Good effort from the fielder.","A single to start the proceedings!",
"He's off the mark, and the runs are on their way!",
"There is a chance for runout, safely taken, quick single",
"The gears are shifting, and the runs are flowing!",
"A single to get the batsman going!",
"The partnership's building, one single at a time!",
"A gentle single, but the momentum's building!",
"He's finding his feet, and the singles are coming!",
"A single to get the scoreboard ticking!",
"The batsman's getting into his stride, one single at a time!",
"A well-placed single, and the runs are on their way!",
"The singles are adding up, and the total's growing!",
"A single to keep the scoreboard ticking!",
"The batsman's working hard, one single at a time!",
"A crucial single to keep the momentum going!",
"The partnership's in full flow, one single at a time!",
"A single to get the batsman settled!",
"The runs are trickling in, one single at a time!",
"A well-timed single, and the pressure's off!",
"The batsman's finding his rhythm, one single at a time!",
"A single to keep the scoreboard moving!",
"The singles are coming thick and fast!",
"A crucial single to rotate the strike!",
"The batsman's working the singles, and the runs are flowing!",
"A single to get the partnership going!",
"The momentum's building, one single at a time!",
"A well-placed single, and the batsman's getting into his stride!",
"The singles are adding up, and the total's looking good!",
"A single to keep the batsman going!",
"The partnership's in full swing, one single at a time!",
"A crucial single to keep the scoreboard ticking!",
"The batsman's finding his feet, and the singles are coming!",
"A single to get the runs flowing!",
"The singles are coming, and the runs are piling up!",
"A well-timed single, and the pressure's off the batsman!",
"The batsman's working hard, one single at a time!",
"A single to keep the momentum going!",
"The partnership's building, one single at a time!",
"A crucial single to rotate the strike!",
"The batsman's finding his rhythm, and the singles are flowing!",
"A single to get the scoreboard moving!",
"The singles are adding up, and the total's looking good!",
"A well-placed single, and the batsman's getting settled!",
"The runs are coming, one single at a time!",
"A single to keep the batsman ticking over!",
"The partnership's in full flow, and the singles are coming!",
"A crucial single to keep the pressure off!",
"The batsman's working the singles, and the runs are flowing freely!",
"A single to get the batsman going, and the momentum's building!",
"The singles are coming, and the batsman's taking control!"],2:["They come back for two.","Comfortable two.","Tried for a Big Hit, On the Air, A fielder there. Ohh My God, DROPPED. Got Two Runs.","A quick two to get the scoreboard ticking!",
"The batsman's finding his groove, and the twos are flowing!",
"A well-placed two, and the runs are coming!",
"The partnership's building, one two at a time!",
"A crucial two to keep the momentum going!",
"The batsman's working the twos, and the total's growing!",
"A sharp two, and the scoreboard's lighting up!",
"The twos are adding up, and the pressure's off!",
"A beautifully placed two, and the batsman's getting into his stride!",
"The runs are flowing, two at a time!",
"A quick two, and the batsman's taking control!",
"The partnership's in full swing, with twos aplenty!",
"A well-timed two, and the momentum's shifting!",
"The batsman's finding his rhythm, and the twos are coming!",
"A crucial two to rotate the strike!",
"The twos are coming thick and fast, and the total's looking good!",
"A sharp two, and the batsman's getting into his zone!",
"The scoreboard's ticking over, two runs at a time!",
"A well-placed two, and the pressure's off the batsman!",
"The batsman's working hard, but the twos are coming!",
"A quick two, and the partnership's building!",
"The twos are flowing, and the batsman's taking charge!",
"A crucial two to keep the scoreboard moving!",
"The batsman's finding his feet, and the twos are coming!",
"A well-timed two, and the runs are piling up!",
"The partnership's in full flow, with twos all around!",
"A sharp two, and the batsman's on top!",
"The twos are adding up, and the total's looking impressive!",
"A beautifully placed two, and the batsman's in control!",
"The runs are coming, two at a time, and the batsman's loving it!",
"A quick two, and the momentum's shifting!",
"The batsman's working the twos, and the pressure's off!",
"A crucial two to keep the batsman going!",
"The twos are flowing, and the partnership's growing!",
"A well-placed two, and the scoreboard's lighting up!",
"The batsman's finding his rhythm, and the twos are coming thick and fast!",
"A sharp two, and the batsman's taking charge!",
"The partnership's building, one two at a time!",
"A well-timed two, and the runs are flowing freely!",
"The batsman's working hard, but the twos are paying off!",
"A quick two, and the batsman's getting into his stride!",
"The twos are adding up, and the total's looking good!",
"A crucial two to rotate the strike!",
"The batsman's finding his feet, and the twos are coming!",
"A well-placed two, and the pressure's off the batsman!",
"The runs are coming, two at a time, and the batsman's enjoying it!",
"A sharp two, and the batsman's on fire!",
"The partnership's in full swing, with twos all around!",
"A well-timed two, and the momentum's building!",
"The twos are flowing, and the batsman's in control ‚Äì what a display!"],3:["All hustle ‚Äî three!","Good running ‚Äî three.","Long chase, three taken.","Good save at the boundary line, and the batsman's taking control!",
"The partnership's building, three runs at a time!",
"A sharp three, and the scoreboard's lighting up!",
"The batsman's finding his rhythm, and the threes are flowing!",
"A well-placed three, and the runs are piling up!",
"The momentum's shifting, three runs at a time!",
"A crucial three to keep the batsman going!",
"The threes are adding up, and the total's looking impressive!",
"A beautifully placed three, and the batsman's in control!",
"The runs are coming, three at a time, and the batsman's loving it!",
"A quick three, and the partnership's growing!",
"The batsman's working the threes, and the pressure's off!",
"A well-timed three, and the batsman's taking charge!",
"The threes are flowing, and the partnership's in full swing!",
"A sharp three, and the batsman's on fire!",
"The scoreboard's ticking over, three runs at a time!",
"A crucial three to rotate the strike!",
"The batsman's finding his feet, and the threes are coming!",
"A well-placed three, and the batsman's getting into his stride!",
"The runs are flowing, three at a time, and the batsman's enjoying it!",
"A quick three, and the momentum's building!",
"The partnership's in full flow, with threes all around!",
"A sharp three, and the batsman's taking control!",
"The threes are adding up, and the total's looking good!",
"A beautifully placed three, and the batsman's dominating!",
"The batsman's working hard, but the threes are paying off!",
"A well-timed three, and the pressure's off the batsman!",
"The threes are flowing, and the partnership's growing stronger!",
"A crucial three to keep the scoreboard moving!",
"The batsman's finding his rhythm, and the threes are coming thick and fast!",
"A quick three, and the batsman's on top!",
"The partnership's building, three runs at a time, and it's looking good!",
"A sharp three, and the batsman's in the zone!",
"The runs are coming, three at a time, and the batsman's in control!",
"A well-placed three, and the batsman's taking charge!",
"The threes are flowing, and the partnership's in full swing!",
"A crucial three to rotate the strike and keep the momentum going!",
"The batsman's working the threes, and the total's looking impressive!",
"A quick three, and the scoreboard's lighting up!",
"The partnership's growing, three runs at a time, and it's looking good!",
"A sharp three, and the batsman's on fire ‚Äì what a shot!",
"The threes are adding up, and the batsman's dominating!",
"A well-placed three, and the runs are piling up!",
"The batsman's finding his feet, and the threes are coming!",
"A crucial three to keep the batsman going and the momentum building!",
"The threes are flowing, and the partnership's in full flow!",
"A quick three, and the batsman's taking control ‚Äì what a display!",
"The partnership's building, three runs at a time, and it's looking impressive!",
"A sharp three, and the batsman's in control ‚Äì the crowd's loving it!",
"The threes are flowing, and the batsman's dominating ‚Äì what a performance!"],4:["FOUR! Crunched.","Pierces the gap ‚Äî four.","Stroked away for four.","Four of the finest kind!",
"The racquet work is exquisite!",
"That's a boundary that'll get the crowd going!",
"Four runs on the board, and the momentum's building!",
"The wrist work is sublime!",
"He's finding the gaps, and the gaps are finding him!",
"That's a lovely shot! Four runs, and the crowd's loving it!",
"The timing is perfect, the placement is perfect!",
"Four more runs for the taking!",
"The batsman's in the zone, and the fours are flowing!",
"What a beautiful shot! Four runs, and the stadium's buzzing!",
"He's got the shots all around the ground!",
"That's a four that'll get the fans on their feet!",
"The elegance, the poise, the four!",
"Four runs, and the pressure's off!",
"The batsman's got the rhythm, and the fours are coming!",
"That's a shot that's got the whole stadium talking!",
"Four more runs, and the game's heating up!",
"The footwork, the balance, the four!",
"He's finding the gaps, and the runs are flowing!",
"That's a four that'll give him confidence!",
"The timing is impeccable, the shot's exquisite!",
"Four runs, and the batsman's getting into his stride!",
"The crowd's loving it, and so are we!",
"That's a lovely shot! Four runs, and the game's on!",
"He's got the class, he's got the style, and he's got the four!",
"Four more runs, and the momentum's shifting!",
"The batsman's in control, and the fours are coming thick and fast!",
"That's a shot that's worth a thousand words!",
"Four runs, and the stadium's erupting!",
"The elegance, the precision, the four!",
"He's finding the gaps, and the runs are piling up!",
"That's a four that'll give him momentum!",
"The timing is perfect, the shot's perfect!",
"Four runs, and the batsman's getting into his groove!",
"The crowd's on its feet, and so are we!",
"That's a lovely shot! Four runs, and the game's heating up!",
"He's got the shots all around the park!",
"Four more runs, and the pressure's building on the opposition!",
"The batsman's got the rhythm, and the fours are flowing freely!",
"That's a shot that's got the whole nation talking!",
"Four runs, and the game's reaching a boiling point!",
"The footwork, the balance, the four ‚Äì it's all coming together!",
"He's finding the gaps, and the runs are coming easily!",
"That's a four that'll give him a lot of confidence!",
"The timing is sublime, the shot's magnificent!",
"Four runs, and the batsman's taking control!",
"The crowd's loving every bit of it!",
"That's a lovely shot! Four runs, and the game's on fire!",
"He's got the class, he's got the style, and he's got the four ‚Äì what a player!"],6:["SIX! Launched.","Into the stands ‚Äî six!","Its on the air, Gone... Gone... Gone Over the Ropes. Its a SIX!","OH MY WORD, WHAT A SHOT!",
"What a shot, its a Big one, covered distance of 90M!",
"That'll do nicely! Big hitter at work!",
"Unbelievable! The ball's gone, mate!",
"The big man's got the big hits!",
"That's a six that'll be replayed for years!",
"He's got the magic in his bat! WOW its about 100m, Biggy",
"What a clearance! That's a monster six!",
"The crowd's on its feet, and so is the roof!",
"That's a six that'll get you a contract!",
"The power! The precision! The six!",
"He's got the touch of a master!",
"That's not just a six, it's a statement!",
"The stadium's abuzz, and so is the commentary box!",
"Big hit, big cheer! That's what it's all about!",
"The ball's gone, and so are the opposition's hopes!",
"What a shot! The pure class of a big hitter!",
"That's a six that'll be remembered for a long time!",
"He's got the X-factor, and it's a big six!",
"The fireworks are on display, and it's a six!",
"That's a six that's worth a thousand words!",
"The big man's got the momentum on his side!",
"Unstoppable! That's a six that's going to change the game!",
"The crowd's going wild, and so are we!",
"That's a six that's got the whole stadium talking!",
"He's got the skill, he's got the power, and he's got the six!",
"That's not just a six, it's a work of art!",
"The ball's sailing away, and so are the opposition's chances!",
"What a clearance! That's a six that's going to win matches!",
"The energy in the stadium is electric, and it's all because of this six!",
"He's got the big hitting gene, and it's showing!",
"That's a six that's going to be talked about for years!",
"The stadium's erupting, and so are we!",
"What a shot! That's a six that's pure perfection!",
"He's got the magic wand, and it's producing sixes!",
"That's a six that's worth a million bucks!",
"Ohh No!!! Its really a Bad ball, and he gets the Punishment. Its SIX!",
"That's a six that's got the whole nation talking!",
"Unbelievable! The ball's gone out of the park!",
"The crowd's on its feet, and they're loving every bit of it!",
"He's got the power, he's got the skill, and he's got the six!",
"That's a six that's going to change the course of the game!",
"The stadium's rocking, and so is the commentary box!",
"What a clearance! That's a six that's pure awesomeness!",
"Yorker ball, but He's got the touch of a superstar, and it's producing sixes!",
"That's a six that's going to be remembered for a long, long time!",
"Its Not a bad ball, The big man's got the momentum, and it's unstoppable!",
"That's a six that's got the whole stadium in awe!",
"Unbelievable! The ball's gone, and so are the opposition's hopes!",
"What a shot! That's a six that's the stuff of legends!"]};
      const sel = pool[Math.min(6, Math.max(0, b.runs_scored||0))] || ["Runs added."];
      return sel[Math.floor(Math.random()*sel.length)];
    }

    function ballHtml(b, extraLines=[]){
      const head = `Innings ${b.innings} ‚Ä¢ Over ${overLabel(b)}`;
      const bow = nameWithBadges(b.bowler_id);
      const bat = nameWithBadges(b.striker_id);
      const tags = [];
      if (b.wicket) tags.push('<span class="tag wkt">WICKET</span>');
      if (b.runs_scored===4) tags.push('<span class="tag b4">FOUR</span>');
      if (b.runs_scored===6) tags.push('<span class="tag b6">SIX</span>');
      const line = `Runs: ${b.runs_scored||0}, ${randomLine(b)}`;
      const extras = extraLines.length ? `<div class="sub">${extraLines.join("<br/>")}</div>` : "";
      return `
        <div class="ball">
          <div class="head">${head}${tags.join('')}</div>
          <div><strong>${bow}</strong> to <strong>${bat}</strong></div>
          <div>${line}</div>
          ${extras}
        </div>`;
    }

    function updateMini(part){
      const t1 = totals(part,1), t2 = totals(part,2);
      // Show mini strip with battingFirst/battingSecond names
      const t1Name = names[battingFirst] || names[match.home_team_id] || "Team A";
      const t2Name = names[battingSecond] || names[match.away_team_id] || "Team B";
      miniAName.textContent = t1Name;
      miniAScore.textContent = `${t1.runs}/${t1.wkts} - ${oversTxt(t1.legal)} ov`;
      miniBName.textContent = t2Name;
      miniBScore.textContent = `${t2.runs}/${t2.wkts} - ${oversTxt(t2.legal)} ov`;
    }

    /* ===== State for batting order mapping (important for correct team labels) ===== */
    let battingFirst = null;
    let battingSecond = null;

    /* Control buttons */
    const btnPlay = document.getElementById("btn-play");
    const btnPause = document.getElementById("btn-pause");
    const btnNext = document.getElementById("btn-next");
    const btnOver = document.getElementById("btn-skip-over");
    const btnRestart = document.getElementById("btn-restart");
    const speedSel = document.getElementById("speed");

    function setButtons(){
      const done = shown >= allBalls.length;
      btnPlay.disabled = timer !== null || done;
      btnPause.disabled = timer === null;
      btnNext.disabled = done;
      btnOver.disabled = done;
      btnRestart.disabled = shown === 0 && !done;
    }
    function play(){ if(timer || shown >= allBalls.length) return; timer = setInterval(()=>{ if(!stepOne()) pause(); }, delay); setButtons(); }
    function pause(){ if(timer) clearInterval(timer); timer = null; setButtons(); }
    function restart(){ pause(); shown = 0; commFeed.innerHTML = ""; updateMini([]); setButtons(); liveBatRuns.clear(); }

    speedSel.onchange = ()=>{ delay = parseInt(speedSel.value,10) || 700; if(timer){ pause(); play(); } };
    btnPlay.onclick = ()=> play(); btnPause.onclick = ()=> pause();
    btnNext.onclick = ()=> { stepOne(); setButtons(); };
    btnOver.onclick = ()=> { stepOver(); setButtons(); };
    btnRestart.onclick = ()=> { restart(); };

    /* Running step (replay) */
    function stepOne(){
      if (shown >= allBalls.length) { maybeFinalMessage(); return false; }
      const b = allBalls[shown++];

      const extras = [];

      const prev = allBalls[shown-2] || null;
      const overStart = !prev || prev.innings !== b.innings || prev.over_number !== b.over_number;
      if (overStart && prev) {
        const bow = nameWithBadges(b.bowler_id);
        extras.push(`${bow} comes into the attack.`);
      }

      const dt = (b.delivery_type||"legal").toLowerCase();
      if (dt === "wide") extras.push(`Wide ‚Äî +${b.extras||1}`);
      if (dt === "noball") extras.push(`No-ball ‚Äî +${b.extras||1}`);
      if (dt === "bye" && (b.extras_detail?.byes)) extras.push(`Byes ‚Äî +${b.extras_detail.byes}`);

      const prevRuns = liveBatRuns.get(b.striker_id) || 0;
      const newRuns = prevRuns + (b.runs_scored || 0);
      liveBatRuns.set(b.striker_id, newRuns);
      if (newRuns >= 50 && prevRuns < 50 && newRuns < 100) extras.push(`${nameWithBadges(b.striker_id)} scores his FIFTY`);
      else if (newRuns >= 100 && prevRuns < 100) extras.push(`${nameWithBadges(b.striker_id)} scores his HUNDRED`);

      if (b.wicket) {
        const disTxt = (function(){
          const t = (b.dismissal_type||"").toLowerCase();
          const bow = nameWithBadges(b.bowler_id);
          const fld = b.fielder_id ? nameWithBadges(b.fielder_id) : "";
          if (t === "bowled") return `b ${bow}`;
          if (t === "lbw") return `lbw b ${bow}`;
          if (t === "caught") {
            if (b.fielder_id && b.bowler_id && b.fielder_id === b.bowler_id) return `c & b ${bow}`;
            if (b.fielder_id) return `c ${fld} b ${bow}`;
            return `c b ${bow}`;
          }
          if (t === "runout" || t === "run-out") return b.fielder_id ? `run out (${fld})` : `run out`;
          return bow ? `b ${bow}` : 'out';
        })();
        const outPid = b.dismissed_batsman_id || b.striker_id;
        const outName = nameWithBadges(outPid);
        const faced = allBalls.slice(0, shown).filter(x=>x.innings===b.innings && x.striker_id===outPid && isLegal(x)).length;
        const runs = liveBatRuns.get(outPid) || 0;
        extras.push(`${outName} ${disTxt} ${runs}(${faced})`);
        const nextBall = allBalls[shown] || null;
        if (nextBall && nextBall.innings === b.innings) {
          const newcomer = nextBall.striker_id !== outPid && nextBall.striker_id !== (prev?.striker_id) ? nextBall.striker_id : nextBall.non_striker_id;
          if (newcomer) extras.push(`${nameWithBadges(newcomer)} comes in to the Crease.`);
        }
      }

      commFeed.insertAdjacentHTML("afterbegin", ballHtml(b, extras));
      updateMini(allBalls.slice(0, shown));

      // End of innings message
      const next = allBalls[shown] || null;
      if (!next || next.innings !== b.innings) {
        if (b.innings === 1) {
          const t1 = totals(allBalls,1);
          const need = t1.runs + 1;
          const ballsLeft = 120;
          // battingSecond is the chasing team
          const chasingName = names[battingSecond] || names[match.away_team_id] || "Team B";
          commFeed.insertAdjacentHTML("afterbegin",
            `<div class="ball"><div class="head">End of Innings 1</div><div>${chasingName} required ${need} runs from ${ballsLeft} balls to win</div></div>`);
        }
      }

      if (shown >= allBalls.length) { maybeFinalMessage(); return false; }
      return true;
    }

    function stepOver(){
      if (shown >= allBalls.length) { maybeFinalMessage(); return; }
      const curr = allBalls[shown]; if (!curr) return;
      const tgtInn = curr.innings, tgtOver = curr.over_number + 1;
      while (shown < allBalls.length){
        const b = allBalls[shown];
        if (!stepOne()) break;
        if (b.innings === tgtInn && b.over_number === tgtOver) break;
      }
    }

    function maybeFinalMessage(){
      const t1 = totals(allBalls,1), t2 = totals(allBalls,2);
      // Determine winners using match.result if present, else totals
      let winnerText = "";
      const homeName = names[match.home_team_id] || "Home";
      const awayName = names[match.away_team_id] || "Away";

      // prefer canonical winner id if present
      if (match && match.winner_team_id) {
        const winnerId = String(match.winner_team_id);
        winnerText = `${names[winnerId] || winnerId} won the match`;
      } else {
        if (t1.runs > t2.runs) {
          const teamName = names[battingFirst] || homeName;
          const margin = t1.runs - t2.runs;
          winnerText = `${teamName} won the match by ${margin} runs`;
        } else if (t2.runs > t1.runs) {
          const teamName = names[battingSecond] || awayName;
          const wktsLeft = 10 - t2.wkts;
          winnerText = `${teamName} won the match by ${wktsLeft} wickets`;
        } else {
          winnerText = "Match tied";
        }
      }

      commFeed.insertAdjacentHTML("afterbegin", `<div class="ball"><div class="head">END of the MATCH</div><div>${winnerText}</div></div>`);
      setButtons();
    }

    /* ---------- Data load & initialization ---------- */

    function formatDateTime(ts){
      if(!ts) return "--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24 % 12 || 12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = h24 >= 12 ? "PM" : "AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${mi} ${ampm}`;
    }

    async function loadReplay(){
      if (!matchId) { alert("Missing match id"); return; }

      const { data: m } = await supabase.from("matches").select("*").eq("id", matchId).maybeSingle();
      if (!m) { alert("Match not found"); return; }
      match = m;

      // load team names
      const { data: teams } = await supabase.from("teams").select("id,team_name").in("id", [m.home_team_id, m.away_team_id]);
      (teams||[]).forEach(t => names[t.id] = t.team_name);

      // load players map
      const { data: ps } = await supabase.from("players").select("id,name,team_id,batting,bowling").in("team_id", [m.home_team_id, m.away_team_id]);
      (ps||[]).forEach(p => players[p.id] = { name: p.name, team_id: p.team_id, batting: p.batting, bowling: p.bowling });

      // load lineup small info (captain/keeper)
      const { data: lus } = await supabase.from("lineups").select("team_id,captain,keeper").in("team_id", [m.home_team_id, m.away_team_id]);
      (lus||[]).forEach(l => roles[l.team_id] = { captain: l.captain, keeper: l.keeper });

      // Decide battingFirst/battingSecond robustly using toss data, sim_state, result, innings array
      const normalized = normalizeTossFromPayload(match);
      if (normalized && normalized.winner_team_id) {
        const winner = String(normalized.winner_team_id);
        const decision = (normalized.decision || '').toLowerCase();
        const home = String(m.home_team_id), away = String(m.away_team_id);
        if (decision === 'bowl' || decision === 'field') {
          // winner bowled first -> other team batted first
          if (winner === home) { battingFirst = m.away_team_id; battingSecond = m.home_team_id; }
          else { battingFirst = m.home_team_id; battingSecond = m.away_team_id; }
        } else {
          if (winner === home) { battingFirst = m.home_team_id; battingSecond = m.away_team_id; }
          else { battingFirst = m.away_team_id; battingSecond = m.home_team_id; }
        }
      } else if (Array.isArray(m.innings) && m.innings.length >= 2 && m.innings[0].team_id) {
        battingFirst = m.innings[0].team_id;
        battingSecond = m.innings[1].team_id;
      } else if (m.result && m.result.innings && Array.isArray(m.result.innings) && m.result.innings.length >= 2 && m.result.innings[0].team_id) {
        battingFirst = m.result.innings[0].team_id;
        battingSecond = m.result.innings[1].team_id;
      } else {
        // fallback: home bats first
        battingFirst = m.home_team_id;
        battingSecond = m.away_team_id;
      }

      // load ball_by_ball
      const { data: ballsData } = await supabase
        .from("ball_by_ball")
        .select("*")
        .eq("match_id", matchId)
        .order("innings", { ascending: true })
        .order("over_number", { ascending: true })
        .order("ball_in_over", { ascending: true })
        .order("created_at", { ascending: true });

      let fetched = (ballsData || []).slice();

      // Ensure toss row present, filter noisy early lines
      fetched = ensureTossInCommentary(match, fetched);
      fetched = filterInitialNoisyLines(fetched);

      // Sort deterministically: toss first, then by innings/over/ball/created_at
      allBalls = fetched.sort((a,b)=>{
        if ((a.delivery_type||'').toLowerCase()==='toss' && (b.delivery_type||'').toLowerCase()!=='toss') return -1;
        if ((b.delivery_type||'').toLowerCase()==='toss' && (a.delivery_type||'').toLowerCase()!=='toss') return 1;
        if ((a.innings||0) !== (b.innings||0)) return (a.innings||0)-(b.innings||0);
        if ((a.over_number||0) !== (b.over_number||0)) return (a.over_number||0)-(b.over_number||0);
        if ((a.ball_in_over||0) !== (b.ball_in_over||0)) return (a.ball_in_over||0)-(b.ball_in_over||0);
        const ta = new Date(a.created_at||0).getTime();
        const tb = new Date(b.created_at||0).getTime();
        return ta - tb;
      });

      shown = 0;
      commFeed.innerHTML = "";
      liveBatRuns.clear();

      titleEl.textContent = `${names[m.home_team_id] || "Home"} vs ${names[m.away_team_id] || "Away"}`;
      const when = m.kickoff_at || (m.date && m.start_time ? `${m.date}T${m.start_time}` : null);
      replayDate.textContent = when ? formatDateTime(when) : "--";
      subEl.textContent = `Kickoff ‚Äî ${when?formatDateTime(when):"--"}`;

      // Compute totals and fill scorecard
      const t1 = totals(allBalls, 1), t2 = totals(allBalls, 2);

      // Headline uses battingFirst / battingSecond mapping to label the totals correctly
      headlineA.textContent = `${names[battingFirst] || 'Team A'} ${t1.runs}/${t1.wkts} (${oversTxt(t1.legal)} ov)`;
      headlineB.textContent = `${names[battingSecond] || 'Team B'} ${t2.runs}/${t2.wkts} (${oversTxt(t2.legal)} ov)`;

      // Scorecard innings labels and tables
      in1Name.textContent = `${names[battingFirst] || 'Team A'} ‚Äî Innings 1`;
      in2Name.textContent = `${names[battingSecond] || 'Team B'} ‚Äî Innings 2`;
      in1Tot.textContent = `${t1.runs}/${t1.wkts} in ${oversTxt(t1.legal)} ov`;
      in2Tot.textContent = `${t2.runs}/${t2.wkts} in ${oversTxt(t2.legal)} ov`;

      const batAgg1 = aggBat(allBalls,1), batAgg2 = aggBat(allBalls,2);
      const dm1 = dismissalMap(allBalls,1), dm2 = dismissalMap(allBalls,2);
      rowBat(bat1, batAgg1, dm1); rowBat(bat2, batAgg2, dm2);

      const bowlAgg1 = aggBowl(allBalls,1), bowlAgg2 = aggBowl(allBalls,2);
      rowBowl(bowl1, bowlAgg1); rowBowl(bowl2, bowlAgg2);

      // Render mini strip initially
      updateMini(allBalls);

      // Toss banner (render into both REPLAY and SCORECARD)
      renderTossBanner(match, allBalls);

      // Summary panel
      const homeName = names[m.home_team_id] || 'Home';
      const awayName = names[m.away_team_id] || 'Away';
      const homeRuns = (m.result && m.result.home && typeof m.result.home.runs !== 'undefined') ? m.result.home.runs : t1.runs;
      const awayRuns = (m.result && m.result.away && typeof m.result.away.runs !== 'undefined') ? m.result.away.runs : t2.runs;

      // Winner determination: prefer match.winner_team_id > match.result.winner > totals
      let winnerLabel = null;
      if (m.winner_team_id) winnerLabel = names[m.winner_team_id] || String(m.winner_team_id);
      else if (m.result && m.result.winner) {
        const rw = m.result.winner;
        if (rw === 'home') winnerLabel = homeName;
        else if (rw === 'away') winnerLabel = awayName;
        else winnerLabel = names[rw] || rw;
      } else {
        if (t1.runs > t2.runs) winnerLabel = names[battingFirst] || homeName;
        else if (t2.runs > t1.runs) winnerLabel = names[battingSecond] || awayName;
        else winnerLabel = null;
      }

      if (!winnerLabel) {
        resLine.textContent = `Match tied ‚Äî ${homeName} ${homeRuns}, ${awayName} ${awayRuns}`;
      } else {
        resLine.textContent = `${winnerLabel} won the match`;
      }

      // Fill summary boxes
      sumHomeName.textContent = homeName; sumAwayName.textContent = awayName;
      sumHomeScore.textContent = `${homeRuns} (${oversTxt(t1.legal)} ov)`;
      sumAwayScore.textContent = `${awayRuns} (${oversTxt(t2.legal)} ov)`;

      const tbHome = topBattersFor(m.home_team_id, [batAgg1, batAgg2]);
      const tbAway = topBattersFor(m.away_team_id, [batAgg1, batAgg2]);
      const bwHome = topBowlersFor(m.home_team_id, [bowlAgg1, bowlAgg2]);
      const bwAway = topBowlersFor(m.away_team_id, [bowlAgg1, bowlAgg2]);

      fillList(sumHomeTopBat, tbHome); fillList(sumHomeTopBowl, bwHome);
      fillList(sumAwayTopBat, tbAway); fillList(sumAwayTopBowl, bwAway);

      setButtons();
    }

    function fillList(ul, items){ ul.innerHTML = ""; items.forEach(i => ul.insertAdjacentHTML("beforeend", `<li>${i}</li>`)); }

    function topBattersFor(teamId, maps){
      const comb = {};
      for (const map of maps) {
        for (const [pid,st] of Object.entries(map)) {
          const c = comb[pid] ||= { r:0, b:0 };
          c.r += st.r; c.b += st.b;
        }
      }
      return Object.entries(comb)
        .filter(([pid]) => players[pid] && players[pid].team_id === teamId)
        .map(([pid,st]) => ({ pid, r: st.r, b: st.b, sr: st.b ? st.r/st.b*100 : 0 }))
        .sort((a,b) => b.r - a.r || b.sr - a.sr)
        .slice(0,3)
        .map(x => `${nameWithBadges(x.pid)} ‚Äî ${x.r} (${x.b}), SR ${x.sr.toFixed(1)}`);
    }
    function topBowlersFor(teamId, maps){
      const comb = {};
      for (const map of maps) {
        for (const [pid,st] of Object.entries(map)) {
          const c = comb[pid] ||= { r:0, b:0, w:0 };
          c.r += st.r; c.b += st.b; c.w += st.w;
        }
      }
      return Object.entries(comb)
        .filter(([pid]) => players[pid] && players[pid].team_id === teamId)
        .map(([pid,st]) => ({ pid, w: st.w, eco: st.b ? st.r/(st.b/6) : 0 }))
        .sort((a,b) => b.w - a.w || a.eco - b.eco)
        .slice(0,3)
        .map(x => `${nameWithBadges(x.pid)} ‚Äî ${x.w} wkts, ${x.eco.toFixed(1)} econ`);
    }

    // init
    loadReplay();

  </script>
</body>
</html>
