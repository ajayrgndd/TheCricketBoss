<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendly Replay ‚Äì TheCricketBoss</title>

  <link rel="stylesheet" href="styles/global.css"/>

  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}

    /* header */
    .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    .badge-friendly{background:#1b4332;color:#d1fae5;border-color:#24543f}
    .chip-done{background:#334155;color:#e2e8f0;border:1px solid #3b475f;border-radius:6px;padding:4px 10px;font-size:.75rem}
    .muted{opacity:.75}

    /* tabs */
    .tabs{display:flex;gap:6px;border-bottom:2px solid #1d263a;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}

    .panel{display:none}
    .panel.show{display:block}

    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:12px;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center}
    th{background:#192238}
    td.left{text-align:left}

    /* mini score strip */
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;
      font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.05rem}

    /* commentary list (top = latest) */
    .feed{display:flex;flex-direction:column;gap:8px}
    .ball{padding:10px;border:1px dashed #26314b;border-radius:10px;background:#0f1522}
    .ball .head{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px}
    .tag{font-size:.7rem;border-radius:6px;padding:2px 8px;border:1px solid #334155;background:#152035}
    .wkt{background:#3a0e14;border-color:#521b24;color:#ffd6d6}
    .b4{background:#123d27;border-color:#1c593a;color:#b8ffd6}
    .b6{background:#0e2e57;border-color:#1a4886;color:#cfe8ff}

    /* controls */
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .controls button,.controls select{
      background:#10151f;color:#e7ecf3;border:1px solid #22304b;border-radius:8px;padding:8px 10px;cursor:pointer
    }
    .controls button:disabled{opacity:.6;cursor:not-allowed}
    .spacer{flex:1}

    /* summary */
    .sum-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .sum-item{background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <!-- Top / Bottom nav containers -->
  <div id="top-bar"></div>

  <div class="wrap">
    <div class="head">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge badge-friendly">Friendly</span>
        <span id="replay-date" class="muted">--</span>
      </div>
      <span class="chip-done">Completed</span>
    </div>

    <h2 id="match-title">Home vs Away</h2>
    <div class="muted" id="match-sub">Kickoff ‚Äî --</div>

    <!-- Tabs -->
    <div class="tabs" style="margin-top:12px">
      <button id="tab-comm" class="active">COMMENTARY</button>
      <button id="tab-score">SCORECARD</button>
      <button id="tab-summary">SUMMARY</button>
    </div>

    <!-- COMMENTARY (with mini score) -->
    <section id="comm-panel" class="panel show">
      <div class="card">
        <div class="controls">
          <button id="btn-play">‚ñ∂ Play</button>
          <button id="btn-pause" disabled>‚è∏ Pause</button>
          <button id="btn-next">‚è© Next ball</button>
          <button id="btn-skip-over">‚è≠ Next over</button>
          <button id="btn-restart">üîÅ Restart</button>
          <div class="spacer"></div>
          <label>Speed
            <select id="speed">
              <option value="1200">Slow</option>
              <option value="700" selected>Normal</option>
              <option value="350">Fast</option>
            </select>
          </label>
        </div>
      </div>

      <div class="score-strip">
        <div class="big" id="mini-a">--/-- - --.- ov</div>
        <div class="big" id="mini-b">--/-- - --.- ov</div>
      </div>

      <div class="card">
        <div id="comm-feed" class="feed"></div>
      </div>
    </section>

    <!-- SCORECARD -->
    <section id="score-panel" class="panel">
      <div id="sc-in1" class="card">
        <h3 id="in1-name">Innings 1</h3>
        <div class="muted" id="in1-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat1"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl1"></tbody>
        </table>
      </div>

      <div id="sc-in2" class="card">
        <h3 id="in2-name">Innings 2</h3>
        <div class="muted" id="in2-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat2"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl2"></tbody>
        </table>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary-panel" class="panel">
      <div class="card">
        <h3>Match Summary</h3>
        <div id="result-line" style="margin:6px 0 12px 0;font-weight:700"></div>
        <div class="sum-grid">
          <div class="sum-item">
            <div id="sum-home-name" class="muted">Home</div>
            <div id="sum-home-score" style="font-size:1.1rem;font-weight:800">--/--</div>
          </div>
          <div class="sum-item">
            <div id="sum-away-name" class="muted">Away</div>
            <div id="sum-away-score" style="font-size:1.1rem;font-weight:800">--/--</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    loadSmoothUI("top-bar","bottom-nav");
  </script>

  <!-- Replay Logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    /* Tabs */
    const tabs = {
      comm: document.getElementById("tab-comm"),
      score: document.getElementById("tab-score"),
      summary: document.getElementById("tab-summary"),
    };
    const panels = {
      comm: document.getElementById("comm-panel"),
      score: document.getElementById("score-panel"),
      summary: document.getElementById("summary-panel"),
    };
    const activate = (key) => {
      ["comm","score","summary"].forEach(k=>{
        tabs[k].classList.toggle("active", k===key);
        panels[k].classList.toggle("show", k===key);
      });
    };
    tabs.comm.onclick = () => activate("comm");
    tabs.score.onclick = () => activate("score");
    tabs.summary.onclick = () => activate("summary");

    /* Elements */
    const qs = new URLSearchParams(location.search);
    const matchId = qs.get("id");

    const titleEl = document.getElementById("match-title");
    const subEl   = document.getElementById("match-sub");
    const replayDate = document.getElementById("replay-date");
    const commFeed = document.getElementById("comm-feed");

    const in1Name = document.getElementById("in1-name");
    const in2Name = document.getElementById("in2-name");
    const in1Tot  = document.getElementById("in1-total");
    const in2Tot  = document.getElementById("in2-total");

    const miniA = document.getElementById("mini-a");
    const miniB = document.getElementById("mini-b");

    const bat1 = document.getElementById("bat1");
    const bat2 = document.getElementById("bat2");
    const bowl1 = document.getElementById("bowl1");
    const bowl2 = document.getElementById("bowl2");

    const resLine = document.getElementById("result-line");
    const sumHomeName = document.getElementById("sum-home-name");
    const sumHomeScore = document.getElementById("sum-home-score");
    const sumAwayName = document.getElementById("sum-away-name");
    const sumAwayScore = document.getElementById("sum-away-score");

    /* Utils */
    function fmtDateTime(ts){
      if(!ts) return "";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24 % 12 || 12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = h24 >= 12 ? "PM" : "AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${mi} ${ampm}`;
    }
    const oversTxt = (balls)=> `${Math.floor(balls/6)}.${balls%6}`;

    function aggBatting(balls, inn){
      const map = {};
      balls.filter(b=>b.innings===inn).forEach(b=>{
        if(!b.striker_id) return;
        const m = map[b.striker_id] ||= {r:0,b:0,f:0,s:0,out:false};
        m.r += b.runs_scored||0;
        m.b += 1;
        if (b.runs_scored===4) m.f++;
        if (b.runs_scored===6) m.s++;
        if (b.wicket && b.dismissed_batsman_id === b.striker_id) m.out = true;
      });
      return map;
    }
    function aggBowling(balls, inn){
      const map = {};
      balls.filter(b=>b.innings===inn).forEach(b=>{
        if(!b.bowler_id) return;
        const m = map[b.bowler_id] ||= {r:0,b:0,w:0};
        m.r += (b.runs_scored||0) + (b.extras||0);
        m.b += 1;
        if (b.wicket) m.w += 1;
      });
      return map;
    }
    function innTotals(balls, inn){
      const list = balls.filter(b=>b.innings===inn);
      const runs = list.reduce((s,b)=>s+(b.runs_scored||0)+(b.extras||0),0);
      const wkts = list.reduce((s,b)=>s+(b.wicket?1:0),0);
      return {runs,wkts,balls:list.length};
    }

    function renderBatTable(tbody, map, players){
      tbody.innerHTML = "";
      Object.entries(map).forEach(([pid,st])=>{
        const name = players[pid]?.name ?? "‚Äî";
        const sr = st.b ? ((st.r/st.b)*100).toFixed(1) : "0.0";
        const star = st.out ? "" : " ‚òÖ";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${name}${star}</td><td>${st.r}</td><td>${st.b}</td><td>${st.f}</td><td>${st.s}</td><td>${sr}</td></tr>`);
      });
    }
    function renderBowlTable(tbody, map, players){
      tbody.innerHTML = "";
      Object.entries(map).forEach(([pid,st])=>{
        const name = players[pid]?.name ?? "‚Äî";
        const ov = (st.b/6).toFixed(1);
        const eco = st.b ? (st.r/(st.b/6)).toFixed(1) : "0.0";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${name}</td><td>${ov}</td><td>${st.r}</td><td>${st.w}</td><td>${eco}</td></tr>`);
      });
    }

    function commentaryLine(b, players){
      const tags = [];
      if (b.wicket) tags.push('<span class="tag wkt">WICKET</span>');
      if (b.runs_scored===4) tags.push('<span class="tag b4">FOUR</span>');
      if (b.runs_scored===6) tags.push('<span class="tag b6">SIX</span>');

      const line = b.commentary || (b.wicket
        ? `OUT! ${(players[b.striker_id]?.name ?? "Batsman")}`
        : `Runs: ${b.runs_scored||0}`);

      return `
        <div class="ball">
          <div class="head">
            <div> I${b.innings} ‚Ä¢ ${b.over_number}.${b.ball_in_over} </div>
            <div>${tags.join(" ")}</div>
          </div>
          <div>${line}</div>
        </div>
      `;
    }

    /* Replay state */
    let allBalls = [];          // full list from DB
    let shown = 0;              // how many balls are currently revealed
    let timer = null;
    let delay = 700;            // default speed
    let players = {};
    let names = {};
    let match = null;

    /* Controls */
    const btnPlay = document.getElementById("btn-play");
    const btnPause = document.getElementById("btn-pause");
    const btnNext = document.getElementById("btn-next");
    const btnOver = document.getElementById("btn-skip-over");
    const btnRestart = document.getElementById("btn-restart");
    const speedSel = document.getElementById("speed");

    speedSel.onchange = () => { delay = parseInt(speedSel.value, 10) || 700; if (timer){ pause(); play(); } };
    btnPlay.onclick = () => play();
    btnPause.onclick = () => pause();
    btnNext.onclick = () => { stepOne(); };
    btnOver.onclick = () => { stepOver(); };
    btnRestart.onclick = () => { restart(); };

    function setButtons() {
      const done = shown >= allBalls.length;
      btnPlay.disabled = timer !== null || done;
      btnPause.disabled = timer === null;
      btnNext.disabled = done;
      btnOver.disabled = done;
      btnRestart.disabled = shown === 0 && !done;
    }

    function play(){
      if (timer || shown >= allBalls.length) return;
      timer = setInterval(() => {
        if (!stepOne()) pause();
      }, delay);
      setButtons();
    }
    function pause(){
      if (timer) clearInterval(timer);
      timer = null;
      setButtons();
    }
    function restart(){
      pause();
      shown = 0;
      commFeed.innerHTML = "";
      renderUpTo(0);
      setButtons();
    }
    function stepOne(){
      if (shown >= allBalls.length) return false;
      const b = allBalls[shown++];
      // prepend latest at top
      commFeed.insertAdjacentHTML("afterbegin", commentaryLine(b, players));
      renderUpTo(shown);
      if (shown >= allBalls.length) return false;
      return true;
    }
    function stepOver(){
      if (shown >= allBalls.length) return;
      const curr = allBalls[shown] ?? null;
      if (!curr){ return; }
      const targetInn = curr.innings;
      const targetOver = curr.over_number + 1;
      while (shown < allBalls.length) {
        const b = allBalls[shown];
        stepOne();
        if (b.innings === targetInn && b.over_number === targetOver) break;
      }
    }

    function updateMiniStrip(part){
      const t1 = innTotals(part,1);
      const t2 = innTotals(part,2);
      miniA.textContent = `${t1.runs}/${t1.wkts} - ${oversTxt(t1.balls)} ov`;
      miniB.textContent = `${t2.runs}/${t2.wkts} - ${oversTxt(t2.balls)} ov`;
    }

    function renderUpTo(n){
      // update scorecards progressively using first n balls
      const part = allBalls.slice(0,n);

      // mini score strip
      updateMiniStrip(part);

      // Innings names (assume home=I1, away=I2 like sim)
      in1Name.textContent = `${names[match.home_team_id]||"Home"} ‚Äî Innings 1`;
      in2Name.textContent = `${names[match.away_team_id]||"Away"} ‚Äî Innings 2`;

      const t1 = innTotals(part,1);
      const t2 = innTotals(part,2);
      in1Tot.textContent = `${t1.runs}/${t1.wkts} in ${oversTxt(t1.balls)} ov`;
      in2Tot.textContent = `${t2.runs}/${t2.wkts} in ${oversTxt(t2.balls)} ov`;

      const batAgg1 = aggBatting(part,1);
      const batAgg2 = aggBatting(part,2);
      renderBatTable(bat1, batAgg1, players);
      renderBatTable(bat2, batAgg2, players);

      const bowlAgg1 = aggBowling(part,1);
      const bowlAgg2 = aggBowling(part,2);
      renderBowlTable(bowl1, bowlAgg1, players);
      renderBowlTable(bowl2, bowlAgg2, players);

      // Summary only once all balls revealed
      if (n >= allBalls.length) {
        const homeRuns = match.result?.home?.runs ?? t1.runs;
        const awayRuns = match.result?.away?.runs ?? t2.runs;
        const winner = match.result?.winner ?? (homeRuns>=awayRuns ? "home" : "away");
        const in1Team = names[match.home_team_id] || "Home";
        const in2Team = names[match.away_team_id] || "Away";
        const winnerName = winner === "home" ? in1Team : in2Team;

        document.getElementById("result-line").textContent =
          `${winnerName} won ‚Äî ${in1Team} ${homeRuns} / ${in2Team} ${awayRuns}`;
        document.getElementById("sum-home-name").textContent = in1Team;
        document.getElementById("sum-away-name").textContent = in2Team;
        document.getElementById("sum-home-score").textContent = `${homeRuns} (${oversTxt(t1.balls)} ov)`;
        document.getElementById("sum-away-score").textContent = `${awayRuns} (${oversTxt(t2.balls)} ov)`;
      }
    }

    async function loadReplay(){
      if (!matchId){ alert("Missing match id"); return; }

      // Match meta
      const { data: m } = await supabase
        .from("matches")
        .select("home_team_id,away_team_id,date,start_time,kickoff_at,status,result,is_friendly")
        .eq("id", matchId).maybeSingle();
      if (!m){ alert("Match not found"); return; }
      match = m;

      const { data: teams } = await supabase
        .from("teams").select("id,team_name")
        .in("id", [m.home_team_id, m.away_team_id]);

      names = {};
      (teams||[]).forEach(t=> names[t.id] = t.team_name);
      titleEl.textContent = `${names[m.home_team_id]||"Home"} vs ${names[m.away_team_id]||"Away"}`;

      const when = m.kickoff_at || (m.date && m.start_time ? `${m.date}T${m.start_time}` : null);
      replayDate.textContent = fmtDateTime(when);
      subEl.textContent = `Kickoff ‚Äî ${fmtDateTime(when)}`;

      // Players
      const { data: ps } = await supabase
        .from("players").select("id,name,team_id")
        .in("team_id", [m.home_team_id, m.away_team_id]);
      players = {};
      (ps||[]).forEach(p=> players[p.id] = { name: p.name });

      // Balls (ordered oldest->newest; we will reveal from start but render newest on top)
      const { data: balls } = await supabase
        .from("ball_by_ball")
        .select("*")
        .eq("match_id", matchId)
        .order("innings", { ascending: true })
        .order("over_number", { ascending: true })
        .order("ball_in_over", { ascending: true });

      allBalls = balls || [];
      shown = 0;
      commFeed.innerHTML = "";
      renderUpTo(0);
      setButtons();
    }

    // Kickoff
    let players = {};
    let names = {};
    let match = null;
    loadReplay();
  </script>
</body>
</html>
