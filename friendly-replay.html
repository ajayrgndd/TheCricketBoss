<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendly Replay ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}

    .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    .badge-friendly{background:#1b4332;color:#d1fae5;border-color:#24543f}
    .chip-done{background:#334155;color:#e2e8f0;border:1px solid #3b475f;border-radius:6px;padding:4px 10px;font-size:.75rem}
    .muted{opacity:.75}

    .tabs{display:flex;gap:6px;border-bottom:2px solid #1d263a;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}

    .panel{display:none}
    .panel.show{display:block}

    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:12px;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center}
    th{background:#192238}
    td.left{text-align:left}

    /* mini score strip */
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;
      font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.05rem}

    /* commentary list */
    .feed{display:flex;flex-direction:column;gap:8px}
    .ball{padding:10px;border:1px dashed #26314b;border-radius:10px;background:#0f1522}
    .ball .head{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px}
    .tag{font-size:.7rem;border-radius:6px;padding:2px 8px;border:1px solid #334155;background:#152035}
    .wkt{background:#3a0e14;border-color:#521b24;color:#ffd6d6}
    .b4{background:#123d27;border-color:#1c593a;color:#b8ffd6}
    .b6{background:#0e2e57;border-color:#1a4886;color:#cfe8ff}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <div class="wrap">
    <div class="head">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge badge-friendly">Friendly</span>
        <span id="replay-date" class="muted">--</span>
      </div>
      <span class="chip-done">Completed</span>
    </div>

    <h2 id="match-title">Home vs Away</h2>
    <div class="muted" id="match-sub">Kickoff ‚Äî --</div>

    <!-- Default SCORECARD -->
    <div class="tabs" style="margin-top:12px">
      <button id="tab-replay">REPLAY</button>
      <button id="tab-score" class="active">SCORECARD</button>
      <button id="tab-summary">SUMMARY</button>
    </div>

    <!-- REPLAY -->
    <section id="replay-panel" class="panel">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btn-play">‚ñ∂ Play</button>
          <button id="btn-pause" disabled>‚è∏ Pause</button>
          <button id="btn-next">‚è© Next ball</button>
          <button id="btn-skip-over">‚è≠ Next over</button>
          <button id="btn-restart">üîÅ Restart</button>
          <div style="flex:1"></div>
          <label>Speed
            <select id="speed">
              <option value="1200">Slow</option>
              <option value="700" selected>Normal</option>
              <option value="350">Fast</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Mini score strip -->
      <div class="score-strip">
        <div class="big" id="mini-a">0/0 - 0.0 ov</div>
        <div class="big" id="mini-b">0/0 - 0.0 ov</div>
      </div>

      <div class="card">
        <div id="comm-feed" class="feed"></div>
      </div>
    </section>

    <!-- SCORECARD (final) -->
    <section id="score-panel" class="panel show">
      <div class="card">
        <div id="headline-a" style="font-weight:800;font-size:1.05rem;">‚Äî</div>
        <div id="headline-b" style="font-weight:800;font-size:1.05rem;margin-top:6px;">‚Äî</div>
      </div>

      <div id="sc-in1" class="card">
        <h3 id="in1-name">Innings 1</h3>
        <div class="muted" id="in1-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat1"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl1"></tbody>
        </table>
      </div>

      <div id="sc-in2" class="card">
        <h3 id="in2-name">Innings 2</h3>
        <div class="muted" id="in2-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat2"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl2"></tbody>
        </table>
      </div>
    </section>

    <!-- SUMMARY -->
    <section id="summary-panel" class="panel">
      <div class="card">
        <h3>Match Summary</h3>
        <div id="result-line" style="margin:6px 0 12px 0;font-weight:700"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-home-name" class="muted">Home</div>
            <div id="sum-home-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-home-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-home-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-away-name" class="muted">Away</div>
            <div id="sum-away-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-away-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-away-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    loadSmoothUI("top-bar","bottom-nav");
  </script>

  <!-- Replay Logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ====== bootstrap ====== */
    const qs = new URLSearchParams(location.search);
    const matchId = qs.get("id");

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE",
      { global: { headers: { "x-match-id": matchId ?? "" } } }
    );

    /* tabs */
    const tabs = {
      replay: document.getElementById("tab-replay"),
      score: document.getElementById("tab-score"),
      summary: document.getElementById("tab-summary"),
    };
    const panels = {
      replay: document.getElementById("replay-panel"),
      score: document.getElementById("score-panel"),
      summary: document.getElementById("summary-panel"),
    };
    const activate = (k)=>["replay","score","summary"].forEach(t=>{
      tabs[t].classList.toggle("active", t===k);
      panels[t].classList.toggle("show", t===k);
    });
    activate("score");
    tabs.replay.onclick=()=>activate("replay");
    tabs.score.onclick =()=>activate("score");
    tabs.summary.onclick=()=>activate("summary");

    /* els */
    const titleEl = document.getElementById("match-title");
    const subEl   = document.getElementById("match-sub");
    const replayDate = document.getElementById("replay-date");
    const headlineA = document.getElementById("headline-a");
    const headlineB = document.getElementById("headline-b");
    const in1Name = document.getElementById("in1-name");
    const in2Name = document.getElementById("in2-name");
    const in1Tot  = document.getElementById("in1-total");
    const in2Tot  = document.getElementById("in2-total");
    const bat1 = document.getElementById("bat1");
    const bat2 = document.getElementById("bat2");
    const bowl1 = document.getElementById("bowl1");
    const bowl2 = document.getElementById("bowl2");
    const miniA = document.getElementById("mini-a");
    const miniB = document.getElementById("mini-b");
    const commFeed = document.getElementById("comm-feed");

    const resLine = document.getElementById("result-line");
    const sumHomeName = document.getElementById("sum-home-name");
    const sumHomeScore = document.getElementById("sum-home-score");
    const sumAwayName = document.getElementById("sum-away-name");
    const sumAwayScore = document.getElementById("sum-away-score");
    const sumHomeTopBat = document.getElementById("sum-home-topbat");
    const sumHomeTopBowl = document.getElementById("sum-home-topbowl");
    const sumAwayTopBat = document.getElementById("sum-away-topbat");
    const sumAwayTopBowl = document.getElementById("sum-away-topbowl");

    /* controls */
    const btnPlay = document.getElementById("btn-play");
    const btnPause = document.getElementById("btn-pause");
    const btnNext = document.getElementById("btn-next");
    const btnOver = document.getElementById("btn-skip-over");
    const btnRestart = document.getElementById("btn-restart");
    const speedSel = document.getElementById("speed");

    /* state */
    const roles = {}; // teamId -> {captain, keeper}
    let players = {}; // id -> {name, team_id}
    let names = {};   // teamId -> name
    let match = null;
    let allBalls = []; let shown = 0; let timer = null; let delay = 700;

    /* utils */
    const oversTxt = (b)=>`${Math.floor(b/6)}.${b%6}`;
    function fmtDateTime(ts){
      if(!ts) return "";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24 % 12 || 12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = h24>=12?"PM":"AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${mi} ${ampm}`;
    }
    const short = (id)=> id ? String(id).slice(0,8) : "‚Äî";
    function nameWithBadges(pid){
      if (!pid) return "‚Äî";
      const p = players[pid];
      if (!p) return `Player ${short(pid)}`; // RLS fallback
      const r = roles[p.team_id] || {};
      const tags=[];
      if (r.captain===pid) tags.push("C");
      if (r.keeper===pid)  tags.push("WK");
      return `${p.name}${tags.length?` (${tags.join(", ")})`:''}`;
    }

    function totals(list, inn){
      const arr=list.filter(b=>b.innings===inn);
      return {
        runs: arr.reduce((s,b)=>s+(b.runs_scored||0)+(b.extras||0),0),
        wkts: arr.reduce((s,b)=>s+(b.wicket?1:0),0),
        balls: arr.length
      };
    }
    function aggBat(list, inn){
      const map={};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.striker_id; if(!id) return;
        const m=map[id] ||= {r:0,b:0,f:0,s:0};
        m.r += b.runs_scored||0; m.b += 1;
        if (b.runs_scored===4) m.f++;
        if (b.runs_scored===6) m.s++;
      }); return map;
    }
    function aggBowl(list, inn){
      const map={};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.bowler_id; if(!id) return;
        const m=map[id] ||= {r:0,b:0,w:0};
        m.r += (b.runs_scored||0)+(b.extras||0); m.b += 1;
        const bowlerGetsWicket = b.wicket && (b.dismissal_type||'').toLowerCase()!=='runout';
        if (bowlerGetsWicket) m.w++;
      }); return map;
    }
    function dismissalMap(list, inn){
      const map={};
      list.filter(b=>b.innings===inn && b.wicket && b.dismissed_batsman_id).forEach(b=>{
        map[b.dismissed_batsman_id] = {
          type:(b.dismissal_type||'').toLowerCase(),
          bowler:b.bowler_id||null,
          fielder:b.fielder_id||null
        };
      }); return map;
    }
    function dismissText(pid, dm){
      const d=dm[pid]; if(!d) return "not out";
      const bow=nameWithBadges(d.bowler); const fld=nameWithBadges(d.fielder);
      if (d.type==="bowled") return `b ${bow}`;
      if (d.type==="lbw") return `lbw b ${bow}`;
      if (d.type==="caught"){
        if (d.fielder && d.bowler && d.fielder===d.bowler) return `c & b ${bow}`;
        if (d.fielder) return `c ${fld} b ${bow}`;
        return `c b ${bow}`;
      }
      if (d.type==="runout"||d.type==="run-out") return d.fielder?`run out (${fld})`:`run out`;
      return bow?`b ${bow}`:"out";
    }

    function rowBat(tbody, map, dm){
      tbody.innerHTML="";
      Object.entries(map).forEach(([pid,st])=>{
        const nm = nameWithBadges(pid);
        const sr = st.b ? ((st.r/st.b)*100).toFixed(1) : "0.0";
        const dis = dismissText(pid, dm);
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nm}</td><td class="left">${dis} ${st.b?` ${st.r}(${st.b})`:''}</td><td>${st.r}</td><td>${st.b}</td><td>${st.f}</td><td>${st.s}</td><td>${sr}</td></tr>`);
      });
    }
    function rowBowl(tbody, map){
      tbody.innerHTML="";
      Object.entries(map).forEach(([pid,st])=>{
        const nm=nameWithBadges(pid);
        const ov=(st.b/6).toFixed(1);
        const eco=st.b?(st.r/(st.b/6)).toFixed(1):"0.0";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nm}</td><td>${ov}</td><td>${st.r}</td><td>${st.w}</td><td>${eco}</td></tr>`);
      });
    }

    /* Commentary variants ‚Äî always use these, never the raw DB "Runs:N"/"OUT!" */
    const VARIANTS={
      0:["Dot ball.","Beaten!","Good length ‚Äî no run."],
      1:["Just a single.","Nudged for one.","Soft hands, one run."],
      2:["They come back for two.","Comfortable two.","Pushed for a brace."],
      3:["All hustle ‚Äî three!","Good running ‚Äî three.","Long chase, three taken."],
      4:["FOUR! Crunched.","Pierces the gap ‚Äî four.","Stroked away for four."],
      6:["SIX! Launched.","Into the stands ‚Äî six!","Clean strike ‚Äî maximum!"],
      W:["Gone! Big breakthrough.","Edged and taken!","Bowled him!"]
    };
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    /* Build the outcome line in the required format */
    function outcomeText(b){
      if (b.wicket) return `WICKET, ${pick(VARIANTS.W)}`;
      const r = Number.isFinite(b.runs_scored) ? b.runs_scored : 0;
      const pool = VARIANTS[Math.min(6, Math.max(0, r))] || ["Runs added."];
      return `Runs: ${r}, ${pick(pool)}`;
    }

    function pills(b){
      const a=[];
      if (b.wicket) a.push('<span class="tag wkt">WICKET</span>');
      if (b.runs_scored===4) a.push('<span class="tag b4">FOUR</span>');
      if (b.runs_scored===6) a.push('<span class="tag b6">SIX</span>');
      return a.join(" ");
    }

    /* Three-line commentary block */
    function comLine(b){
      const bow=nameWithBadges(b.bowler_id);
      const bat=nameWithBadges(b.striker_id);
      return `
        <div class="ball">
          <div class="head">
            <div>I${b.innings} ‚Ä¢ ${b.over_number}.${b.ball_in_over}</div>
            <div>${pills(b)}</div>
          </div>
          <div><strong>${bow}</strong> to <strong>${bat}</strong></div>
          <div>${outcomeText(b)}</div>
        </div>`;
    }

    function updateMini(part){
      const t1=totals(part,1), t2=totals(part,2);
      miniA.textContent = `${t1.runs}/${t1.wkts} - ${oversTxt(t1.balls)} ov`;
      miniB.textContent = `${t2.runs}/${t2.wkts} - ${oversTxt(t2.balls)} ov`;
    }

    function setButtons(){
      const done=shown>=allBalls.length;
      btnPlay.disabled = timer!==null || done;
      btnPause.disabled= timer===null;
      btnNext.disabled = done;
      btnOver.disabled = done;
      btnRestart.disabled = shown===0 && !done;
    }
    function play(){ if(timer||shown>=allBalls.length) return;
      timer=setInterval(()=>{ if(!stepOne()) pause(); },delay); setButtons(); }
    function pause(){ if(timer) clearInterval(timer); timer=null; setButtons(); }
    function restart(){ pause(); shown=0; commFeed.innerHTML=""; updateMini([]); setButtons(); }
    function stepOne(){
      if (shown>=allBalls.length) return false;
      const b=allBalls[shown++]; commFeed.insertAdjacentHTML("afterbegin", comLine(b));
      updateMini(allBalls.slice(0,shown));
      return shown<allBalls.length;
    }
    function stepOver(){
      if (shown>=allBalls.length) return;
      const curr=allBalls[shown]; if(!curr) return;
      const tgtInn=curr.innings, tgtOver=curr.over_number+1;
      while(shown<allBalls.length){ const b=allBalls[shown]; stepOne(); if(b.innings===tgtInn&&b.over_number===tgtOver) break; }
    }
    speedSel.onchange=()=>{ delay=parseInt(speedSel.value,10)||700; if(timer){ pause(); play(); } };
    btnPlay.onclick=()=>play(); btnPause.onclick=()=>pause();
    btnNext.onclick=()=>{ stepOne(); setButtons(); };
    btnOver.onclick=()=>{ stepOver(); setButtons(); };
    btnRestart.onclick=()=>{ restart(); };

    async function loadReplay(){
      if(!matchId){ alert("Missing match id"); return; }

      const { data:m } = await supabase.from("matches").select("*").eq("id", matchId).maybeSingle();
      if(!m){ alert("Match not found"); return; }
      match=m;

      const { data:teams } = await supabase.from("teams").select("id,team_name").in("id",[m.home_team_id,m.away_team_id]);
      (teams||[]).forEach(t=> names[t.id]=t.team_name);

      const { data:ps } = await supabase.from("players").select("id,name,team_id").in("team_id",[m.home_team_id,m.away_team_id]);
      (ps||[]).forEach(p=> players[p.id]={ name:p.name, team_id:p.team_id });

      const { data:lus } = await supabase.from("lineups").select("team_id,captain,keeper").in("team_id",[m.home_team_id,m.away_team_id]);
      (lus||[]).forEach(l=> roles[l.team_id]={ captain:l.captain, keeper:l.keeper });

      const { data:balls } = await supabase
        .from("ball_by_ball")
        .select("*")
        .eq("match_id", matchId)
        .order("innings",{ascending:true})
        .order("over_number",{ascending:true})
        .order("ball_in_over",{ascending:true});
      allBalls = balls||[];
      shown=0; commFeed.innerHTML=""; updateMini([]); setButtons();

      titleEl.textContent = `${names[m.home_team_id]||"Home"} vs ${names[m.away_team_id]||"Away"}`;
      const when = m.kickoff_at || (m.date && m.start_time ? `${m.date}T${m.start_time}` : null);
      replayDate.textContent = when ? fmtDateTime(when) : "--";
      subEl.textContent = `Kickoff ‚Äî ${when?fmtDateTime(when):"--"}`;

      const t1=totals(allBalls,1), t2=totals(allBalls,2);
      headlineA.textContent = `${names[m.home_team_id]||"Home"} ${t1.runs}/${t1.wkts} (${oversTxt(t1.balls)} ov)`;
      headlineB.textContent = `${names[m.away_team_id]||"Away"} ${t2.runs}/${t2.wkts} (${oversTxt(t2.balls)} ov)`;

      in1Name.textContent = `${names[m.home_team_id]||"Home"} ‚Äî Innings 1`;
      in2Name.textContent = `${names[m.away_team_id]||"Away"} ‚Äî Innings 2`;
      in1Tot.textContent = `${t1.runs}/${t1.wkts} in ${oversTxt(t1.balls)} ov`;
      in2Tot.textContent = `${t2.runs}/${t2.wkts} in ${oversTxt(t2.balls)} ov`;

      const batAgg1=aggBat(allBalls,1), batAgg2=aggBat(allBalls,2);
      const dm1=dismissalMap(allBalls,1), dm2=dismissalMap(allBalls,2);
      rowBat(bat1, batAgg1, dm1); rowBat(bat2, batAgg2, dm2);

      const bowlAgg1=aggBowl(allBalls,1), bowlAgg2=aggBowl(allBalls,2);
      rowBowl(bowl1, bowlAgg1); rowBowl(bowl2, bowlAgg2);

      const homeName=names[m.home_team_id]||"Home";
      const awayName=names[m.away_team_id]||"Away";
      const homeRuns=m.result?.home?.runs ?? t1.runs;
      const awayRuns=m.result?.away?.runs ?? t2.runs;
      const winner=m.result?.winner ?? (homeRuns>awayRuns?"home":awayRuns>homeRuns?"away":"tie");
      resLine.textContent = winner==="tie" ? `Match tied ‚Äî ${homeName} ${homeRuns}, ${awayName} ${awayRuns}` : `${winner==="home"?homeName:awayName} won the match`;

      sumHomeName.textContent=homeName; sumAwayName.textContent=awayName;
      sumHomeScore.textContent=`${homeRuns} (${oversTxt(t1.balls)} ov)`;
      sumAwayScore.textContent=`${awayRuns} (${oversTxt(t2.balls)} ov)`;

      /* Top performers */
      function topBattersFor(teamId, maps){
        const comb={}; for(const map of maps){ for(const [pid,st] of Object.entries(map)){ const c=comb[pid] ||= {r:0,b:0}; c.r+=st.r; c.b+=st.b; } }
        return Object.entries(comb)
          .filter(([pid])=>players[pid]?.team_id===teamId)
          .map(([pid,st])=>({pid, r:st.r, b:st.b, sr:st.b?st.r/st.b*100:0}))
          .sort((a,b)=> b.r - a.r || b.sr - a.sr).slice(0,3)
          .map(x=> `${nameWithBadges(x.pid)} ‚Äî ${x.r} (${x.b}), SR ${x.sr.toFixed(1)}`);
      }
      function topBowlersFor(teamId, maps){
        const comb={}; for(const map of maps){ for(const [pid,st] of Object.entries(map)){ const c=comb[pid] ||= {r:0,b:0,w:0}; c.r+=st.r; c.b+=st.b; c.w+=st.w; } }
        return Object.entries(comb)
          .filter(([pid])=>players[pid]?.team_id===teamId)
          .map(([pid,st])=>({pid, w:st.w, eco: st.b? st.r/(st.b/6):0}))
          .sort((a,b)=> b.w - a.w || a.eco - b.eco).slice(0,3)
          .map(x=> `${nameWithBadges(x.pid)} ‚Äî ${x.w} wkts, ${x.eco.toFixed(1)} econ`);
      }
      const tbHome = topBattersFor(m.home_team_id,[batAgg1,batAgg2]);
      const tbAway = topBattersFor(m.away_team_id,[batAgg1,batAgg2]);
      const bwHome = topBowlersFor(m.home_team_id,[bowlAgg1,bowlAgg2]);
      const bwAway = topBowlersFor(m.away_team_id,[bowlAgg1,bowlAgg2]);

      const fill=(ul,items)=>{ ul.innerHTML=""; items.forEach(t=>ul.insertAdjacentHTML("beforeend",`<li>${t}</li>`)); };
      fill(document.getElementById("sum-home-topbat"), tbHome);
      fill(document.getElementById("sum-home-topbowl"), bwHome);
      fill(document.getElementById("sum-away-topbat"), tbAway);
      fill(document.getElementById("sum-away-topbowl"), bwAway);
    }

    loadReplay();
  </script>
</body>
</html>
