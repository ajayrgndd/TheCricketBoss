<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendly Replay ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    .badge-friendly{background:#1b4332;color:#d1fae5;border-color:#24543f}
    .chip-done{background:#334155;color:#e2e8f0;border:1px solid #3b475f;border-radius:6px;padding:4px 10px;font-size:.75rem}
    .muted{opacity:.75}
    .tabs{display:flex;gap:6px;border-bottom:2px solid #1d263a;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}
    .panel{display:none}
    .panel.show{display:block}
    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:12px;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center;vertical-align:top}
    th{background:#192238}
    td.left{text-align:left}
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.05rem}
    .feed{display:flex;flex-direction:column;gap:8px}
    .ball{padding:12px;border:1px dashed #26314b;border-radius:10px;background:#0f1522}
    .ball .head{font-weight:700;margin-bottom:6px}
    .tag{font-size:.7rem;border-radius:6px;padding:2px 8px;border:1px solid #334155;background:#152035;margin-left:8px}
    .wkt{background:#3a0e14;border-color:#521b24;color:#ffd6d6}
    .b4{background:#123d27;border-color:#1c593a;color:#b8ffd6}
    .b6{background:#0e2e57;border-color:#1a4886;color:#cfe8ff}
    .sub{opacity:.9;margin-top:4px}
    /* Skill bar */
    .skillbar{display:flex;gap:2px;margin-top:4px}
    .skillbar .seg{width:6px;height:10px;border-radius:2px;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
    .namecell{display:flex;flex-direction:column;align-items:flex-start;gap:2px}
    .nm{line-height:1.1}
    /* Toss banner */
    .toss-line .toss-banner{background:#222a68;color:#fff;text-align:center;font-weight:bold;padding:10px;margin:8px 0;border-radius:6px;font-size:16px;letter-spacing:.5px}
  </style>
</head>
<body>
<div id="top-bar"></div>
<div class="wrap">
  <div class="head">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="badge badge-friendly">Friendly</span>
      <span id="replay-date" class="muted">--</span>
    </div>
    <span class="chip-done">Completed</span>
  </div>
  <h2 id="match-title">Home vs Away</h2>
  <div class="muted" id="match-sub">Kickoff ‚Äî --</div>
  <div class="tabs" style="margin-top:12px">
    <button id="tab-replay">REPLAY</button>
    <button id="tab-score" class="active">SCORECARD</button>
    <button id="tab-summary">SUMMARY</button>
  </div>
  <!-- REPLAY -->
  <section id="replay-panel" class="panel">
    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btn-play">‚ñ∂ Play</button>
        <button id="btn-pause" disabled>‚è∏ Pause</button>
        <button id="btn-next">‚è© Next ball</button>
        <button id="btn-skip-over">‚è≠ Next over</button>
        <button id="btn-restart">üîÅ Restart</button>
        <div style="flex:1"></div>
        <label>Speed
          <select id="speed">
            <option value="1200">Slow</option>
            <option value="700" selected>Normal</option>
            <option value="350">Fast</option>
          </select>
        </label>
      </div>
    </div>
    <div id="toss-banner-inline"></div>
    <div class="score-strip">
      <div class="big" id="mini-a">0/0 - 0.0 ov</div>
      <div class="big" id="mini-b">0/0 - 0.0 ov</div>
    </div>
    <div class="card"><div id="comm-feed" class="feed"></div></div>
  </section>
  <!-- SCORECARD -->
  <section id="score-panel" class="panel show">
    <div class="card">
      <div id="headline-a" style="font-weight:800;font-size:1.05rem;">‚Äî</div>
      <div id="headline-b" style="font-weight:800;font-size:1.05rem;margin-top:6px;">‚Äî</div>
    </div>
    <div id="sc-in1" class="card">
      <h3 id="in1-name">Innings 1</h3>
      <div class="muted" id="in1-total">--</div>
      <div><strong>Batting</strong></div>
      <table><thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody id="bat1"></tbody></table>
      <h4>Bowling</h4>
      <table><thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead><tbody id="bowl1"></tbody></table>
    </div>
    <div id="sc-in2" class="card">
      <h3 id="in2-name">Innings 2</h3>
      <div class="muted" id="in2-total">--</div>
      <div><strong>Batting</strong></div>
      <table><thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead><tbody id="bat2"></tbody></table>
      <h4>Bowling</h4>
      <table><thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead><tbody id="bowl2"></tbody></table>
    </div>
  </section>
  <!-- SUMMARY -->
  <section id="summary-panel" class="panel">
    <div class="card">
      <h3>Match Summary</h3>
      <div id="result-line" style="margin:6px 0 12px 0;font-weight:700"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><div id="sum-home-name" class="muted">Home</div><div id="sum-home-score">--/--</div><ul id="sum-home-topbat"></ul><ul id="sum-home-topbowl"></ul></div>
        <div><div id="sum-away-name" class="muted">Away</div><div id="sum-away-score">--/--</div><ul id="sum-away-topbat"></ul><ul id="sum-away-topbowl"></ul></div>
      </div>
    </div>
  </section>
</div>
<div id="bottom-nav"></div>

<script type="module">
import { loadSmoothUI } from "./js/smooth-ui.js";
loadSmoothUI("top-bar","bottom-nav");
</script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ‚úÖ Toss helpers (copied from friendly-match.html) */
function normalizeTossFromPayload(match){
  if(!match) return null;
  let resultObj=null, simObj=null;
  try{ resultObj=typeof match.result==="string"?JSON.parse(match.result):match.result;}catch{}
  try{ simObj=typeof match.sim_state==="string"?JSON.parse(match.sim_state):match.sim_state;}catch{}
  if(match.toss_winner_team_id||match.toss_decision) return {winner_team_id:match.toss_winner_team_id,decision:match.toss_decision,text:null};
  if(match.toss) return {winner_team_id:match.toss.winner_team_id||match.toss.winner,decision:match.toss.decision||match.toss.elected,text:match.toss.text||null};
  if(resultObj?.toss) return {winner_team_id:resultObj.toss.winner_team_id||resultObj.toss.winner,decision:resultObj.toss.decision||resultObj.toss.elected,text:resultObj.toss.text||null};
  if(simObj?.toss) return {winner_team_id:simObj.toss.winner_team_id||simObj.toss.winner,decision:simObj.toss.decision||simObj.toss.elected,text:simObj.toss.text||null};
  return null;
}
function renderTossBanner(match,list){
  const n=normalizeTossFromPayload(match);
  const cbToss=(list||[]).find(c=>(c.delivery_type||"").toLowerCase()==="toss"&&(c.commentary||"").trim());
  let text=null;
  if(cbToss) text=cbToss.commentary;
  else if(n?.winner_team_id){
    const winner=n.winner_team_id;
    const decision=(n.decision||"bat").toLowerCase();
    const choice=(decision==="bowl"||decision==="field")?"bowl first":"bat first";
    text=`üé≤ Team ${winner} won the toss and chose to ${choice}.`;
  } else if(n?.text) text=n.text;
  const id="toss-banner-inline";
  let c=document.getElementById(id);
  if(!text){ if(c) c.remove(); return; }
  if(!c){ c=document.createElement("div"); c.id=id; c.className="toss-line"; const scoreStrip=document.querySelector(".score-strip"); scoreStrip?.parentNode?.insertBefore(c,scoreStrip);}
  c.innerHTML=`<div class="toss-banner">${text}</div>`;
}
function ensureTossInCommentary(match,arr){
  if(!Array.isArray(arr)) arr=[];
  if(arr.some(c=>(c.delivery_type||"").toLowerCase()==="toss")) return arr;
  const n=normalizeTossFromPayload(match);
  const tossRow={delivery_type:"toss",commentary:n?`Toss: Team ${n.winner_team_id} elected to ${n.decision||"bat"}.`:"Toss not available",innings:0,over_number:0,ball_in_over:0,created_at:new Date().toISOString()};
  return [tossRow,...arr];
}
function filterInitialNoisyLines(arr){
  if(!Array.isArray(arr)) return arr;
  const noise=/comes into the attack/i;
  const firstBall=arr.findIndex(c=>["legal","wide","noball"].includes((c.delivery_type||"").toLowerCase()));
  const cutoff=firstBall===-1?3:firstBall+1;
  return arr.filter((c,i)=>!(i<cutoff&&noise.test(c.commentary||"")));
}

/* ===== The rest of replay logic unchanged, except we call the above helpers in loadReplay ===== */
const qs=new URLSearchParams(location.search); const matchId=qs.get("id");
const supabase=createClient("https://iukofcmatlfhfwcechdq.supabase.co","YOUR-ANON-KEY");
‚Ä¶
// Inside loadReplay after fetching balls:
let balls=await supabase.from("ball_by_ball").select("*").eq("match_id",matchId).order("innings").order("over_number").order("ball_in_over");
allBalls=ensureTossInCommentary(match,balls.data||[]);
allBalls=filterInitialNoisyLines(allBalls);
renderTossBanner(match,allBalls);
‚Ä¶
</script>
</body>
</html>
