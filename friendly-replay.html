<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendly Replay ‚Äì TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:4px 10px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    .badge-friendly{background:#1b4332;color:#d1fae5;border-color:#24543f}
    .chip-done{background:#334155;color:#e2e8f0;border:1px solid #3b475f;border-radius:6px;padding:4px 10px;font-size:.75rem}
    .muted{opacity:.75}
    .tabs{display:flex;gap:6px;border-bottom:2px solid #1d263a;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}
    .panel{display:none}
    .panel.show{display:block}
    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:12px;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center;vertical-align:top}
    th{background:#192238}
    td.left{text-align:left}
    /* compact score tables (SCORECARD only) */
    #score-panel table{font-size:.92rem}
    #score-panel th,#score-panel td{padding:6px}
    @media (max-width:480px){
      #score-panel table{font-size:.88rem}
      #score-panel th,#score-panel td{padding:5px}
    }
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;
      font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.05rem}
    .feed{display:flex;flex-direction:column;gap:8px}
    .ball{padding:12px;border:1px dashed #26314b;border-radius:10px;background:#0f1522}
    .ball .head{font-weight:700;margin-bottom:6px}
    .tag{font-size:.7rem;border-radius:6px;padding:2px 8px;border:1px solid #334155;background:#152035;margin-left:8px}
    .wkt{background:#3a0e14;border-color:#521b24;color:#ffd6d6}
    .b4{background:#123d27;border-color:#1c593a;color:#b8ffd6}
    .b6{background:#0e2e57;border-color:#1a4886;color:#cfe8ff}
    .sub{opacity:.9;margin-top:4px}
    /* Skill bar */
    .skillbar{display:flex;gap:2px;margin-top:4px}
    .skillbar .seg{width:6px;height:10px;border-radius:2px;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
    .namecell{display:flex;flex-direction:column;align-items:flex-start;gap:2px}
    .nm{line-height:1.1}
    /* Toss banner */
    .toss-line .toss-banner{background:#222a68;color:#fff;text-align:center;font-weight:bold;padding:10px;margin:8px 0;border-radius:6px;font-size:16px;letter-spacing:.5px}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <div class="wrap">
    <div class="head">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge badge-friendly">Friendly</span>
        <span id="replay-date" class="muted">--</span>
      </div>
      <span class="chip-done">Completed</span>
    </div>

    <h2 id="match-title">Home vs Away</h2>
    <div class="muted" id="match-sub">Kickoff ‚Äî --</div>

    <div class="tabs" style="margin-top:12px">
      <button id="tab-replay">REPLAY</button>
      <button id="tab-score" class="active">SCORECARD</button>
      <button id="tab-summary">SUMMARY</button>
    </div>

    <section id="replay-panel" class="panel">
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btn-play">‚ñ∂ Play</button>
          <button id="btn-pause" disabled>‚è∏ Pause</button>
          <button id="btn-next">‚è© Next ball</button>
          <button id="btn-skip-over">‚è≠ Next over</button>
          <button id="btn-restart">üîÅ Restart</button>
          <div style="flex:1"></div>
          <label>Speed
            <select id="speed">
              <option value="1200">Slow</option>
              <option value="700" selected>Normal</option>
              <option value="350">Fast</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Toss banner injected here -->
      <div id="toss-banner-inline"></div>

      <div class="score-strip">
        <div class="big" id="mini-a">0/0 - 0.0 ov</div>
        <div class="big" id="mini-b">0/0 - 0.0 ov</div>
      </div>

      <div class="card">
        <div id="comm-feed" class="feed"></div>
      </div>
    </section>

    <section id="score-panel" class="panel show">
      <div class="card">
        <div id="headline-a" style="font-weight:800;font-size:1.05rem;">‚Äî</div>
        <div id="headline-b" style="font-weight:800;font-size:1.05rem;margin-top:6px;">‚Äî</div>
      </div>

      <div id="sc-in1" class="card">
        <h3 id="in1-name">Innings 1</h3>
        <div class="muted" id="in1-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat1"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl1"></tbody>
        </table>
      </div>

      <div id="sc-in2" class="card">
        <h3 id="in2-name">Innings 2</h3>
        <div class="muted" id="in2-total">--</div>
        <div style="margin-top:10px"></div>
        <div><strong>Batting</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="bat2"></tbody>
        </table>
        <div style="height:10px"></div>
        <div><strong>Bowling</strong></div>
        <table style="margin-top:6px">
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="bowl2"></tbody>
        </table>
      </div>
    </section>

    <section id="summary-panel" class="panel">
      <div class="card">
        <h3>Match Summary</h3>
        <div id="result-line" style="margin:6px 0 12px 0;font-weight:700"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-home-name" class="muted">Home</div>
            <div id="sum-home-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-home-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-home-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
          <div style="background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px">
            <div id="sum-away-name" class="muted">Away</div>
            <div id="sum-away-score" style="font-size:1.1rem;font-weight:800">--/--</div>
            <div style="margin-top:8px;font-weight:700">Top Batters</div>
            <ul id="sum-away-topbat" style="margin:6px 0 0 18px;line-height:1.4"></ul>
            <div style="margin-top:8px;font-weight:700">Top Bowlers</div>
            <ul id="sum-away-topbowl" style="margin:6px 0 0 18px;line-height:1.4"></ul>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    loadSmoothUI("top-bar","bottom-nav");
  </script>

  <!-- Replay Logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* bootstrap */
    const qs = new URLSearchParams(location.search);
    const matchId = qs.get("id");

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE",
      { global: { headers: { "x-match-id": matchId ?? "" } } }
    );

    /* tabs */
    const tabs = {
      replay: document.getElementById("tab-replay"),
      score: document.getElementById("tab-score"),
      summary: document.getElementById("tab-summary"),
    };
    const panels = {
      replay: document.getElementById("replay-panel"),
      score: document.getElementById("score-panel"),
      summary: document.getElementById("summary-panel"),
    };
    const activate = (k)=>["replay","score","summary"].forEach(t=>{
      tabs[t].classList.toggle("active", t===k);
      panels[t].classList.toggle("show", t===k);
    });
    activate("score");
    tabs.replay.onclick=()=>activate("replay");
    tabs.score.onclick =()=>activate("score");
    tabs.summary.onclick=()=>activate("summary");

    /* els */
    const titleEl = document.getElementById("match-title");
    const subEl   = document.getElementById("match-sub");
    const replayDate = document.getElementById("replay-date");
    const headlineA = document.getElementById("headline-a");
    const headlineB = document.getElementById("headline-b");
    const in1Name = document.getElementById("in1-name");
    const in2Name = document.getElementById("in2-name");
    const in1Tot  = document.getElementById("in1-total");
    const in2Tot  = document.getElementById("in2-total");
    const bat1 = document.getElementById("bat1");
    const bat2 = document.getElementById("bat2");
    const bowl1 = document.getElementById("bowl1");
    const bowl2 = document.getElementById("bowl2");
    const miniA = document.getElementById("mini-a");
    const miniB = document.getElementById("mini-b");
    const commFeed = document.getElementById("comm-feed");

    const resLine = document.getElementById("result-line");
    const sumHomeName = document.getElementById("sum-home-name");
    const sumHomeScore = document.getElementById("sum-home-score");
    const sumAwayName = document.getElementById("sum-away-name");
    const sumAwayScore = document.getElementById("sum-away-score");
    const sumHomeTopBat = document.getElementById("sum-home-topbat");
    const sumHomeTopBowl = document.getElementById("sum-home-topbowl");
    const sumAwayTopBat = document.getElementById("sum-away-topbat");
    const sumAwayTopBowl = document.getElementById("sum-away-topbowl");

    /* state */
    const roles = {}; // teamId -> {captain, keeper}
    let players = {}; // id -> {name, team_id, batting, bowling?}
    let names = {};   // teamId -> name
    let match = null;
    let allBalls = [];
    let shown = 0;
    let timer = null;
    let delay = 700;

    /* skill helpers */
    const PALETTE = [
      "#f8f532","#f3e61c","#e9d60e","#d4cf10","#b0d022",
      "#7ec14a","#49a769","#2f9ea6","#1d78c6","#1850a1",
      "#1a2f7a","#5d2f7a","#a9483c","#cc1f1f"
    ];
    const boostMap = ()=> (match?.sim_state?.player_boosts) || (match?.sim_state?.boosts) || {};
    function shortName(full){
      if (!full) return "‚Äî";
      const parts = String(full).trim().split(/\s+/).filter(Boolean);
      if (parts.length === 1) return parts[0];
      const last = parts.pop();
      const initials = parts.map(w => (w[0] || "").toUpperCase()).filter(Boolean).join(" ");
      return `${initials} ${last}`;
    }
    function skillScore(pid, kind){
      const p = players[pid]||{};
      const base = kind==="bat" ? Number(p.batting)||0
                  : kind==="bowl" ? Number(p.bowling)||0
                  : Math.max(Number(p.batting)||0, Number(p.bowling)||0);
      const b = Number(boostMap()[pid])||0;
      return Math.max(0, base + b);
    }
    function segmentsFor(score){
      const maxScore = 100;
      const frac = Math.max(0, Math.min(1, score/maxScore));
      let n = Math.round(frac*PALETTE.length);
      return Math.max(1, Math.min(PALETTE.length, n));
    }
    const colorBarHTML = (pid, kind)=>{
      const segs = segmentsFor(skillScore(pid, kind));
      const blocks = PALETTE.slice(0,segs).map(c=>`<span class="seg" style="background:${c}"></span>`).join("");
      return `<div class="skillbar" title="Skill+Boost: ${skillScore(pid,kind).toFixed(1)}">${blocks}</div>`;
    };
    function nameWithBadges(pid){
      if (!pid) return "‚Äî";
      const p = players[pid];
      if (!p) return `Player ${String(pid).slice(0,8)}`;
      const r = roles[p.team_id] || {};
      const tags=[];
      if (r.captain===pid) tags.push("C");
      if (r.keeper===pid)  tags.push("WK");
      const nm = shortName(p.name);
      return `${nm}${tags.length?` (${tags.join(", ")})`:''}`;
    }
    const nameCell = (pid, kind)=>(
      `<div class="namecell">
         <div class="nm">${nameWithBadges(pid)}</div>
         ${colorBarHTML(pid, kind)}
       </div>`
    );

    /* utils */
    const oversTxt = (balls)=>`${Math.floor(balls/6)}.${balls%6}`;
    const overLabel = (ball)=> `${ball.over_number - 1}.${ball.ball_in_over}`;
    function fmtDateTime(ts){
      if(!ts) return "";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24 % 12 || 12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = h24>=12?"PM":"AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${mi} ${ampm}`;
    }

    const isLegal = (b)=> {
      const t = (b.delivery_type||"legal").toLowerCase();
      return t!=="wide" && t!=="noball";
    };

    function totals(list, inn){
      const arr=list.filter(b=>b.innings===inn);
      const legal = arr.filter(isLegal).length;
      return {
        runs: arr.reduce((s,b)=>s+(b.runs_scored||0)+(b.extras||0),0),
        wkts: arr.reduce((s,b)=>s+(b.wicket?1:0),0),
        legal
      };
    }
    function aggBat(list, inn){
      const map={};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.striker_id; if(!id) return;
        const m=map[id] ||= {r:0,b:0,f:0,s:0};
        m.r += b.runs_scored||0;
        if (isLegal(b)) {
          m.b += 1;
          if (b.runs_scored===4) m.f++;
          if (b.runs_scored===6) m.s++;
        }
      }); return map;
    }
    function aggBowl(list, inn){
      const map={};
      list.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.bowler_id; if(!id) return;
        const m=map[id] ||= {r:0,b:0,w:0};
        m.r += (b.runs_scored||0)+(b.extras||0);
        if (isLegal(b)) m.b += 1;
        const t=(b.dismissal_type||"").toLowerCase();
        if (b.wicket && t!=="runout" && t!=="run-out") m.w++;
      }); return map;
    }
    function dismissalMap(list, inn){
      const map={};
      list.filter(b=>b.innings===inn && b.wicket && b.dismissed_batsman_id).forEach(b=>{
        map[b.dismissed_batsman_id] = {
          type:(b.dismissal_type||"").toLowerCase(),
          bowler:b.bowler_id||null,
          fielder:b.fielder_id||null
        };
      }); return map;
    }
    function dismissTextFromBall(b){
      const type=(b.dismissal_type||"").toLowerCase();
      const bow=nameWithBadges(b.bowler_id);
      const fld=nameWithBadges(b.fielder_id);
      if (type==="bowled") return `b ${bow}`;
      if (type==="lbw")    return `lbw b ${bow}`;
      if (type==="caught"){
        if (b.fielder_id && b.bowler_id && b.fielder_id===b.bowler_id) return `c & b ${bow}`;
        if (b.fielder_id) return `c ${fld} b ${bow}`;
        return `c b ${bow}`;
      }
      if (type==="runout"||type==="run-out") return b.fielder_id?`run out (${fld})`:`run out`;
      return bow?`b ${bow}`:"out";
    }

    const VARIANTS={
      0:["Dot ball.","Beaten!","Good length ‚Äî no run."],
      1:["Just a single.","Nudged for one.","Soft hands, one run."],
      2:["They come back for two.","Comfortable two.","Pushed for a brace."],
      3:["All hustle ‚Äî three!","Good running ‚Äî three.","Long chase, three taken."],
      4:["FOUR! Crunched.","Pierces the gap ‚Äî four.","Stroked away for four."],
      6:["SIX! Launched.","Into the stands ‚Äî six!","Clean strike ‚Äî maximum!"],
      W:["Gone! Big breakthrough.","Edged and taken!","Bowled him!"]
    };
    function randomLine(b){
      const c = (b.commentary||"").trim();
      if (c && !/^runs?\s*:/i.test(c) && !/^out!?$/i.test(c)) return c;
      if (b.wicket) return VARIANTS.W[Math.floor(Math.random()*VARIANTS.W.length)];
      const pool = VARIANTS[Math.min(6, Math.max(0, b.runs_scored||0))]||["Runs added."];
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function ballHtml(b, extraLines=[]){
      const head = `Innings ${b.innings} ‚Ä¢ Over ${overLabel(b)}`;
      const bow = nameWithBadges(b.bowler_id);
      const bat = nameWithBadges(b.striker_id);
      const tags=[];
      if (b.wicket) tags.push('<span class="tag wkt">WICKET</span>');
      if (b.runs_scored===4) tags.push('<span class="tag b4">FOUR</span>');
      if (b.runs_scored===6) tags.push('<span class="tag b6">SIX</span>');
      const line = `Runs: ${b.runs_scored||0}, ${randomLine(b)}`;
      const extras = extraLines.length ? `<div class="sub">${extraLines.join("<br/>")}</div>` : "";
      return `
        <div class="ball">
          <div class="head">${head}${tags.join("")}</div>
          <div><strong>${bow}</strong> to <strong>${bat}</strong></div>
          <div>${line}</div>
          ${extras}
        </div>`;
    }

    function updateMini(part){
      const t1=totals(part,1), t2=totals(part,2);
      miniA.textContent = `${t1.runs}/${t1.wkts} - ${oversTxt(t1.legal)} ov`;
      miniB.textContent = `${t2.runs}/${t2.wkts} - ${oversTxt(t2.legal)} ov`;
    }

    /* controls */
    const btnPlay = document.getElementById("btn-play");
    const btnPause = document.getElementById("btn-pause");
    const btnNext = document.getElementById("btn-next");
    const btnOver = document.getElementById("btn-skip-over");
    const btnRestart = document.getElementById("btn-restart");
    const speedSel = document.getElementById("speed");

    function setButtons(){
      const done=shown>=allBalls.length;
      btnPlay.disabled = timer!==null || done;
      btnPause.disabled= timer===null;
      btnNext.disabled = done;
      btnOver.disabled = done;
      btnRestart.disabled = shown===0 && !done;
    }
    function play(){ if(timer||shown>=allBalls.length) return;
      timer=setInterval(()=>{ if(!stepOne()) pause(); },delay); setButtons(); }
    function pause(){ if(timer) clearInterval(timer); timer=null; setButtons(); }
    function restart(){ pause(); shown=0; commFeed.innerHTML=""; updateMini([]); setButtons(); }

    speedSel.onchange=()=>{ delay=parseInt(speedSel.value,10)||700; if(timer){ pause(); play(); } };
    btnPlay.onclick=()=>play(); btnPause.onclick=()=>pause();
    btnNext.onclick=()=>{ stepOne(); setButtons(); };
    btnOver.onclick=()=>{ stepOver(); setButtons(); };
    btnRestart.onclick=()=>{ restart(); };

    const liveBatRuns = new Map();
    function stepOne(){
      if (shown>=allBalls.length) { maybeFinalMessage(); return false; }
      const b=allBalls[shown++];

      const extras = [];
      const prev = allBalls[shown-2] || null;
      const overStart = !prev || prev.innings!==b.innings || prev.over_number!==b.over_number;
      if (overStart) {
        const bow = nameWithBadges(b.bowler_id);
        extras.push(`${bow} comes into the attack.`);
      }

      const dt = (b.delivery_type||"legal").toLowerCase();
      if (dt === "wide")   extras.push(`Wide ‚Äî +${b.extras||1}`);
      if (dt === "noball") extras.push(`No-ball ‚Äî +${b.extras||1}`);
      if (dt === "bye" && (b.extras_detail?.byes)) extras.push(`Byes ‚Äî +${b.extras_detail.byes}`);

      const prevRuns = liveBatRuns.get(b.striker_id) || 0;
      const newRuns = prevRuns + (b.runs_scored||0);
      liveBatRuns.set(b.striker_id, newRuns);
      if (newRuns >= 50 && prevRuns < 50 && newRuns < 100) {
        extras.push(`${nameWithBadges(b.striker_id)} scores his FIFTY`);
      } else if (newRuns >= 100 && prevRuns < 100) {
        extras.push(`${nameWithBadges(b.striker_id)} scores his HUNDRED`);
      }

      if (b.wicket) {
        const disTxt = dismissTextFromBall(b);
        const outPid = b.dismissed_batsman_id || b.striker_id;
        const outName = nameWithBadges(outPid);
        const faced = allBalls.slice(0, shown)
          .filter(x=>x.innings===b.innings && x.striker_id===outPid && isLegal(x)).length;
        const runs  = liveBatRuns.get(outPid) || 0;
        extras.push(`${outName} ${disTxt} ${runs}(${faced})`);
        const nextBall = allBalls[shown] || null;
        if (nextBall && nextBall.innings===b.innings) {
          const newcomer = nextBall.striker_id !== outPid && nextBall.striker_id !== (prev?.striker_id) ? nextBall.striker_id : nextBall.non_striker_id;
          if (newcomer) extras.push(`${nameWithBadges(newcomer)} comes in to the Crease.`);
        }
      }

      commFeed.insertAdjacentHTML("afterbegin", ballHtml(b, extras));
      updateMini(allBalls.slice(0,shown));

      const next = allBalls[shown] || null;
      if (!next || next.innings !== b.innings) {
        if (b.innings===1) {
          const t1 = totals(allBalls,1);
          const need = (t1.runs+1);
          const ballsLeft = 120;
          const teamB = names[match.away_team_id] || "Team B";
          commFeed.insertAdjacentHTML("afterbegin",
            `<div class="ball"><div class="head">End of Innings 1</div><div>${teamB} required ${need} runs from ${ballsLeft} balls to win</div></div>`);
        }
      }

      if (shown>=allBalls.length) {
        maybeFinalMessage();
        return false;
      }
      return true;
    }

    function maybeFinalMessage(){
      const t1=totals(allBalls,1), t2=totals(allBalls,2);
      const homeName=names[match.home_team_id]||"Home";
      const awayName=names[match.away_team_id]||"Away";
      let msg="";
      if (t1.runs>t2.runs){
        const margin = t1.runs - t2.runs;
        msg = `${homeName} win by ${margin} runs`;
      } else if (t2.runs>t1.runs){
        const wktsLeft = 10 - t2.wkts;
        msg = `${awayName} win by ${wktsLeft} wickets`;
      } else {
        msg = "Match tied";
      }
      commFeed.insertAdjacentHTML("afterbegin", `<div class="ball"><div class="head">END of the MATCH</div><div>${msg}</div></div>`);
      setButtons();
    }

    function stepOver(){
      if (shown>=allBalls.length) { maybeFinalMessage(); return; }
      const curr=allBalls[shown]; if(!curr) return;
      const tgtInn=curr.innings, tgtOver=curr.over_number+1;
      while(shown<allBalls.length){
        const b=allBalls[shown];
        if (!stepOne()) break;
        if (b.innings===tgtInn && b.over_number===tgtOver) break;
      }
    }

    /* Toss helpers */
    function normalizeTossFromPayload(match) {
      if (!match) return null;
      let resultObj = null, simObj = null;
      try { resultObj = typeof match.result === 'string' ? JSON.parse(match.result) : match.result; } catch(e){ resultObj = null; }
      try { simObj = typeof match.sim_state === 'string' ? JSON.parse(match.sim_state) : match.sim_state; } catch(e){ simObj = null; }

      if (match.toss_winner_team_id || match.toss_decision) {
        return { winner_team_id: match.toss_winner_team_id || null, decision: match.toss_decision || null, text: null };
      }
      if (match.toss) {
        return { winner_team_id: match.toss.winner_team_id || match.toss.winner || null, decision: match.toss.decision || match.toss.elected || null, text: match.toss.text || null };
      }
      if (resultObj && resultObj.toss) {
        const rt = resultObj.toss;
        return { winner_team_id: rt.winner_team_id || rt.winner || null, decision: rt.decision || rt.elected || null, text: rt.text || null };
      }
      if (simObj && simObj.toss) {
        const st = simObj.toss;
        return { winner_team_id: st.winner_team_id || st.winner || null, decision: st.decision || st.elected || null, text: st.text || null };
      }
      return null;
    }

    function renderTossBanner(matchRow, commentaryList) {
      const normalized = normalizeTossFromPayload(matchRow);

      const cbToss = (commentaryList||[]).find(c => (c.delivery_type||'').toLowerCase() === 'toss' && (c.commentary || '').trim());
      let text = null;
      if (cbToss && cbToss.commentary && !/^toss not available$/i.test(String(cbToss.commentary).trim())) {
        text = cbToss.commentary;
      } else if (normalized && normalized.winner_team_id) {
        const winnerId = normalized.winner_team_id;
        const decisionText = (normalized.decision || 'bat').toLowerCase() === 'bowl' || (normalized.decision||'').toLowerCase() === 'field' ? 'bowl first' : 'bat first';
        const winnerName = names[winnerId] || winnerId;
        text = `üé≤ ${winnerName} won the toss and chose to ${decisionText}.`;
      } else if (normalized && normalized.text) {
        text = normalized.text;
        if (!/üé≤/.test(text)) text = `üé≤ ${text}`;
      } else {
        text = null;
      }

      const bannerContainerId = 'toss-banner-inline';
      let container = document.getElementById(bannerContainerId);
      const scoreStrip = document.querySelector('.score-strip');
      if (!text) {
        if (container && container.parentNode) container.parentNode.removeChild(container);
        return;
      }
      if (!container) {
        container = document.createElement('div');
        container.id = bannerContainerId;
        container.className = 'toss-line';
        if (scoreStrip && scoreStrip.parentNode) scoreStrip.parentNode.insertBefore(container, scoreStrip);
        else (document.querySelector('.wrap') || document.body).insertBefore(container, (document.querySelector('.wrap')||document.body).firstChild);
      }
      container.innerHTML = `<div class="toss-banner">${text}</div>`;
    }

    function ensureTossInCommentary(matchRow, commentaryArray) {
      if (!Array.isArray(commentaryArray)) commentaryArray = [];
      if (commentaryArray.some(c => (c.delivery_type||'').toLowerCase() === 'toss')) return commentaryArray;

      const normalized = normalizeTossFromPayload(matchRow);
      let text = 'Toss not available';
      if (normalized && normalized.winner_team_id) {
        const friendly = names[normalized.winner_team_id] || `Team ${String(normalized.winner_team_id).slice(0,8)}`;
        text = `Toss: ${friendly} won the toss and elected to ${normalized.decision || 'bat'}.`;
      } else if (matchRow?.result?.toss?.text) {
        text = matchRow.result.toss.text;
      } else if (matchRow?.sim_state?.toss?.text) {
        text = matchRow.sim_state.toss.text;
      }

      const tossRow = {
        match_id: matchRow?.id,
        over_number: 0,
        ball_in_over: 0,
        innings: 0,
        striker_id: null,
        non_striker_id: null,
        bowler_id: null,
        runs_scored: 0,
        extras: 0,
        wicket: false,
        dismissed_batsman_id: null,
        commentary: text,
        created_at: new Date(Date.now() - 1000).toISOString(),
        fielder_id: null,
        delivery_type: 'toss',
        extras_detail: {}
      };

      return [tossRow, ...commentaryArray];
    }

    function filterInitialNoisyLines(commentaryArray) {
      if (!Array.isArray(commentaryArray)) return commentaryArray;
      const firstRealIdx = commentaryArray.findIndex(c => {
        const dt = (c.delivery_type || '').toLowerCase();
        if (dt === 'toss') return false;
        if (['legal','wide','noball','bye'].includes(dt)) return true;
        if (typeof c.over_number === 'number' && c.over_number > 0) return true;
        return false;
      });
      const cutoff = firstRealIdx === -1 ? 3 : firstRealIdx + 1;
      const noiseRegex = /\bcomes into the attack\b/i;
      return commentaryArray.filter((c, i) => {
        if (i < cutoff && typeof c.commentary === 'string' && noiseRegex.test(c.commentary)) {
          return false;
        }
        return true;
      });
    }

    /* Data load + render (with battingFirst mapping fix) */
    async function loadReplay(){
      if(!matchId){ alert("Missing match id"); return; }

      const { data:m } = await supabase.from("matches").select("*").eq("id", matchId).maybeSingle();
      if(!m){ alert("Match not found"); return; }
      match=m;

      const { data:teams } = await supabase.from("teams").select("id,team_name").in("id",[m.home_team_id,m.away_team_id]);
      (teams||[]).forEach(t=> names[t.id]=t.team_name);

      const { data:ps } = await supabase.from("players").select("id,name,team_id,batting,bowling").in("team_id",[m.home_team_id,m.away_team_id]);
      (ps||[]).forEach(p=> players[p.id]={ name:p.name, team_id:p.team_id, batting:p.batting, bowling:p.bowling });

      const { data:lus } = await supabase.from("lineups").select("team_id,captain,keeper").in("team_id",[m.home_team_id,m.away_team_id]);
      (lus||[]).forEach(l=> roles[l.team_id]={ captain:l.captain, keeper:l.keeper });

      const { data:balls } = await supabase
        .from("ball_by_ball")
        .select("*")
        .eq("match_id", matchId)
        .order("innings",{ascending:true})
        .order("over_number",{ascending:true})
        .order("ball_in_over",{ascending:true})
        .order("created_at",{ascending:true});

      let fetched = (balls || []).slice();
      fetched = ensureTossInCommentary(match, fetched);
      fetched = filterInitialNoisyLines(fetched);

      allBalls = fetched.sort((a,b)=>{
        if ((a.delivery_type||'').toLowerCase() === 'toss' && (b.delivery_type||'').toLowerCase() !== 'toss') return -1;
        if ((b.delivery_type||'').toLowerCase() === 'toss' && (a.delivery_type||'').toLowerCase() !== 'toss') return 1;
        if ((a.innings||0) !== (b.innings||0)) return (a.innings||0)-(b.innings||0);
        if ((a.over_number||0) !== (b.over_number||0)) return (a.over_number||0)-(b.over_number||0);
        if ((a.ball_in_over||0) !== (b.ball_in_over||0)) return (a.ball_in_over||0)-(b.ball_in_over||0);
        const ta = new Date(a.created_at || 0).getTime();
        const tb = new Date(b.created_at || 0).getTime();
        return ta - tb;
      });

      // Determine battingFirst and battingSecond robustly using toss / innings / result
      let battingFirst = m.home_team_id;
      let battingSecond = m.away_team_id;
      const normalized = normalizeTossFromPayload(m);
      if (normalized && normalized.winner_team_id) {
        const winner = String(normalized.winner_team_id);
        const decision = (normalized.decision||'').toLowerCase();
        const home = String(m.home_team_id);
        const away = String(m.away_team_id);
        if (decision === 'bowl' || decision === 'field') {
          // winner bowled first -> other team batted first
          if (winner === home) { battingFirst = m.away_team_id; battingSecond = m.home_team_id; }
          else { battingFirst = m.home_team_id; battingSecond = m.away_team_id; }
        } else {
          if (winner === home) { battingFirst = m.home_team_id; battingSecond = m.away_team_id; }
          else { battingFirst = m.away_team_id; battingSecond = m.home_team_id; }
        }
      } else if (Array.isArray(m.innings) && m.innings.length >= 2 && m.innings[0].team_id) {
        battingFirst = m.innings[0].team_id;
        battingSecond = m.innings[1].team_id;
      } else if (m.result?.innings && m.result.innings.length >= 2 && m.result.innings[0].team_id) {
        battingFirst = m.result.innings[0].team_id;
        battingSecond = m.result.innings[1].team_id;
      } else {
        // fallback home/away
        battingFirst = m.home_team_id;
        battingSecond = m.away_team_id;
      }

      shown=0; commFeed.innerHTML=""; updateMini([]); setButtons();
      liveBatRuns.clear();

      titleEl.textContent = `${names[m.home_team_id]||"Home"} vs ${names[m.away_team_id]||"Away"}`;
      const when = m.kickoff_at || (m.date && m.start_time ? `${m.date}T${m.start_time}` : null);
      replayDate.textContent = when ? fmtDateTime(when) : "--";
      subEl.textContent = `Kickoff ‚Äî ${when?fmtDateTime(when):"--"}`;

      const t1=totals(allBalls,1), t2=totals(allBalls,2);

      // Use battingFirst / battingSecond for the score headlines and innings labels
      headlineA.textContent = `${names[battingFirst]||'Team A'} ${t1.runs}/${t1.wkts} (${oversTxt(t1.legal)} ov)`;
      headlineB.textContent = `${names[battingSecond]||'Team B'} ${t2.runs}/${t2.wkts} (${oversTxt(t2.legal)} ov)`;

      in1Name.textContent = `${names[battingFirst]||'Team 1'} ‚Äî Innings 1`;
      in2Name.textContent = `${names[battingSecond]||'Team 2'} ‚Äî Innings 2`;
      in1Tot.textContent = `${t1.runs}/${t1.wkts} in ${oversTxt(t1.legal)} ov`;
      in2Tot.textContent = `${t2.runs}/${t2.wkts} in ${oversTxt(t2.legal)} ov`;

      const batAgg1=aggBat(allBalls,1), batAgg2=aggBat(allBalls,2);
      const dm1=dismissalMap(allBalls,1), dm2=dismissalMap(allBalls,2);
      rowBat(bat1, batAgg1, dm1); rowBat(bat2, batAgg2, dm2);

      const bowlAgg1=aggBowl(allBalls,1), bowlAgg2=aggBowl(allBalls,2);
      rowBowl(bowl1, bowlAgg1); rowBowl(bowl2, bowlAgg2);

      const homeName=names[m.home_team_id]||"Home";
      const awayName=names[m.away_team_id]||"Away";
      const homeRuns=m.result?.home?.runs ?? t1.runs;
      const awayRuns=m.result?.away?.runs ?? t2.runs;
      const winner=m.result?.winner ?? (homeRuns>awayRuns?"home":awayRuns>homeRuns?"away":"tie");
      resLine.textContent = winner==="tie" ? `Match tied ‚Äî ${homeName} ${homeRuns}, ${awayName} ${awayRuns}` : `${winner==="home"?homeName:awayName} won the match`;
      sumHomeName.textContent=homeName; sumAwayName.textContent=awayName;
      sumHomeScore.textContent=`${homeRuns} (${oversTxt(t1.legal)} ov)`;
      sumAwayScore.textContent=`${awayRuns} (${oversTxt(t2.legal)} ov)`;

      function topBattersFor(teamId, maps){
        const comb={}; for(const map of maps){ for(const [pid,st] of Object.entries(map)){ const c=comb[pid] ||= {r:0,b:0}; c.r+=st.r; c.b+=st.b; } }
        return Object.entries(comb)
          .filter(([pid])=>players[pid]?.team_id===teamId)
          .map(([pid,st])=>({pid, r:st.r, b:st.b, sr:st.b?st.r/st.b*100:0}))
          .sort((a,b)=> b.r - a.r || b.sr - a.sr).slice(0,3)
          .map(x=> `${nameWithBadges(x.pid)} ‚Äî ${x.r} (${x.b}), SR ${x.sr.toFixed(1)}`);
      }
      function topBowlersFor(teamId, maps){
        const comb={}; for(const map of maps){ for(const [pid,st] of Object.entries(map)){ const c=comb[pid] ||= {r:0,b:0,w:0}; c.r+=st.r; c.b+=st.b; c.w+=st.w; } }
        return Object.entries(comb)
          .filter(([pid])=>players[pid]?.team_id===teamId)
          .map(([pid,st])=>({pid, w:st.w, eco: st.b? st.r/(st.b/6):0}))
          .sort((a,b)=> b.w - a.w || a.eco - b.eco).slice(0,3)
          .map(x=> `${nameWithBadges(x.pid)} ‚Äî ${x.w} wkts, ${x.eco.toFixed(1)} econ`);
      }
      const tbHome = topBattersFor(m.home_team_id,[batAgg1,batAgg2]);
      const tbAway = topBattersFor(m.away_team_id,[batAgg1,batAgg2]);
      const bwHome = topBowlersFor(m.home_team_id,[bowlAgg1,bowlAgg2]);
      const bwAway = topBowlersFor(m.away_team_id,[bowlAgg1,bowlAgg2]);

      const fill=(ul,items)=>{ ul.innerHTML=""; items.forEach(t=>ul.insertAdjacentHTML("beforeend",`<li>${t}</li>`)); };
      fill(document.getElementById("sum-home-topbat"), tbHome);
      fill(document.getElementById("sum-home-topbowl"), bwHome);
      fill(document.getElementById("sum-away-topbat"), tbAway);
      fill(document.getElementById("sum-away-topbowl"), bwAway);

      // Render toss banner now (we have names + commentary)
      renderTossBanner(match, allBalls);
    }

    function rowBat(tbody, map, dm){
      tbody.innerHTML="";
      Object.entries(map).forEach(([pid,st])=>{
        const nmCell = nameCell(pid, "bat");
        const sr = st.b ? ((st.r/st.b)*100).toFixed(1) : "0.0";
        const d = dm[pid];
        let dis = "not out";
        if (d) {
          const bow=nameWithBadges(d.bowler); const fld=nameWithBadges(d.fielder);
          if (d.type==="bowled") dis=`b ${bow}`;
          else if (d.type==="lbw") dis=`lbw b ${bow}`;
          else if (d.type==="caught"){
            if (d.fielder && d.bowler && d.fielder===d.bowler) dis=`c & b ${bow}`;
            else if (d.fielder) dis=`c ${fld} b ${bow}`;
            else dis=`c b ${bow}`;
          } else if (d.type==="runout"||d.type==="run-out") dis=d.fielder?`run out (${fld})`:`run out`;
          else dis=bow?`b ${bow}`:"out";
        }
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nmCell}</td><td class="left">${dis}</td><td>${st.r}</td><td>${st.b}</td><td>${st.f}</td><td>${st.s}</td><td>${sr}</td></tr>`);
      });
    }
    function rowBowl(tbody, map){
      tbody.innerHTML="";
      Object.entries(map).forEach(([pid,st])=>{
        const nmCell = nameCell(pid, "bowl");
        const ov = `${Math.floor(st.b/6)}.${st.b%6}`;
        const eco=st.b?(st.r/(st.b/6)).toFixed(1):"0.0";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td class="left">${nmCell}</td><td>${ov}</td><td>${st.r}</td><td>${st.w}</td><td>${eco}</td></tr>`);
      });
    }

    loadReplay();
  </script>
</body>
</html>
