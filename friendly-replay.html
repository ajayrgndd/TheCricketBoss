<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(https://iukofcmatlfhfwcechdq.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE);
const matchId = new URLSearchParams(location.search).get('id');

const feed = document.getElementById('feed');
let balls = [], i = 0, playing = false, timer;

function line(b){ 
  const d = document.createElement('div'); 
  d.textContent = `I${b.innings} ${b.over_number}.${b.ball_in_over}: ${b.commentary ?? `Runs ${b.runs_scored}${b.wicket?' + W':''}`}`;
  feed.prepend(d);
}
function play(){ if(!playing){ playing = true; step(); } }
function pause(){ playing=false; if(timer) clearTimeout(timer); }
function skip(n){ i = Math.min(balls.length, i+n); }
function step(){
  if(i >= balls.length){ playing=false; return; }
  line(balls[i++]);
  timer = setTimeout(step, 350); // playback speed
}

(async () => {
  // ensure match completed (public replay)
  const { data: m } = await supabase.from('matches').select('status').eq('id', matchId).single();
  if (!m || m.status !== 'completed') {
    feed.textContent = 'Replay not available yet.'; return;
  }

  const { data } = await supabase
    .from('ball_by_ball')
    .select('innings,over_number,ball_in_over,runs_scored,wicket,commentary')
    .eq('match_id', matchId)
    .order('innings').order('over_number').order('ball_in_over');

  balls = data ?? [];
})();
</script>

<div class="controls">
  <button onclick="play()">▶️</button>
  <button onclick="pause()">⏸</button>
  <button onclick="skip(6)">⏭ next over</button>
</div>
<div id="feed" style="height:60vh;overflow:auto;display:flex;flex-direction:column-reverse"></div>
