<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile ‚Äì TheCricketBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    body {
      background: #1e1b3a;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
    }
    .main {
      padding: 80px 16px 90px;
      max-width: 700px;
      margin: auto;
    }
    h2 {
      margin-bottom: 20px;
      text-align: center;
    }
    .profile-info {
      background: #2d2a4a;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .profile-info div {
      margin-bottom: 10px;
    }
    .label {
      color: #bbb;
      font-size: 14px;
    }
    .value {
      font-size: 16px;
      font-weight: bold;
      color: #00e676;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }
    .actions button {
      padding: 10px 16px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #00e676;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="main">
    <h2>üë§ Manager Profile</h2>
    <div class="profile-info">
      <div><span class="label">Manager Name:</span><br><span id="managerName" class="value">...</span></div>
      <div><span class="label">Date of Birth:</span><br><span id="dob" class="value">...</span></div>
      <div><span class="label">Manager Level:</span><br><span id="level" class="value">...</span></div>
      <div><span class="label">XP Progress:</span><br><progress id="xpProgress" value="0" max="100"></progress></div>
      <div><span class="label">Avg Squad Age:</span><br><span id="avgAge" class="value">...</span></div>
      <div><span class="label">Total Team Value:</span><br><span id="teamValue" class="value">...</span></div>
    </div>

    <div class="actions">
      <button onclick="window.location.href='change-password.html'">Change Password</button>
      <button onclick="document.getElementById('logoInput').click()">Change Team Logo</button>
      <input type="file" id="logoInput" accept="image/*" style="display:none" />
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { loadSharedUI } from "./js/shared-ui.js";

    const supabase = createClient("https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE");

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) location.href = "login.html";

    const { data: profile } = await supabase
      .from("profiles")
      .select("*")
      .eq("user_id", user.id)
      .single();

    const { data: team } = await supabase
      .from("teams")
      .select("*")
      .eq("owner_id", user.id)
      .single();

    const { data: players } = await supabase
      .from("players")
      .select("age_years, age_days, market_value")
      .eq("team_id", team.id);

    // Load shared top/bottom UI
    loadSharedUI({
      manager_name: profile.manager_name,
      xp: profile.xp ?? 0,
      coins: profile.coins ?? 0,
      cash: profile.cash ?? 0
    });

    // Set Manager info
    document.getElementById("managerName").textContent = profile.manager_name;
    document.getElementById("dob").textContent = profile.dob || "N/A";
    document.getElementById("level").textContent = profile.level || "Beginner";

    // XP Progress Bar
    const currentXP = profile.xp || 0;
    const levelXP = {
      "Beginner": 0,
      "Expert": 250,
      "Professional": 750,
      "Master": 1750,
      "Supreme": 3500,
      "World Class": 5500,
      "Ultimate": 8500,
      "The Boss": 10000
    };

    const level = profile.level || "Beginner";
    const nextLevel = Object.entries(levelXP).find(([lvl, xp]) => xp > currentXP);
    const maxXP = nextLevel ? nextLevel[1] : currentXP + 1000;
    const progress = ((currentXP - levelXP[level]) / (maxXP - levelXP[level])) * 100;

    document.getElementById("xpProgress").value = progress;
    document.getElementById("xpProgress").max = 100;

    // Average Age Calculation
    if (players?.length > 0) {
      let totalYears = 0;
      players.forEach(p => {
        totalYears += (p.age_years + p.age_days / 63);
      });
      const avg = totalYears / players.length;
      document.getElementById("avgAge").textContent = `${avg.toFixed(1)} yrs`;
    }

    // Total Team Value = market_value sum + virtual_cash + coins*10 + xp/100
    const playerValue = players.reduce((sum, p) => sum + (p.market_value || 0), 0);
    const totalValue = playerValue + (profile.cash || 0) + (profile.coins * 10) + Math.floor(profile.xp / 100);
    document.getElementById("teamValue").textContent = `‚Çπ${totalValue.toLocaleString()}`;

    // Logo upload
    document.getElementById("logoInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const fileName = `team-logos/${user.id}-${Date.now()}.png`;
      const { error: uploadErr } = await supabase.storage
        .from("public")
        .upload(fileName, file, {
          contentType: file.type,
          upsert: true
        });

      if (uploadErr) {
        alert("‚ùå Upload failed.");
        return;
      }

      const logoUrl = `https://iukofcmatlfhfwcechdq.supabase.co/storage/v1/object/public/public/${fileName}`;

      await supabase
        .from("teams")
        .update({ logo_url: logoUrl })
        .eq("id", team.id);

      alert("‚úÖ Logo updated!");
    });

    // Logout
    async function logout() {
      await supabase.auth.signOut();
      location.href = "login.html";
    }
  </script>
</body>
</html>
