<div class="wrap">
  <h3>Live</h3><div id="live"></div>
  <h3>Upcoming</h3><div id="upcoming"></div>
  <h3>Completed</h3><div id="completed"></div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(https://iukofcmatlfhfwcechdq.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE);

const el = (id) => document.getElementById(id);
const row = (m) => {
  const d = document.createElement('div');
  d.style.padding='8px'; d.style.border='1px solid #26314b'; d.style.borderRadius='10px'; d.style.margin='6px 0';
  d.textContent = `${m.home_team_id} vs ${m.away_team_id} • ${m.status} • ${new Date(m.kickoff_at||m.date).toLocaleString()}`;
  if (m.status==='running') { d.style.borderColor='#2aa'; d.style.fontWeight='600'; d.onclick=()=>location.href=`friendly-match.html?id=${m.id}`; }
  if (m.status==='completed') { d.onclick=()=>location.href=`friendly-replay.html?id=${m.id}`; }
  return d;
};

(async () => {
  // find my team
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user) { location.href='login.html'; return; }
  const { data: myTeam } = await supabase.from('teams').select('id').eq('owner_id', user.id).maybeSingle();
  if(!myTeam){ alert('Team not found'); return; }

  // fetch my friendlies (RLS lets you see your own + all completed if you enabled that policy)
  const { data } = await supabase
    .from('matches')
    .select('id,status,kickoff_at,date,start_time,home_team_id,away_team_id,is_friendly')
    .or(`home_team_id.eq.${myTeam.id},away_team_id.eq.${myTeam.id}`)
    .eq('is_friendly', true)
    .order('kickoff_at', { ascending:false })
    .limit(50);

  const upcoming = (data||[]).filter(m=>m.status==='scheduled');
  const live     = (data||[]).filter(m=>m.status==='running');
  const done     = (data||[]).filter(m=>m.status==='completed');

  el('upcoming').innerHTML=''; upcoming.forEach(m=>el('upcoming').appendChild(row(m)));
  el('live').innerHTML='';     live.forEach(m=>el('live').appendChild(row(m)));
  el('completed').innerHTML='';done.forEach(m=>el('completed').appendChild(row(m)));

  // realtime updates
  supabase.channel('matches-friendlies')
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'matches',
      filter:`home_team_id=eq.${myTeam.id}` }, ()=>location.reload())
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'matches',
      filter:`away_team_id=eq.${myTeam.id}` }, ()=>location.reload())
    .subscribe();
})();
</script>
