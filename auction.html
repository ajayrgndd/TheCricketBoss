<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Auction â€“ TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    .auction-header, .auction-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .player-card {
      background: #2b2d42;
      color: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .player-card h3 {
      margin: 0 0 8px;
      color: #00e676;
    }

    .countdown {
      font-weight: bold;
      color: #ffea00;
    }

    .manual-refresh {
      margin-left: auto;
    }

    .filter-select {
      margin-right: 8px;
      padding: 4px 8px;
    }

    .bid-btn {
      background-color: #00b0ff;
      border: none;
      padding: 6px 12px;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }

    .bid-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    @media (max-width: 600px) {
      .auction-header, .auction-actions {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="auction-header">
      <h2>Live Auction</h2>
      <button id="manualRefreshBtn" class="manual-refresh">ðŸ”„ Refresh</button>
    </div>

    <div class="filters-bar">
      <select id="filterSkill" class="filter-select">
        <option value="">All Skills</option>
        <option value="Newbie">Newbie</option>
        <option value="Trainee">Trainee</option>
        <option value="Domestic">Domestic</option>
        <option value="National">National</option>
        <option value="World">World</option>
        <option value="The Boss">The Boss</option>
      </select>
      <select id="filterType" class="filter-select">
        <option value="">All Roles</option>
        <option value="Batsman">Batsman</option>
        <option value="Bowler">Bowler</option>
        <option value="All-Rounder">All-Rounder</option>
        <option value="Wicket Keeper">Wicket Keeper</option>
      </select>
      <select id="filterRegion" class="filter-select">
        <option value="">All Regions</option>
        <option value="India">India</option>
        <option value="Australia">Australia</option>
        <!-- Add more -->
      </select>
      <button onclick="clearFilters()">Clear</button>
    </div>

    <div id="auctionContainer"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import { loadSharedUI, showNotification } from './js/shared-ui.js';

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const container = document.getElementById("auctionContainer");

    document.getElementById("manualRefreshBtn").onclick = loadAuction;

    let auctionData = [];

    async function loadAuction() {
      const now = new Date().toISOString();

      const { data } = await supabase
        .from("auction")
        .select("*, players(*)")
        .gt("ends_at", now)
        .order("ends_at", { ascending: true });

      auctionData = data || [];
      renderAuction();
    }

    function renderAuction() {
      container.innerHTML = "";

      const skill = document.getElementById("filterSkill").value;
      const type = document.getElementById("filterType").value;
      const region = document.getElementById("filterRegion").value;

      const filtered = auctionData.filter(item => {
        const p = item.players;
        return (!skill || p.skill_level === skill)
          && (!type || p.role === type)
          && (!region || p.region === region);
      });

      for (const entry of filtered) {
        const p = entry.players;
        const endsAt = new Date(entry.ends_at);
        const now = new Date();
        const diff = Math.max(0, (endsAt - now) / 1000);
        const mins = Math.floor(diff / 60);
        const secs = Math.floor(diff % 60);
        const countdown = `${mins}:${secs.toString().padStart(2, "0")}`;
        const nextBid = Math.ceil(entry.current_price * 1.02);

        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `
          <h3>${p.name}</h3>
          <p>Role: ${p.role}</p>
          <p>Skill: ${p.skill_level}</p>
          <p>Age: ${p.age_years}y</p>
          <p>Region: ${p.region}</p>
          <p>Market Price: â‚¹${p.market_price.toLocaleString()}</p>
          <p>Current Bid: â‚¹${entry.current_price.toLocaleString()}</p>
          <p class="countdown">Ends in: ${countdown}</p>
          <button class="bid-btn" onclick="placeBid('${entry.id}', ${nextBid})">
            Place Bid â‚¹${nextBid.toLocaleString()}
          </button>
        `;
        container.appendChild(card);
      }
    }

    window.placeBid = async (auction_id, amount) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("Login required!");
        return;
      }

      const { error } = await supabase
        .from("auction_bids")
        .insert([{ auction_id, bidder_id: user.id, amount }]);

      if (error) {
        alert("Bid failed: " + error.message);
      } else {
        showNotification("Bid placed successfully!");
        loadAuction();
      }
    };

    function clearFilters() {
      document.getElementById("filterSkill").value = "";
      document.getElementById("filterType").value = "";
      document.getElementById("filterRegion").value = "";
      renderAuction();
    }

    // Auto refresh every 10 seconds
    setInterval(loadAuction, 10000);
    loadAuction();
  </script>
</body>
</html>
