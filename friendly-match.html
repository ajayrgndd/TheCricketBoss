<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Friendly Match – TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>

  <style>
    body { background:#0b0f16; color:#e7ecf3; font-family:system-ui; margin:0; }
    .wrap{max-width:900px;margin:0 auto;padding:16px;}

    /* Tabs */
    .tabs{display:flex;gap:6px;border-bottom:2px solid #222;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}

    /* Score strip */
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;
      color:#000;font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big {font-size:1.2rem}
    .teambar{display:flex;justify-content:space-between;align-items:center;margin:6px 2px 12px 2px;font-size:1.1rem}
    .teambar .t{font-weight:700}

    /* Cards / tables */
    .card{background:#121825;border:1px solid #1d263a;border-radius:10px;padding:10px;margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center}
    th{background:#1a2236}
    .muted{opacity:.75}
    .pill{display:inline-block;font-size:.72rem;border-radius:999px;padding:2px 8px;margin-right:6px;border:1px solid #333}
    .pill-w{background:#991b1b;color:#fff;border-color:#7f1d1d}   /* wicket */
    .pill-6{background:#14532d;color:#d1fae5;border-color:#064e3b}/* six   */
    .pill-4{background:#0f172a;color:#93c5fd;border-color:#1e293b}/* four  */

    /* Commentary line */
    .com-line{padding:10px;border-bottom:1px dashed #1f2a44}
    .com-top{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .ball-tag{background:#0f172a;border:1px solid #1e293b;border-radius:6px;padding:2px 6px;font-size:.75rem;color:#cbd5e1}
    .com-text{line-height:1.45}

    /* Panels */
    .panel{display:none}
    .panel.show{display:block}
  </style>
</head>
<body>
  <!-- Top / Bottom nav -->
  <div id="top-bar"></div>

  <div class="wrap">
    <h2>Friendly Match</h2>

    <div class="tabs">
      <button id="tab-live" class="active">LIVE</button>
      <button id="tab-score">SCORECARD</button>
      <button id="tab-comm">COMMENTARY</button>
    </div>

    <!-- ===== LIVE ===== -->
    <section id="live-panel" class="panel show">
      <div class="score-strip">
        <div class="big" id="live-score-a">--/-- - --.- ov</div>
        <div class="big" id="live-score-b" class="muted">--/-- - --.- ov</div>
      </div>

      <div class="card" id="live-controls" style="display:flex;align-items:center;gap:12px">
        <label style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="autoToggle" checked>
          Auto refresh (2s)
        </label>
        <button id="refreshBtn">Refresh now</button>
        <span id="lastPing" class="muted"></span>
      </div>

      <div class="teambar">
        <div class="t" id="team-a-name">Home</div>
        <div class="t" id="team-b-name">Away</div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px" id="batting-heading">Batting</div>
        <table>
          <thead>
            <tr><th>Batsman</th><th>Runs</th><th>Balls</th><th>4s</th><th>6s</th><th>SR</th></tr>
          </thead>
          <tbody id="live-bats-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">Bowler</div>
        <table>
          <thead>
            <tr><th>Bowler</th><th>Ov.</th><th>Runs</th><th>Wk.</th><th>Econ.</th></tr>
          </thead>
          <tbody id="live-bowl-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">Commentary</div>
        <div id="live-feed"></div>
      </div>
    </section>

    <!-- ===== SCORECARD ===== -->
    <section id="score-panel" class="panel">
      <div class="card">
        <h4>Batting</h4>
        <table>
          <thead><tr><th>Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="score-bat"></tbody>
        </table>
        <h4>Bowling</h4>
        <table>
          <thead><tr><th>Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="score-bowl"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== COMMENTARY ===== -->
    <section id="comm-panel" class="panel">
      <div class="card">
        <div id="comm-feed"></div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    loadSmoothUI('top-bar','bottom-nav');
  </script>

  <!-- Main logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "YOUR_ANON_KEY"
    );

    /* ---------- Tabs ---------- */
    const tabs = {live:tab('live'), score:tab('score'), comm:tab('comm')};
    const panels = {live:panel('live'), score:panel('score'), comm:panel('comm')};
    function tab(k){return document.getElementById('tab-'+k)}
    function panel(k){return document.getElementById(k+'-panel')}
    const activate = (k)=>['live','score','comm'].forEach(x=>{
      tabs[x].classList.toggle('active',x===k); panels[x].classList.toggle('show',x===k);
    });
    tabs.live.onclick=()=>activate('live');
    tabs.score.onclick=()=>activate('score');
    tabs.comm.onclick=()=>activate('comm');

    /* ---------- DOM refs ---------- */
    const qs=new URLSearchParams(location.search); const matchId=qs.get('id');
    const liveFeed=document.getElementById('live-feed');
    const commFeed=document.getElementById('comm-feed');
    const liveBats=document.getElementById('live-bats-tbody');
    const liveBowls=document.getElementById('live-bowl-tbody');
    const scoreA=document.getElementById('live-score-a');
    const scoreB=document.getElementById('live-score-b');
    const teamAName=document.getElementById('team-a-name');
    const teamBName=document.getElementById('team-b-name');
    const battingHeading=document.getElementById('batting-heading');
    const scoreBat=document.getElementById('score-bat');
    const scoreBowl=document.getElementById('score-bowl');
    const lastPing=document.getElementById('lastPing');

    /* ---------- State ---------- */
    let all=[]; let players={}; let homeTeam,awayTeam; let names={};
    let lastSeen=null; let poller=null; const POLL_MS=2000;

    /* ---------- Helpers ---------- */
    const oversText=(balls)=>`${Math.floor(balls/6)}.${balls%6}`;
    function totals(balls,inn){const arr=balls.filter(b=>b.innings===inn);return {
      runs:arr.reduce((s,b)=>s+(b.runs_scored||0)+(b.extras||0),0),
      wkts:arr.reduce((s,b)=>s+(b.wicket?1:0),0),
      legal:arr.length
    };}
    function aggBat(balls,inn){const map={};balls.filter(b=>b.innings===inn).forEach(b=>{
      const id=b.striker_id;if(!id)return;const m=map[id]||={runs:0,balls:0,fours:0,sixes:0};
      m.runs+=(b.runs_scored||0);m.balls++;if(b.runs_scored===4)m.fours=(m.fours||0)+1;if(b.runs_scored===6)m.sixes=(m.sixes||0)+1;map[id]=m;
    });return map;}
    function aggBowl(balls,inn){const map={};balls.filter(b=>b.innings===inn).forEach(b=>{
      const id=b.bowler_id;if(!id)return;const m=map[id]||={runs:0,balls:0,wkts:0};
      m.runs+=(b.runs_scored||0)+(b.extras||0);m.balls++;if(b.wicket)m.wkts++;map[id]=m;
    });return map;}
    function rowBat(pid,st,star=false){const nm=players[pid]?.name||'—';const sr=st.balls?((st.runs/st.balls)*100).toFixed(1):"0.0";
      return `<tr><td style="text-align:left">${nm}${star?' ★':''}</td><td>${st.runs}</td><td>${st.balls}</td><td>${st.fours||0}</td><td>${st.sixes||0}</td><td>${sr}</td></tr>`;}
    function rowBowl(pid,st,star=false){const nm=players[pid]?.name||'—';const ov=oversText(st.balls);const eco=st.balls?(st.runs/(st.balls/6)).toFixed(1):"0.0";
      return `<tr><td style="text-align:left">${nm}${star?' ★':''}</td><td>${ov}</td><td>${st.runs}</td><td>${st.wkts}</td><td>${eco}</td></tr>`;}

    function comLine(b){return `<div class="com-line"><div class="com-top">
      <span class="ball-tag">I${b.innings} ${b.over_number}.${b.ball_in_over}</span></div>
      <div class="com-text">${b.commentary||'Runs: '+b.runs_scored}</div></div>`;}

    function updateLive(){if(!all.length)return;const latest=all[all.length-1];const curInn=latest.innings;
      const t1=totals(all,1);scoreA.textContent=`${t1.runs}/${t1.wkts} - ${oversText(t1.legal)} ov`;
      if(all.some(b=>b.innings===2)){const t2=totals(all,2);scoreB.textContent=`${t2.runs}/${t2.wkts} - ${oversText(t2.legal)} ov`;}
      battingHeading.textContent=`Batting – ${curInn===1?(names[homeTeam]||'Home'):(names[awayTeam]||'Away')}`;
      teamAName.textContent=names[homeTeam]||'Home';teamBName.textContent=names[awayTeam]||'Away';
      const batAgg=aggBat(all,curInn);const strikerId=latest.striker_id,nonId=latest.non_striker_id;
      liveBats.innerHTML=rowBat(strikerId,batAgg[strikerId]||{runs:0,balls:0},true)+rowBat(nonId,batAgg[nonId]||{runs:0,balls:0});
      const bowlAgg=aggBowl(all,curInn);const curBowler=latest.bowler_id;
      let html=rowBowl(curBowler,bowlAgg[curBowler]||{runs:0,balls:0,wkts:0},true);liveBowls.innerHTML=html;}

    function updateScore(){if(!all.length)return;const bats=aggBat(all,1);scoreBat.innerHTML="";Object.entries(bats).forEach(([id,st])=>scoreBat.insertAdjacentHTML('beforeend',rowBat(id,st)));
      const bowls=aggBowl(all,1);scoreBowl.innerHTML="";Object.entries(bowls).forEach(([id,st])=>scoreBowl.insertAdjacentHTML('beforeend',rowBowl(id,st)));}

    /* ---------- Polling ---------- */
    async function fetchNewBalls(){let q=supabase.from('ball_by_ball').select('*').eq('match_id',matchId).order('created_at',{ascending:true});
      if(lastSeen) q=q.gt('created_at',lastSeen);
      const {data}=await q;if(!data||!data.length){lastPing.textContent=`Last update: ${new Date().toLocaleTimeString()}`;return;}
      data.forEach(b=>{all.push(b);liveFeed.insertAdjacentHTML('beforeend',comLine(b));commFeed.insertAdjacentHTML('beforeend',comLine(b));});
      lastSeen=data[data.length-1].created_at;updateLive();updateScore();lastPing.textContent=`Last update: ${new Date().toLocaleTimeString()}`;}
    function startPoll(){stopPoll();poller=setInterval(fetchNewBalls,POLL_MS);}
    function stopPoll(){if(poller)clearInterval(poller);poller=null;}
    document.getElementById('refreshBtn').onclick=fetchNewBalls;
    document.getElementById('autoToggle').onchange=(e)=>{if(e.target.checked)startPoll();else stopPoll();};

    /* ---------- Init ---------- */
    async function init(){const {data:m}=await supabase.from('matches').select('*').eq('id',matchId).single();homeTeam=m.home_team_id;awayTeam=m.away_team_id;
      const {data:t}=await supabase.from('teams').select('id,team_name').in('id',[homeTeam,awayTeam]);(t||[]).forEach(x=>names[x.id]=x.team_name);
      const {data:ps}=await supabase.rpc('get_players_for_match',{p_match:matchId});(ps||[]).forEach(p=>players[p.id]={name:p.name});
      const {data:balls}=await supabase.from('ball_by_ball').select('*').eq('match_id',matchId).order('created_at',{ascending:true});
      all=balls||[];all.forEach(b=>{liveFeed.insertAdjacentHTML('beforeend',comLine(b));commFeed.insertAdjacentHTML('beforeend',comLine(b));});
      if(all.length)lastSeen=all[all.length-1].created_at;updateLive();updateScore();startPoll();}
    init();
  </script>
</body>
</html>
