<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Friendly Match â€“ TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>

  <style>
    body { background:#0b0f16; color:#e7ecf3; font-family:system-ui; margin:0; }
    .wrap{max-width:800px;margin:0 auto;padding:16px;}
    .tabs{display:flex;gap:8px;margin:10px 0;}
    .tabs button{flex:1;padding:10px;background:#111;color:#fff;border:none;border-radius:6px;cursor:pointer;}
    .tabs button.active{background:#00e676;color:#000;}
    .tab-panel{margin-top:10px;}
    table{width:100%;border-collapse:collapse;margin:8px 0;}
    th,td{border:1px solid #333;padding:6px;text-align:center;font-size:.9rem;}
    .ball{padding:6px;border-bottom:1px solid #222;}
  </style>
</head>
<body>
  <!-- Top / Bottom nav -->
  <div id="top-bar"></div>

  <div class="wrap">
    <h2>Friendly Match</h2>

    <div class="tabs">
      <button id="tab-feed" class="active">ðŸ“œ Live Feed</button>
      <button id="tab-score">ðŸ“Š Scoreboard</button>
    </div>

    <!-- Live Feed -->
    <div id="feed-panel" class="tab-panel"></div>

    <!-- Scoreboard -->
    <div id="score-panel" class="tab-panel" style="display:none;">
      <h3>Batting</h3>
      <table id="batting-card">
        <thead>
          <tr><th>Batsman</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3>Bowling</h3>
      <table id="bowling-card">
        <thead>
          <tr><th>Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI loader -->
  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    loadSmoothUI('top-bar','bottom-nav');
  </script>

  <!-- Main logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get("id");

    const allBalls = [];
    let players = {};

    // Tabs
    document.getElementById("tab-feed").onclick = () => {
      document.getElementById("tab-feed").classList.add("active");
      document.getElementById("tab-score").classList.remove("active");
      document.getElementById("feed-panel").style.display = "block";
      document.getElementById("score-panel").style.display = "none";
    };
    document.getElementById("tab-score").onclick = () => {
      document.getElementById("tab-score").classList.add("active");
      document.getElementById("tab-feed").classList.remove("active");
      document.getElementById("feed-panel").style.display = "none";
      document.getElementById("score-panel").style.display = "block";
    };

    function renderBallFeed(balls){
      const box=document.getElementById("feed-panel");
      box.innerHTML="";
      balls.forEach(b=>{
        const d=document.createElement("div");
        d.className="ball";
        d.textContent=`Innings ${b.innings}, Over ${b.over_number}.${b.ball_in_over}: ${b.commentary}`;
        box.appendChild(d);
      });
    }

    function updateScoreboard(balls, players){
      const bats={}, bowls={};
      for(const b of balls){
        // batting
        if(b.striker_id){
          if(!bats[b.striker_id]) bats[b.striker_id]={runs:0,balls:0,fours:0,sixes:0};
          bats[b.striker_id].runs+=b.runs_scored;
          bats[b.striker_id].balls++;
          if(b.runs_scored===4) bats[b.striker_id].fours++;
          if(b.runs_scored===6) bats[b.striker_id].sixes++;
        }
        // bowling
        if(b.bowler_id){
          if(!bowls[b.bowler_id]) bowls[b.bowler_id]={runs:0,balls:0,wkts:0};
          bowls[b.bowler_id].runs+= (b.runs_scored||0)+(b.extras||0);
          bowls[b.bowler_id].balls++;
          if(b.wicket) bowls[b.bowler_id].wkts++;
        }
      }
      // batting table
      const batT=document.querySelector("#batting-card tbody");
      batT.innerHTML="";
      Object.entries(bats).forEach(([pid,st])=>{
        const p=players[pid]||{name:"??"};
        const sr=st.balls?((st.runs/st.balls)*100).toFixed(1):"0.0";
        batT.innerHTML+=`<tr><td>${p.name}</td><td>${st.runs}</td><td>${st.balls}</td><td>${st.fours}</td><td>${st.sixes}</td><td>${sr}</td></tr>`;
      });
      // bowling table
      const bowlT=document.querySelector("#bowling-card tbody");
      bowlT.innerHTML="";
      Object.entries(bowls).forEach(([pid,st])=>{
        const p=players[pid]||{name:"??"};
        const overs=(st.balls/6).toFixed(1);
        const eco=st.balls?(st.runs/(st.balls/6)).toFixed(1):"0.0";
        bowlT.innerHTML+=`<tr><td>${p.name}</td><td>${overs}</td><td>${st.runs}</td><td>${st.wkts}</td><td>${eco}</td></tr>`;
      });
    }

    async function init(){
      if(!matchId){ alert("Missing match id"); return; }
      const { data: balls } = await supabase.from("ball_by_ball")
        .select("*").eq("match_id", matchId).order("innings, over_number, ball_in_over");
      allBalls.push(...(balls||[]));

      renderBallFeed(allBalls);
      updateScoreboard(allBalls, players);

      // load lineup to map players
      const { data: lns } = await supabase.from("lineups")
        .select("playing_xi,team_id,teams!inner(manager_name,team_name,players(id,name))")
        .eq("match_id", matchId);
      if(lns){
        const ps = {};
        lns.forEach(l=>{
          (l.teams?.players||[]).forEach(p=>{ ps[p.id]={name:p.name}; });
        });
        players=ps;
      }

      // realtime sub
      supabase.channel("bb-stream")
        .on("postgres_changes",{event:"INSERT",schema:"public",table:"ball_by_ball",filter:`match_id=eq.${matchId}`},
          (payload)=>{
            allBalls.push(payload.new);
            renderBallFeed(allBalls);
            updateScoreboard(allBalls, players);
          }
        ).subscribe();
    }

    init();
  </script>
</body>
</html>
