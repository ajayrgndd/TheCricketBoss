<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Friendly Match – TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>

  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:900px;margin:0 auto;padding:16px}

    /* Tabs */
    .tabs{display:flex;gap:6px;border-bottom:2px solid #222;position:sticky;top:48px;background:#0b0f16;z-index:5}
    .tabs button{flex:1;padding:10px 8px;background:#10151f;color:#cfe7dc;border:none;border-radius:6px 6px 0 0;cursor:pointer;font-weight:700;letter-spacing:.02em}
    .tabs button.active{background:#00e676;color:#000}

    /* Cards / tables */
    .card{background:#121825;border:1px solid #1d263a;border-radius:10px;padding:10px;margin:10px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #2a344a;padding:8px;text-align:center}
    th{background:#1a2236}
    .left{text-align:left}
    .muted{opacity:.75}

    /* Score strip */
    .score-strip{display:flex;justify-content:space-between;align-items:center;background:#ff7a00;color:#000;font-weight:800;padding:10px 12px;border-radius:8px;margin:10px 0}
    .score-strip .big{font-size:1.2rem}
    .teambar{display:flex;justify-content:space-between;align-items:center;margin:6px 2px 8px 2px;font-size:1.05rem}
    .teambar .t{font-weight:700}

    /* commentary */
    .com-line{padding:12px;border-bottom:1px dashed #1f2a44;background:#0f1522;border-radius:8px;margin-bottom:8px}
    .com-head{font-weight:800;margin-bottom:4px}
    .pill{display:inline-block;font-size:.72rem;border-radius:999px;padding:2px 8px;margin-left:8px;border:1px solid #333}
    .pill-w{background:#991b1b;color:#fff;border-color:#7f1d1d}
    .pill-6{background:#14532d;color:#d1fae5;border-color:#064e3b}
    .pill-4{background:#0f172a;color:#93c5fd;border-color:#1e293b}
    .sub{opacity:.9;margin-top:4px}

    .target-bar{margin-top:8px;font-weight:700;color:#c7f9cc}

    .panel{display:none}
    .panel.show{display:block}

    /* lineup */
    .xi-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .xi-card{background:#10151f;border:1px solid #22304b;border-radius:10px;padding:10px}
    .xi-card h4{margin:0 0 6px 0}
    .tag{display:inline-block;font-size:.7rem;padding:2px 6px;border-radius:6px;margin-left:6px;background:#0f172a;border:1px solid #22304b}

    .toolbar{display:flex;gap:8px;align-items:center}
    .btn{background:#0f172a;border:1px solid #22304b;color:#e7ecf3;border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:default}
    .switch{display:inline-flex;align-items:center;gap:6px;font-size:.9rem}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <div class="wrap">
    <h2>Friendly Match</h2>

    <div class="tabs">
      <button id="tab-live" class="active">LIVE</button>
      <button id="tab-score">SCORECARD</button>
      <button id="tab-comm">COMMENTARY</button>
      <button id="tab-xi">LINEUP</button>
    </div>

    <!-- ===== LIVE ===== -->
    <section id="live-panel" class="panel show">
      <div class="score-strip">
        <div class="big" id="live-score-a">--/-- - --.- ov</div>
        <div class="big" id="live-score-b">--/-- - --.- ov</div>
      </div>

      <div class="teambar">
        <div class="t" id="team-a-name">Home</div>
        <div class="t" id="team-b-name">Away</div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px" id="batting-heading">Batting</div>
        <div id="live-target" class="target-bar" style="display:none"></div>
        <table>
          <thead>
          <tr><th class="left">Batsman</th><th>Runs</th><th>Balls</th><th>4s</th><th>6s</th><th>SR</th></tr>
          </thead>
          <tbody id="live-bats-tbody"></tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">Bowler</div>
        <table>
          <thead>
          <tr><th class="left">Bowler</th><th>Ov.</th><th>Runs</th><th>Wk.</th><th>Econ.</th></tr>
          </thead>
        <tbody id="live-bowl-tbody"></tbody>
        </table>
      </div>

      <div class="card" id="live-summary" style="display:none"></div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Commentary</div>
          <div class="toolbar">
            <label class="switch"><input type="checkbox" id="auto-refresh" checked/> Auto 2s</label>
            <button class="btn" id="btn-refresh">Refresh</button>
          </div>
        </div>
        <div id="live-feed"></div>
      </div>
    </section>

    <!-- ===== SCORECARD ===== -->
    <section id="score-panel" class="panel">
      <div class="card">
        <div id="headline-a" style="font-weight:800;font-size:1.05rem;">—</div>
        <div id="headline-b" style="font-weight:800;font-size:1.05rem;margin-top:6px;">—</div>
        <div id="score-target" class="target-bar" style="display:none"></div>
      </div>

      <div id="score-i1" class="card">
        <div style="font-weight:800;margin-bottom:8px" id="i1-title">Innings 1</div>
        <table>
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="i1-batting"></tbody>
        </table>
        <h4 style="margin-top:12px">Bowling</h4>
        <table>
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="i1-bowling"></tbody>
        </table>
      </div>

      <div id="score-i2" class="card" style="display:none">
        <div style="font-weight:800;margin-bottom:8px" id="i2-title">Innings 2</div>
        <table>
          <thead><tr><th class="left">Batsman</th><th class="left">Dismissal</th><th>R</th><th>B</th><th>4s</th><th>6s</th><th>SR</th></tr></thead>
          <tbody id="i2-batting"></tbody>
        </table>
        <h4 style="margin-top:12px">Bowling</h4>
        <table>
          <thead><tr><th class="left">Bowler</th><th>O</th><th>R</th><th>W</th><th>Eco</th></tr></thead>
          <tbody id="i2-bowling"></tbody>
        </table>
      </div>
    </section>

    <!-- ===== COMMENTARY ===== -->
    <section id="comm-panel" class="panel">
      <div class="card">
        <div id="comm-feed"></div>
      </div>
    </section>

    <!-- ===== LINEUP ===== -->
    <section id="xi-panel" class="panel">
      <div class="xi-grid">
        <div class="xi-card">
          <h4 id="xi-home-title">Home XI</h4>
          <ol id="xi-home"></ol>
        </div>
        <div class="xi-card">
          <h4 id="xi-away-title">Away XI</h4>
          <ol id="xi-away"></ol>
        </div>
      </div>
    </section>
  </div>

  <div id="bottom-nav"></div>

  <!-- Smooth UI -->
  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    loadSmoothUI('top-bar','bottom-nav');
  </script>

  <!-- Main logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ====== bootstrap ====== */
    const qs = new URLSearchParams(location.search);
    const matchId = qs.get('id');

    // IMPORTANT: send x-match-id header for RLS so player names are visible
    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE",
      { global: { headers: { "x-match-id": matchId ?? "" } } }
    );

    /* ---------- Tabs ---------- */
    const tabs = {
      live: document.getElementById('tab-live'),
      score: document.getElementById('tab-score'),
      comm: document.getElementById('tab-comm'),
      xi: document.getElementById('tab-xi'),
    };
    const panels = {
      live: document.getElementById('live-panel'),
      score: document.getElementById('score-panel'),
      comm: document.getElementById('comm-panel'),
      xi: document.getElementById('xi-panel'),
    };
    const activate = (key)=>{
      ['live','score','comm','xi'].forEach(k=>{
        tabs[k].classList.toggle('active', k===key);
        panels[k].classList.toggle('show', k===key);
      })
    };
    tabs.live.onclick = ()=>activate('live');
    tabs.score.onclick = ()=>activate('score');
    tabs.comm.onclick = ()=>activate('comm');
    tabs.xi.onclick   = ()=>activate('xi');

    /* ---------- DOM refs ---------- */
    const liveFeed = document.getElementById('live-feed');
    const commFeed = document.getElementById('comm-feed');
    const liveBats = document.getElementById('live-bats-tbody');
    const liveBowls = document.getElementById('live-bowl-tbody');
    const liveTarget = document.getElementById('live-target');

    const scoreA = document.getElementById('live-score-a');
    const scoreB = document.getElementById('live-score-b');
    const teamAName = document.getElementById('team-a-name');
    const teamBName = document.getElementById('team-b-name');
    const battingHeading = document.getElementById('batting-heading');
    const liveSummary = document.getElementById('live-summary');

    const headlineA = document.getElementById('headline-a');
    const headlineB = document.getElementById('headline-b');
    const scoreTarget = document.getElementById('score-target');

    const i1 = { title:document.getElementById('i1-title'), bat:document.getElementById('i1-batting'), bowl:document.getElementById('i1-bowling'), card:document.getElementById('score-i1') };
    const i2 = { title:document.getElementById('i2-title'), bat:document.getElementById('i2-batting'), bowl:document.getElementById('i2-bowling'), card:document.getElementById('score-i2') };

    // lineup
    const xiHome = document.getElementById('xi-home');
    const xiAway = document.getElementById('xi-away');
    const xiHomeTitle = document.getElementById('xi-home-title');
    const xiAwayTitle = document.getElementById('xi-away-title');

    // refresh controls
    const btnRefresh = document.getElementById('btn-refresh');
    const autoChk = document.getElementById('auto-refresh');

    /* ---------- State ---------- */
    let all = [];
    let players = {}; // id -> {name,team_id,role,batting,bowling,is_keeper}
    let homeTeam, awayTeam;
    let names = {};
    let matchRow = null;
    const roles = {}; // teamId -> {captain,keeper}

    // live commentary helpers
    const queue = [];
    let queueTimer = null;
    const QUEUE_DELAY_MS = 800;
    const liveBatRuns = new Map(); // pid -> runs tally (for milestones)

    /* ---------- Helpers ---------- */
    const oversText = (balls)=> `${Math.floor(balls/6)}.${balls%6}`;
    const overLabel = (b)=> `${b.over_number-1}.${b.ball_in_over}`; // start at 0.1 like replay

    function totals(balls, inn) {
      const arr = balls.filter(b=>b.innings===inn);
      const runs = arr.reduce((s,b)=> s + (b.runs_scored||0) + (b.extras||0), 0);
      const wkts = arr.reduce((s,b)=> s + (b.wicket?1:0), 0);
      return { runs, wkts, legal: arr.length };
    }
    function aggBat(balls, inn) {
      const map={};
      balls.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.striker_id; if(!id) return;
        const m = map[id] ||= {runs:0,balls:0,fours:0,sixes:0};
        m.runs += b.runs_scored||0;
        m.balls++;
        if (b.runs_scored===4) m.fours++;
        if (b.runs_scored===6) m.sixes++;
      });
      return map;
    }
    function aggBowl(balls, inn) {
      const map={};
      balls.filter(b=>b.innings===inn).forEach(b=>{
        const id=b.bowler_id; if(!id) return;
        const m = map[id] ||= {runs:0,balls:0,wkts:0};
        m.runs += (b.runs_scored||0)+(b.extras||0);
        m.balls++;
        if (b.wicket && (b.dismissal_type||'').toLowerCase()!=='runout') m.wkts++;
      });
      return map;
    }

    function nameWithBadges(pid){
      const p = players[pid]; if(!p) return '—';
      const r = roles[p.team_id] || {};
      const tags=[];
      if (r.captain===pid) tags.push('C');
      if (r.keeper===pid)  tags.push('WK');
      return `${p.name}${tags.length?` (${tags.join(', ')})`:''}`;
    }

    // dismissals
    function dismissalMap(balls, inn){
      const map={}; // pid -> {type, bowler, fielder}
      balls.filter(b=>b.innings===inn && b.wicket && b.dismissed_batsman_id)
        .forEach(b=>{
          map[b.dismissed_batsman_id] = {
            type:(b.dismissal_type||'out').toLowerCase(),
            bowler:b.bowler_id||null,
            fielder:b.fielder_id||null
          };
        });
      return map;
    }
    function dismissText(pid, dm){
      const d=dm[pid]; if(!d) return "not out";
      const bow = d.bowler ? nameWithBadges(d.bowler) : '';
      const fld = d.fielder ? nameWithBadges(d.fielder) : '';
      if (d.type==="bowled") return `b ${bow}`;
      if (d.type==="lbw")    return `lbw b ${bow}`;
      if (d.type==="caught"){
        if (d.fielder && d.bowler && d.fielder===d.bowler) return `c & b ${bow}`;
        if (d.fielder) return `c ${fld} b ${bow}`;
        return `c b ${bow}`;
      }
      if (d.type==="runout"||d.type==="run-out") return d.fielder?`run out (${fld})`:`run out`;
      return bow?`b ${bow}`:"out";
    }
    function dismissTextFromBall(b){
      const type=(b.dismissal_type||'').toLowerCase();
      const bow=nameWithBadges(b.bowler_id);
      const fld=nameWithBadges(b.fielder_id);
      if (type==="bowled") return `b ${bow}`;
      if (type==="lbw")    return `lbw b ${bow}`;
      if (type==="caught"){
        if (b.fielder_id && b.bowler_id && b.fielder_id===b.bowler_id) return `c & b ${bow}`;
        if (b.fielder_id) return `c ${fld} b ${bow}`;
        return `c b ${bow}`;
      }
      if (type==="runout"||type==="run-out") return b.fielder_id?`run out (${fld})`:`run out`;
      return bow?`b ${bow}`:"out";
    }

    // commentary
    function pillsFor(b){
      const pills=[];
      if (b.wicket) pills.push('<span class="pill pill-w">WICKET</span>');
      if (b.runs_scored===6) pills.push('<span class="pill pill-6">SIX</span>');
      if (b.runs_scored===4) pills.push('<span class="pill pill-4">FOUR</span>');
      return pills.join('');
    }
    const VARIANTS={
      0:["Dot ball.","Beaten!","Good length — no run."],
      1:["Just a single.","Nudged for one.","Soft hands, one run."],
      2:["They come back for two.","Comfortable two.","Pushed for a brace."],
      3:["All hustle — three!","Good running — three.","Long chase, three taken."],
      4:["FOUR! Crunched.","Pierces the gap — four.","Stroked away for four."],
      6:["SIX! Launched.","Into the stands — six!","Clean strike — maximum!"],
      W:["Gone! Big breakthrough.","Edged and taken!","Bowled him!"]
    };
    function cleanDbCommentary(txt){
      if (!txt) return "";
      // remove any leading "Runs: N," so we don't duplicate
      return txt.replace(/^Runs?\s*:\s*\d+\s*,?\s*/i,'').trim();
    }
    function lineText(b){
      const db = cleanDbCommentary((b.commentary||'').trim());
      if (db) return db;
      if (b.wicket) return VARIANTS.W[Math.floor(Math.random()*VARIANTS.W.length)];
      const pool = VARIANTS[Math.min(6, Math.max(0, b.runs_scored||0))]||["Runs added."];
      return pool[Math.floor(Math.random()*pool.length)];
    }
    function ballHtml(b, extras=[]){
      const head = `Innings ${b.innings} • Over ${overLabel(b)} ${pillsFor(b)}`;
      const bow = nameWithBadges(b.bowler_id);
      const bat = nameWithBadges(b.striker_id);
      const main = `Runs: ${b.runs_scored||0}, ${lineText(b)}`;
      const sub  = extras.length ? `<div class="sub">${extras.join('<br/>')}</div>` : '';
      return `<div class="com-line">
        <div class="com-head">${head}</div>
        <div><strong>${bow}</strong> to <strong>${bat}</strong></div>
        <div>${main}</div>
        ${sub}
      </div>`;
    }

    function rowBatMini(pid, st, star=false){
      const nm=nameWithBadges(pid);
      const sr = st.balls ? ((st.runs/st.balls)*100).toFixed(1) : "0.0";
      return `<tr><td class="left">${nm}${star?' ★':''}</td><td>${st.runs}</td><td>${st.balls}</td><td>${st.fours}</td><td>${st.sixes}</td><td>${sr}</td></tr>`;
    }
    function rowBowl(pid, st, star=false){
      const nm=nameWithBadges(pid);
      const ov=(st.balls/6).toFixed(1);
      const eco=st.balls? (st.runs/(st.balls/6)).toFixed(1) : "0.0";
      return `<tr><td class="left">${nm}${star?' ★':''}</td><td>${ov}</td><td>${st.runs}</td><td>${st.wkts}</td><td>${eco}</td></tr>`;
    }
    // IMPORTANT: no runs appended in Dismissal column
    function rowBatFull(pid, st, dm){
      const nm=nameWithBadges(pid);
      const sr=st.balls?((st.runs/st.balls)*100).toFixed(1):"0.0";
      const dis=dismissText(pid, dm);
      return `<tr><td class="left">${nm}</td><td class="left">${dis}</td><td>${st.runs}</td><td>${st.balls}</td><td>${st.fours}</td><td>${st.sixes}</td><td>${sr}</td></tr>`;
    }

    function targetString(t1Runs, t2){
      const target=t1Runs+1;
      const need=Math.max(0,target - t2.runs);
      const ballsLeft=Math.max(0,120 - t2.legal);
      const wktsLeft=Math.max(0,10 - t2.wkts);
      return `${need} needed from ${ballsLeft} balls with ${wktsLeft} wickets in hand`;
    }

    /* ---------- Rendering ---------- */
    function updateLiveBlocks(){
      if(!all.length) return;
      const latest=all[all.length-1];
      const curInn=latest.innings;

      const t1=totals(all,1);
      scoreA.textContent=`${t1.runs}/${t1.wkts} - ${oversText(t1.legal)} ov`;

      const hasI2 = all.some(b=>b.innings===2);
      const t2 = hasI2 ? totals(all,2) : {runs:0,wkts:0,legal:0};
      scoreB.textContent= hasI2 ? `${t2.runs}/${t2.wkts} - ${oversText(t2.legal)} ov` : `--/-- - --.- ov`;

      battingHeading.textContent = `Batting – ${curInn===1 ? (names[homeTeam]||'Home') : (names[awayTeam]||'Away')}`;
      teamAName.textContent = names[homeTeam] || 'Home';
      teamBName.textContent = names[awayTeam] || 'Away';

      if (curInn===2) {
        liveTarget.style.display='block';
        liveTarget.textContent = targetString(t1.runs, t2);
      } else {
        liveTarget.style.display='none';
      }

      // bats pair
      const batAgg = aggBat(all, curInn);
      const strikerId = latest.striker_id, nonId = latest.non_striker_id;
      const s1 = batAgg[strikerId] || {runs:0,balls:0,fours:0,sixes:0};
      const s2 = batAgg[nonId] || {runs:0,balls:0,fours:0,sixes:0};
      liveBats.innerHTML = rowBatMini(strikerId,s1,true) + rowBatMini(nonId,s2,false);

      // bowlers
      const bowlAgg = aggBowl(all, curInn);
      const curBowler = latest.bowler_id;
      let lastBowler=null;
      for(let i=all.length-2;i>=0;i--){
        const b=all[i]; if(b.innings!==curInn) break;
        if(b.bowler_id!==curBowler){ lastBowler=b.bowler_id; break; }
      }
      const sb = bowlAgg[curBowler] || {runs:0,balls:0,wkts:0};
      let html=rowBowl(curBowler,sb,true);
      if(lastBowler) html+=rowBowl(lastBowler, bowlAgg[lastBowler]||{runs:0,balls:0,wkts:0});
      liveBowls.innerHTML = html;

      // headlines for score tab
      headlineA.textContent = `${names[homeTeam]||'Home'} ${t1.runs}/${t1.wkts} (${oversText(t1.legal)} ov)`;
      headlineB.textContent = `${names[awayTeam]||'Away'} ${t2.runs}/${t2.wkts} (${oversText(t2.legal)} ov)`;
      if (hasI2) {
        scoreTarget.style.display='block';
        scoreTarget.textContent = targetString(t1.runs, t2);
      } else scoreTarget.style.display='none';
    }

    function fillFullInnings(inn, ui){
      const bats = aggBat(all, inn);
      const bowls = aggBowl(all, inn);
      const dm = dismissalMap(all, inn);

      ui.bat.innerHTML="";
      Object.entries(bats).forEach(([pid,st])=>{
        ui.bat.insertAdjacentHTML('beforeend', rowBatFull(pid,st,dm));
      });
      ui.bowl.innerHTML="";
      Object.entries(bowls).forEach(([pid,st])=>{
        ui.bowl.insertAdjacentHTML('beforeend', rowBowl(pid,st));
      });
    }

    function updateScorecardBlocks(){
      if(!all.length) return;
      i1.card.style.display='block';
      i1.title.textContent = `Innings 1 – ${(names[homeTeam]||'Home')}`;
      fillFullInnings(1,i1);

      if (all.some(b=>b.innings===2)){
        i2.card.style.display='block';
        i2.title.textContent = `Innings 2 – ${(names[awayTeam]||'Away')}`;
        fillFullInnings(2,i2);
      } else {
        i2.card.style.display='none';
      }
    }

    function maybeShowSummary(){
      if (!matchRow || matchRow.status!=='completed'){ liveSummary.style.display='none'; return; }
      const t1=totals(all,1), t2=totals(all,2);
      const winnerId = matchRow.winner_team_id;
      const winName = names[winnerId] || 'Winner';
      liveSummary.style.display='block';
      liveSummary.innerHTML = `
        <div style="font-size:1.05rem;font-weight:800;margin-bottom:8px">${winName} won the match</div>
        <div>${names[homeTeam]||'Home'}: ${t1.runs}/${t1.wkts} • ${oversText(t1.legal)} ov</div>
        <div>${names[awayTeam]||'Away'}: ${t2.runs}/${t2.wkts} • ${oversText(t2.legal)} ov</div>`;
    }

    /* ---------- Extras builder (used for history & realtime) ---------- */
    function extrasForBall(ball, prev, next){
      const extras=[];
      const overStart = !prev || prev.innings!==ball.innings || prev.over_number!==ball.over_number;
      if (overStart) extras.push(`${nameWithBadges(ball.bowler_id)} comes into the attack.`);

      const prevRuns = liveBatRuns.get(ball.striker_id) || 0;
      const newRuns  = prevRuns + (ball.runs_scored||0);
      liveBatRuns.set(ball.striker_id, newRuns);
      if (newRuns>=50 && prevRuns<50 && newRuns<100) extras.push(`${nameWithBadges(ball.striker_id)} scores his FIFTY`);
      else if (newRuns>=100 && prevRuns<100) extras.push(`${nameWithBadges(ball.striker_id)} scores his HUNDRED`);

      if (ball.wicket){
        const disTxt = dismissTextFromBall(ball);
        const faced = (prev ? all.filter(x=>x.striker_id===(ball.dismissed_batsman_id||ball.striker_id)).length : 0) + 1;
        const runs  = liveBatRuns.get(ball.dismissed_batsman_id||ball.striker_id) || 0;
        extras.push(`${nameWithBadges(ball.dismissed_batsman_id||ball.striker_id)} ${disTxt} ${runs}(${faced})`);
        if (next && next.innings===ball.innings){
          const newcomer = (next.striker_id!==ball.striker_id) ? next.striker_id : next.non_striker_id;
          if (newcomer) extras.push(`${nameWithBadges(newcomer)} comes in to the Crease.`);
        }
      }
      return extras;
    }

    /* ---------- Queue (realtime) ---------- */
    function pushToQueue(b){
      queue.push(b);
      if (!queueTimer){
        queueTimer = setInterval(()=>{
          if (queue.length===0){ clearInterval(queueTimer); queueTimer=null; return; }
          const ball = queue.shift();
          const prev = all[all.length-1] || null;
          const next = queue[0] || null;

          const html = ballHtml(ball, extrasForBall(ball, prev, next));
          liveFeed.insertAdjacentHTML('afterbegin', html);
          commFeed.insertAdjacentHTML('afterbegin', html);

          all.push(ball);
          updateLiveBlocks();
          updateScorecardBlocks();

          const nxt = queue[0] || null;
          if (!nxt || nxt.innings !== ball.innings){
            if (ball.innings===1){
              const t1 = totals(all,1), t2 = {runs:0,legal:0,wkts:0};
              const need=(t1.runs+1)-t2.runs;
              const ballsLeft=120 - t2.legal;
              const teamB = names[awayTeam] || "Team B";
              const endHtml = `<div class="com-line"><div class="com-head">End of Innings 1</div><div>${teamB} required ${need} runs from ${ballsLeft} balls to win</div></div>`;
              liveFeed.insertAdjacentHTML('afterbegin', endHtml);
              commFeed.insertAdjacentHTML('afterbegin', endHtml);
            }
          }
        }, QUEUE_DELAY_MS);
      }
    }

    /* ---------- Data load ---------- */
    async function loadMeta(){
      const { data:m } = await supabase.from('matches').select('*').eq('id', matchId).single();
      matchRow = m||null;
      homeTeam = m?.home_team_id; awayTeam = m?.away_team_id;

      const { data:t } = await supabase.from('teams').select('id,team_name').in('id',[homeTeam,awayTeam]);
      (t||[]).forEach(x=> names[x.id]=x.team_name);
      teamAName.textContent = names[homeTeam] || 'Home';
      teamBName.textContent = names[awayTeam] || 'Away';
      xiHomeTitle.textContent = `${names[homeTeam]||'Home'} – Playing XI`;
      xiAwayTitle.textContent = `${names[awayTeam]||'Away'} – Playing XI`;

      const { data:ps } = await supabase.from('players')
        .select('id,name,team_id,role,batting,bowling,is_keeper')
        .in('team_id',[homeTeam,awayTeam]);
      (ps||[]).forEach(p=> players[p.id]={...p});

      const { data:lus } = await supabase.from('lineups')
        .select('team_id,captain,keeper,playing_xi,batting_order,bowling_order')
        .in('team_id',[homeTeam,awayTeam]);
      (lus||[]).forEach(l=> roles[l.team_id]={ captain:l.captain, keeper:l.keeper });

      await buildLineupUI(lus||[]);
    }

    async function buildLineupUI(lineupRows){
      function fromLineup(teamId){
        const row = lineupRows.find(r=>r.team_id===teamId);
        if (row && Array.isArray(row.playing_xi) && row.playing_xi.length===11) return row.playing_xi;
        return null;
      }
      function fallback(teamId){
        const list = Object.values(players).filter(p=>p.team_id===teamId);
        const wk = list.filter(p=> (p.is_keeper===true) || (/wk/i.test(p.role||"")));
        const bat = list.filter(p=> /bat/i.test(p.role||""));
        const ar  = list.filter(p=> /all|ar/i.test(p.role||""));
        const bowl= list.filter(p=> /bow/i.test(p.role||""));
        const byBat=(a,b)=>(b.batting||0)-(a.batting||0), byBowl=(a,b)=>(b.bowling||0)-(a.bowling||0);
        wk.sort(byBat); bat.sort(byBat); ar.sort((a,b)=> (b.batting||0+b.bowling||0)-(a.batting||0+a.bowling||0)); bowl.sort(byBowl);
        const pick=[]; if(wk.length) pick.push(wk[0]); pick.push(...bat.slice(0,4)); if(ar.length) pick.push(ar[0]); pick.push(...bowl.slice(0,5));
        const pool=list.sort((a,b)=>(b.batting||0+b.bowling||0)-(a.batting||0+a.bowling||0));
        for(const p of pool){ if(pick.length>=11) break; if(!pick.find(x=>x.id===p.id)) pick.push(p); }
        return pick.slice(0,11).map(x=>x.id);
      }
      function renderList(ol, ids){
        ol.innerHTML="";
        ids.forEach(id=>{
          const p = players[id]; if(!p) return;
          const tags=[];
          if (roles[p.team_id]?.captain===id) tags.push('C');
          if (roles[p.team_id]?.keeper===id || p.is_keeper) tags.push('WK');
          if (p.role) tags.push(p.role);
          ol.insertAdjacentHTML('beforeend', `<li>${p.name}${tags.length?` <span class="tag">${tags.join(' • ')}</span>`:''}</li>`);
        });
      }
      const homeXI = fromLineup(homeTeam) || fallback(homeTeam);
      const awayXI = fromLineup(awayTeam) || fallback(awayTeam);
      renderList(xiHome, homeXI);
      renderList(xiAway, awayXI);
    }

    async function loadBalls(){
      const { data:balls } = await supabase
        .from('ball_by_ball')
        .select('*')
        .eq('match_id', matchId)
        .order('innings',{ascending:true})
        .order('over_number',{ascending:true})
        .order('ball_in_over',{ascending:true});
      return balls||[];
    }

    function renderHistoryWithExtras(balls){
      liveBatRuns.clear();
      let html="";
      for (let i=0;i<balls.length;i++){
        const b=balls[i];
        const prev = i>0 ? balls[i-1] : null;
        const next = i<balls.length-1 ? balls[i+1] : null;
        // NB: extrasForBall mutates liveBatRuns for milestones
        const ex = extrasForBall(b, prev, next);
        html = ballHtml(b, ex) + html; // latest on top
      }
      liveFeed.innerHTML = html;
      commFeed.innerHTML = html;
    }

    async function initialLoad(){
      if (!matchId){ alert('Missing match id'); return; }
      await loadMeta();

      all = await loadBalls();
      renderHistoryWithExtras(all);
      updateLiveBlocks();
      updateScorecardBlocks();
      maybeShowSummary();

      // realtime channel
      supabase.channel('bb-live')
        .on('postgres_changes',
          { event:'INSERT', schema:'public', table:'ball_by_ball', filter:`match_id=eq.${matchId}` },
          (payload)=> pushToQueue(payload.new))
        .on('postgres_changes',
          { event:'UPDATE', schema:'public', table:'matches', filter:`id=eq.${matchId}` },
          (payload)=> { matchRow = payload.new; maybeShowSummary(); })
        .subscribe();
    }

    /* ---------- Manual + Auto refresh ---------- */
    async function refreshOnce(){
      const latest = await loadBalls();
      if (latest.length !== all.length){
        all = latest;
        renderHistoryWithExtras(all);
        updateLiveBlocks();
        updateScorecardBlocks();
        maybeShowSummary();
      }
    }
    let autoTimer = setInterval(()=>{ if (autoChk.checked) refreshOnce(); }, 2000);
    autoChk.onchange = ()=>{ /* toggle only */ };
    btnRefresh.onclick = ()=> refreshOnce();

    initialLoad();
  </script>
</body>
</html>
