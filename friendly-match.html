<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Live Match – TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:#0f1522;border:1px solid #1d263a;border-radius:14px;padding:14px;margin:14px 0}
    .match-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge{font-size:.75rem;padding:6px 10px;border-radius:999px;border:1px solid #2a3a5a;background:#133126;color:#d1fae5}
    .chip-live{background:#b91c1c;color:#fff;padding:6px 10px;border-radius:8px;font-size:.75rem}
    .teams{display:flex;align-items:center;gap:14px;margin-top:10px}
    .team-side{display:flex;align-items:center;gap:10px}
    .team-side img{width:44px;height:44px;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid #1f2937}
    .vs{opacity:.8;font-weight:700}
    .scoreline{display:flex;align-items:end;gap:12px;margin-top:8px}
    .runswk{font-size:28px;font-weight:800}
    .ov{opacity:.85}
    .sub{opacity:.8;font-size:.9rem}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .table{width:100%;border-collapse:collapse;font-size:.95rem;background:#0b1120;border:1px solid #1d263a;border-radius:10px;overflow:hidden}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid #162036}
    .table th{background:#0a1020;text-align:left;opacity:.85}
    .table tr:last-child td{border-bottom:none}
    .right{text-align:right}

    .feed{border:1px solid #1d263a;border-radius:12px;overflow:auto;max-height:55vh;background:#0b1120}
    .feed .row{padding:12px;border-bottom:1px dashed #1f2937;display:flex;gap:10px}
    .balltag{min-width:60px;font-weight:700}
    .wkt{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:#e11d48;color:#fff;font-size:.8rem;margin-right:6px}
    .muted{opacity:.75}
  </style>
</head>
<body>

  <!-- Smooth UI nav slots -->
  <div id="top-bar"></div>

  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <div class="match-head">
        <span class="badge" id="kind">Friendly</span>
        <div class="sub" id="when">—</div>
        <span class="chip-live">LIVE</span>
      </div>

      <div class="teams">
        <div class="team-side">
          <img id="homeLogo" src="/assets/logo.png" alt="Home">
          <div id="homeName" style="font-weight:700">Home</div>
        </div>
        <div class="vs">vs</div>
        <div class="team-side">
          <img id="awayLogo" src="/assets/logo.png" alt="Away">
          <div id="awayName" style="font-weight:700">Away</div>
        </div>
      </div>

      <div class="scoreline">
        <div class="runswk" id="score">0-0</div>
        <div class="ov" id="overStr">(0.0)</div>
      </div>
      <div class="sub" id="crr">CRR 0.00</div>
      <div class="muted" style="margin-top:6px;">If you joined late, you’ll see only the remaining live balls.</div>
    </div>

    <!-- Mini Scoreboard -->
    <div class="grid">
      <div class="card">
        <table class="table" id="batTable">
          <thead>
            <tr>
              <th>Batter</th><th class="right">R</th><th class="right">B</th><th class="right">4s</th><th class="right">6s</th><th class="right">SR</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>—</td><td class="right">0</td><td class="right">0</td><td class="right">0</td><td class="right">0</td><td class="right">0.00</td></tr>
            <tr><td>—</td><td class="right">0</td><td class="right">0</td><td class="right">0</td><td class="right">0</td><td class="right">0.00</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card">
        <table class="table" id="bowlTable">
          <thead>
            <tr>
              <th>Bowler</th><th class="right">O</th><th class="right">R</th><th class="right">W</th><th class="right">ECO</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>—</td><td class="right">0.0</td><td class="right">0</td><td class="right">0</td><td class="right">0.00</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Feed -->
    <div class="card">
      <div class="feed" id="feed"></div>
    </div>
  </div>

  <div id="bottom-nav"></div>

  <!-- Load top/bottom nav -->
  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => loadSmoothUI('top-bar','bottom-nav'), { once:true });
    } else {
      loadSmoothUI('top-bar','bottom-nav');
    }
  </script>

  <!-- Live logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const qs = new URLSearchParams(location.search);
    const matchId = qs.get('id');

    // ===== helpers
    function fmt(ts){
      const d = ts ? new Date(ts) : new Date();
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const h24 = d.getHours(), hh = String(h24 % 12 || 12).padStart(2,'0');
      const m  = String(d.getMinutes()).padStart(2,'0');
      const ap = h24 >= 12 ? 'PM' : 'AM';
      return `${dd}-${mm}-${yyyy}, ${hh}:${m} ${ap}`;
    }
    function safeLogo(el, url){ el.onerror=()=>{el.onerror=null;el.src='/assets/logo.png'}; el.src = url || '/assets/logo.png'; }
    function oversStr(balls){ return `${Math.floor(balls/6)}.${balls%6}`; }
    function eco(runs, balls){ const ov=balls/6; return ov? (runs/ov).toFixed(2):'0.00'; }
    function sr(runs, balls){ return balls? ((runs*100)/balls).toFixed(2):'0.00'; }

    async function nameFor(table, id, fallback='—'){
      if(!id) return fallback;
      const { data } = await supabase.from(table).select('name,team_name').eq('id', id).maybeSingle();
      return data?.name || data?.team_name || fallback;
    }

    const feedEl = document.getElementById('feed');

    // ===== global state
    let totals = { runs:0, wickets:0, balls:0 };
    const latestByKey = new Map(); // 'I-O-B' -> row
    const batStats = new Map();    // playerId -> {r,b,4s,6s}
    const bowlStats = new Map();   // playerId -> {balls,runs,wkts}

    let currentStriker=null, currentNonStriker=null, currentBowler=null;

    function keyOf(b){ return `${b.innings}-${b.over_number}-${b.ball_in_over}`; }

    // ===== renderers
    function renderHeader(){
      document.getElementById('score').textContent = `${totals.runs}-${totals.wickets}`;
      document.getElementById('overStr').textContent = `(${oversStr(totals.balls)})`;
      const ov = totals.balls/6; document.getElementById('crr').textContent = `CRR ${ov? (totals.runs/ov).toFixed(2):'0.00'}`;
    }

    function rowHtml(b){
      const tag = `I${b.innings} ${b.over_number}.${b.ball_in_over}`;
      const w = b.wicket ? `<span class="wkt">W</span>` : '';
      const text = b.commentary ?? (b.wicket ? 'Wicket!' : `Runs: ${b.runs_scored}`);
      return `<div class="row"><div class="balltag">${tag}</div><div>${w}${text}</div></div>`;
    }

    function applyToBatter(id, runs, isBoundary4, isBoundary6){
      if(!id) return;
      const st = batStats.get(id) || { r:0,b:0,f4:0,f6:0 };
      st.r += runs;
      st.b += 1;
      if(isBoundary4) st.f4 += 1;
      if(isBoundary6) st.f6 += 1;
      batStats.set(id, st);
    }

    function applyToBowler(id, runsConceded, wicket){
      if(!id) return;
      const st = bowlStats.get(id) || { balls:0, runs:0, wkts:0 };
      st.balls += 1;
      st.runs  += runsConceded;
      if (wicket) st.wkts += 1;
      bowlStats.set(id, st);
    }

    function renderBatTable(){
      const body = document.querySelector('#batTable tbody');
      body.innerHTML = '';
      const rows = [currentStriker, currentNonStriker].filter(Boolean).map(id=>{
        const s = batStats.get(id) || { r:0,b:0,f4:0,f6:0 };
        return { id, ...s };
      });
      // keep two rows
      while(rows.length < 2) rows.push({ id:null, r:0,b:0,f4:0,f6:0 });

      rows.forEach(async (r)=>{
        const tr = document.createElement('tr');
        const name = r.id ? await nameFor('players', r.id, '—') : '—';
        tr.innerHTML = `
          <td>${name}</td>
          <td class="right">${r.r}</td>
          <td class="right">${r.b}</td>
          <td class="right">${r.f4}</td>
          <td class="right">${r.f6}</td>
          <td class="right">${sr(r.r, r.b)}</td>`;
        body.appendChild(tr);
      });
    }

    function renderBowlTable(){
      const body = document.querySelector('#bowlTable tbody');
      body.innerHTML = '';
      const s = currentBowler ? (bowlStats.get(currentBowler) || { balls:0, runs:0, wkts:0 }) : { balls:0, runs:0, wkts:0 };
      const tr = document.createElement('tr');
      const nameP = currentBowler ? nameFor('players', currentBowler, '—') : Promise.resolve('—');
      nameP.then(name=>{
        tr.innerHTML = `
          <td>${name}</td>
          <td class="right">${oversStr(s.balls)}</td>
          <td class="right">${s.runs}</td>
          <td class="right">${s.wkts}</td>
          <td class="right">${eco(s.runs, s.balls)}</td>`;
        body.appendChild(tr);
      });
    }

    async function applyBall(b){
      // totals
      const batRuns = b.runs_scored || 0;
      const extras = b.extras || 0;
      totals.runs += batRuns + extras;
      if (b.wicket) totals.wickets += 1;
      totals.balls += 1;

      // current actors
      if (b.striker_id)     currentStriker    = b.striker_id;
      if (b.non_striker_id) currentNonStriker = b.non_striker_id;
      if (b.bowler_id)      currentBowler     = b.bowler_id;

      // update batter/bowler stats
      const is4 = batRuns === 4 && extras === 0;
      const is6 = batRuns === 6 && extras === 0;
      applyToBatter(currentStriker, batRuns, is4, is6);
      applyToBowler(currentBowler, batRuns + extras, !!b.wicket);

      // feed newest first
      const div = document.createElement('div');
      div.innerHTML = rowHtml(b);
      feedEl.prepend(div.firstElementChild);

      // re-render
      renderHeader();
      renderBatTable();
      renderBowlTable();
    }

    // ===== meta + existing
    async function loadMeta(){
      const { data: m } = await supabase
        .from('matches')
        .select('id, is_friendly, kickoff_at, home_team_id, away_team_id, status')
        .eq('id', matchId).single();

      document.getElementById('kind').textContent = m?.is_friendly ? 'Friendly' : 'League';
      document.getElementById('when').textContent = fmt(m?.kickoff_at);

      const [home, away] = await Promise.all([
        supabase.from('teams').select('team_name,logo_url').eq('id', m.home_team_id).maybeSingle(),
        supabase.from('teams').select('team_name,logo_url').eq('id', m.away_team_id).maybeSingle(),
      ]);

      document.getElementById('homeName').textContent = home.data?.team_name ?? m.home_team_id;
      document.getElementById('awayName').textContent = away.data?.team_name ?? m.away_team_id;
      safeLogo(document.getElementById('homeLogo'), home.data?.logo_url);
      safeLogo(document.getElementById('awayLogo'), away.data?.logo_url);
    }

    async function loadExisting(){
      const { data } = await supabase
        .from('ball_by_ball')
        .select('innings,over_number,ball_in_over,runs_scored,extras,wicket,commentary,striker_id,non_striker_id,bowler_id')
        .eq('match_id', matchId)
        .order('innings').order('over_number').order('ball_in_over');

      (data||[]).forEach(b=>{
        latestByKey.set(keyOf(b), b);

        // update totals & stats
        totals.runs += (b.runs_scored||0) + (b.extras||0);
        if (b.wicket) totals.wickets += 1;
        totals.balls += 1;

        if (b.striker_id)     currentStriker    = b.striker_id;
        if (b.non_striker_id) currentNonStriker = b.non_striker_id;
        if (b.bowler_id)      currentBowler     = b.bowler_id;

        const is4 = (b.runs_scored||0) === 4 && (b.extras||0) === 0;
        const is6 = (b.runs_scored||0) === 6 && (b.extras||0) === 0;
        applyToBatter(b.striker_id, (b.runs_scored||0), is4, is6);
        applyToBowler(b.bowler_id, (b.runs_scored||0)+(b.extras||0), !!b.wicket);
      });

      // render feed (newest first)
      const frag = document.createDocumentFragment();
      [...latestByKey.values()].sort((a,b)=>{
        if (a.innings!==b.innings) return b.innings-a.innings;
        if (a.over_number!==b.over_number) return b.over_number-a.over_number;
        return b.ball_in_over-a.ball_in_over;
      }).forEach(b=>{
        const div = document.createElement('div');
        div.innerHTML = rowHtml(b);
        frag.append(div.firstElementChild);
      });
      feedEl.append(frag);

      renderHeader();
      renderBatTable();
      renderBowlTable();
    }

    // ===== realtime
    function subscribe(){
      supabase.channel('live-bbb-'+matchId)
        .on('postgres_changes', { event:'INSERT', schema:'public', table:'ball_by_ball', filter:`match_id=eq.${matchId}` },
          async ({ new: b })=>{
            const k = keyOf(b); if (latestByKey.has(k)) return;
            latestByKey.set(k,b);
            await applyBall(b);
          })
        .on('postgres_changes', { event:'UPDATE', schema:'public', table:'matches', filter:`id=eq.${matchId}` },
          ({ new: m })=>{
            if (m?.status === 'completed') location.href = (m.is_friendly ? 'friendly-replay.html' : 'league-replay.html') + `?id=${matchId}`;
          })
        .subscribe();
    }

    await loadMeta();
    await loadExisting();
    subscribe();
  </script>
</body>
</html>
