<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>League Preview – TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css"/>
  <style>
    body{background:#0b0f16;color:#e7ecf3;font-family:system-ui;margin:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .head{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0}
    .badge{font-size:.75rem;padding:6px 12px;border-radius:999px;border:1px solid #26314b;background:#0f1522}
    h1{margin:8px 0 4px;font-size:2rem}
    .muted{opacity:.75}
    .card{background:#121825;border:1px solid #1d263a;border-radius:12px;padding:18px;margin:14px 0}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .strip{display:flex;flex-direction:column;gap:12px}
    .count{font-weight:800;font-size:48px;line-height:1}
    .row{display:flex;gap:12px;align-items:center}
    .venue-box{background:#0d1220;border-radius:8px;padding:12px;border:1px solid #20283a}
    .meta{color:#9fb0be;font-weight:700}
    .big-btn{background:#0f6b2a;color:#000;border:none;padding:12px 20px;border-radius:8px;font-weight:800;cursor:not-allowed;opacity:.95}
    .big-btn.enabled{cursor:pointer}
    .right-panel{display:flex;flex-direction:column;gap:12px}
    .info-card{background:#0d1220;border-radius:10px;padding:12px;border:1px solid #20283a}
    .info-title{font-weight:700;margin-bottom:6px}
    .value{font-weight:800}
    .tag{font-size:.85rem;color:#9fb0be}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <div class="wrap">
    <div class="head">
      <div>
        <span class="badge">League</span>
        <div style="height:8px"></div>
        <h1 id="match-title">Home vs Away</h1>
        <div class="muted" id="kickoff-line">Kickoff — --</div>
      </div>
      <div style="text-align:right">
        <div class="tag">Status</div>
        <div style="font-weight:800;font-size:1.1rem" id="status-text">scheduled</div>
      </div>
    </div>

    <div class="card grid">
      <div class="strip">
        <div>
          <div class="muted">Countdown to kickoff</div>
          <div class="count" id="countdown">--:--:--</div>
        </div>

        <div>
          <div class="muted">Toss : <span id="toss-text">Pending</span></div>
          <div class="muted">Match : <span id="match-state">Not yet started</span></div>
        </div>

        <div class="info-card">
          <div class="info-title">Match Details</div>

          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div class="venue-box" style="flex:1">
              <div class="tag">Venue</div>
              <div class="value" id="venue-name">—</div>
              <div class="muted" id="venue-level">Level unknown</div>
            </div>

            <div class="venue-box" style="width:220px">
              <div class="tag">Pitch</div>
              <div class="value" id="pitch-type">Unknown</div>
              <div class="muted" id="pitch-note">Pitch details not available</div>
            </div>
          </div>

        </div>

        <div>
          <button id="open-live" class="big-btn" disabled>Match not started</button>
        </div>

        <div class="muted">When match status becomes running this button will open the live match page.</div>
      </div>

      <aside class="right-panel">
        <div class="info-card">
          <div class="info-title">Home</div>
          <div id="home-name" class="value">—</div>
          <div style="height:10px"></div>
          <div class="info-title">Away</div>
          <div id="away-name" class="value">—</div>
          <div style="height:12px"></div>
          <div class="tag">Kickoff</div>
          <div id="kickoff-value" class="value">--</div>
        </div>

        <div class="info-card">
          <div class="info-title">Stadium capacity</div>
          <div id="stad-cap" class="value">unknown</div>
          <div style="height:8px"></div>
          <div class="info-title">Quick actions</div>
          <div style="display:flex;gap:8px">
            <a id="home-profile" class="muted" href="#"><button class="big-btn" style="background:#263142;color:#fff;padding:8px 10px;cursor:pointer">Home profile</button></a>
            <a id="away-profile" class="muted" href="#"><button class="big-btn" style="background:#263142;color:#fff;padding:8px 10px;cursor:pointer">Away profile</button></a>
          </div>
        </div>

      </aside>
    </div>

  </div>

  <div id="bottom-nav"></div>

  <script type="module">
    import { loadSmoothUI } from "./js/smooth-ui.js";
    loadSmoothUI("top-bar","bottom-nav");
  </script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const qs = new URLSearchParams(location.search);
    const fixtureId = qs.get("id");

    const el = id => document.getElementById(id);
    const countdownEl = el("countdown");
    const openBtn = el("open-live");
    let countdownTimer = null;
    let fixture = null;

    function fmtDateTime(ts){
      if (!ts) return "--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h = String(d.getHours() % 12 || 12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = d.getHours() >= 12 ? "PM" : "AM";
      return `${dd}-${mm}-${yyyy}, ${h}:${mi} ${ampm}`;
    }

    function startCountdown(toTs){
      if (countdownTimer) clearInterval(countdownTimer);
      function tick(){
        const now = Date.now();
        const diff = Math.max(0, toTs - now);
        const s = Math.floor(diff/1000);
        const hh = String(Math.floor(s/3600)).padStart(2,"0");
        const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
        const ss = String(s%60).padStart(2,"0");
        countdownEl.textContent = `${hh}:${mm}:${ss}`;
        if (diff <= 0) {
          clearInterval(countdownTimer);
          // reload fixture so UI reflects new status (or open live page automatically)
          fetchAndRender();
        }
      }
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    async function fetchStadiumForFixture(fx){
      // Priority:
      // 1) fixture.stadium_id (explicit)
      // 2) stadium with team_id = home_team_id ( team's stadium )
      if (!fx) return null;
      try {
        if (fx.stadium_id) {
          const { data } = await supabase.from('stadiums').select('id,name,capacity,level,pitch_type').eq('id', fx.stadium_id).maybeSingle();
          if (data) return data;
        }
        if (fx.home_team_id) {
          const { data } = await supabase.from('stadiums').select('id,name,capacity,level,pitch_type').eq('team_id', fx.home_team_id).limit(1).maybeSingle();
          if (data) return data;
        }
      } catch(err) {
        console.warn('stadium fetch failed', err);
      }
      return null;
    }

    function enableOpenButton(destUrl){
      openBtn.disabled = false;
      openBtn.classList.add('enabled');
      openBtn.style.cursor = 'pointer';
      openBtn.textContent = 'Open live match';
      openBtn.onclick = () => { window.location.href = destUrl; };
    }

    function disableOpenButton(){
      openBtn.disabled = true;
      openBtn.classList.remove('enabled');
      openBtn.style.cursor = 'not-allowed';
      openBtn.textContent = 'Match not started';
      openBtn.onclick = null;
    }

    async function fetchAndRender(){
      if (!fixtureId) { alert('Missing fixture id'); return; }
      const { data: fx } = await supabase.from('fixtures').select('*').eq('id', fixtureId).maybeSingle();
      if (!fx) {
        alert('Fixture not found');
        return;
      }
      fixture = fx;

      // teams names
      const teamIds = [fx.home_team_id, fx.away_team_id].filter(Boolean);
      const names = {};
      if (teamIds.length) {
        const { data: teams } = await supabase.from('teams').select('id,team_name').in('id', teamIds);
        (teams||[]).forEach(t => names[t.id] = t.team_name);
      }

      el('match-title').textContent = `${names[fx.home_team_id] || fx.home_team_name || 'Home'} vs ${names[fx.away_team_id] || fx.away_team_name || 'Away'}`;
      el('home-name').textContent = names[fx.home_team_id] || fx.home_team_name || 'Home';
      el('away-name').textContent = names[fx.away_team_id] || fx.away_team_name || 'Away';

      const kickoffTs = fx.kickoff_at ? (new Date(fx.kickoff_at)).getTime() : (fx.date ? (new Date(`${fx.date}T${fx.start_time||'00:00'}`)).getTime() : null);
      el('kickoff-value').textContent = kickoffTs ? fmtDateTime(kickoffTs) : '--';
      el('kickoff-line').textContent = kickoffTs ? `Kickoff — ${fmtDateTime(kickoffTs)}` : 'Kickoff — --';

      // status
      const status = fx.status || 'scheduled';
      el('status-text').textContent = status;

      // toss pending - try to get toss info from result/sim_state if present
      let tossText = 'Pending';
      try {
        const resultObj = fx.result ? (typeof fx.result === 'string' ? JSON.parse(fx.result) : fx.result) : null;
        const sim = fx.sim_state ? (typeof fx.sim_state === 'string' ? JSON.parse(fx.sim_state) : fx.sim_state) : null;
        const t = (resultObj && resultObj.toss) ? resultObj.toss : (sim && sim.toss ? sim.toss : null);
        if (fx.toss_winner_team_id || fx.toss_decision) {
          const winnerName = (names[fx.toss_winner_team_id] || names[fx.toss_winner_team_id]) || '';
          const dec = fx.toss_decision || '';
          tossText = `${winnerName} • ${dec}`;
        } else if (t && (t.winner || t.winner_team_id)) {
          const winnerName = names[t.winner || t.winner_team_id] || (t.winner || t.winner_team_id);
          tossText = `${winnerName} • ${t.decision || t.elected || ''}`;
        }
      } catch(e){ /* fall back to Pending */ }
      el('toss-text').textContent = tossText;

      // match state label
      el('match-state').textContent = (status === 'running' ? 'In progress' : 'Not yet started');

      // Fetch stadium info
      const st = await fetchStadiumForFixture(fx);
      if (st) {
        el('venue-name').textContent = st.name || `${names[fx.home_team_id] || fx.home_team_name || 'Home'} Ground`;
        el('venue-level').textContent = st.level ? `Level ${st.level}` : 'Level unknown';
        el('pitch-type').textContent = st.pitch_type ? st.pitch_type : 'Unknown';
        el('pitch-note').textContent = st.pitch_type ? '' : 'Pitch details not available';
        el('stad-cap').textContent = st.capacity ? st.capacity.toLocaleString() : 'unknown';
      } else {
        // fallback to team-based synthetic venue name
        const synthetic = `${names[fx.home_team_id] || fx.home_team_name || 'Home'} Ground`;
        el('venue-name').textContent = synthetic;
        el('venue-level').textContent = 'Level unknown';
        el('pitch-type').textContent = 'Unknown';
        el('pitch-note').textContent = 'Pitch details not available';
        el('stad-cap').textContent = 'unknown';
      }

      // quick actions links
      el('home-profile').href = `public-profile.html?team=${fx.home_team_id || ''}`;
      el('away-profile').href = `public-profile.html?team=${fx.away_team_id || ''}`;

      // countdown
      if (kickoffTs) startCountdown(kickoffTs);

      // button behaviour: open league-match.html when status becomes running
      const running = (status||'').toLowerCase() === 'running';
      if (running) {
        enableOpenButton(`league-match.html?id=${encodeURIComponent(fx.id)}`);
      } else {
        disableOpenButton();
      }
    }

    // re-fetch every 10s to pick up status changes
    fetchAndRender();
    setInterval(fetchAndRender, 10000);
  </script>
</body>
</html>
