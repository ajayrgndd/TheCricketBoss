<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training – TheCricketBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    :root { --card:#111; --muted:#8a8a8a; --accent:#00e676; }
    body { background:#0b0b0b; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .container { max-width:1000px; margin:0 auto; padding:12px; }
    .section { background:linear-gradient(180deg,#121212,#0f0f0f); border:1px solid #222; border-radius:14px; padding:12px; margin:12px 0; }
    .status { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; font-weight:700; border:1px solid #2b2b2b; }
    .open { color:#0f0; }
    .closed { color:#f55; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toggle { display:flex; gap:8px; background:#101010; border:1px solid #222; border-radius:10px; padding:6px; }
    .toggle button{ background:transparent; color:#ddd; border:0; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .toggle button.active{ background:#1a1a1a; color:#fff; outline:2px solid #2a2a2a; }
    .grid { display:grid; grid-template-columns: repeat(1,minmax(0,1fr)); gap:10px; }
    @media (min-width:600px){ .grid{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (min-width:900px){ .grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .card { background:#111; border:1px solid #222; border-radius:12px; padding:10px; display:grid; grid-template-columns:72px 1fr; gap:10px; align-items:center; }
    .avatar { width:72px; height:96px; border-radius:10px; object-fit:cover; object-position:50% 0%; background:#1a1a1a; border:1px solid #222; }
    .meta h4 { margin:0; font-size:15px; }
    .meta .rowline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:12px; }
    .kv { display:grid; grid-template-columns:auto 1fr; column-gap:8px; row-gap:4px; margin-top:6px; font-size:12px; }
    .kv .k { color:#aaa; }
    .kv .v { font-weight:600; }
    .select { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .select input { width:18px; height:18px; }
    .disabled { opacity:.55; pointer-events:none; }
    .footer { position:sticky; bottom:64px; background:#0d0d0d; border:1px solid #222; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .btn { background:#1d1d1d; color:#fff; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.cta { background:linear-gradient(90deg,#0f0,#00e676); color:#000; border:0; }
    .note { color:#bbb; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:70px; background:#141414; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:700; }
    .hidden { display:none; }

    /* Result modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:2000; }
    .modal{ width:min(700px,92vw); background:#101010; border:1px solid #2a2a2a; border-radius:14px; padding:14px; }
    .modal h3{ margin:6px 0 8px; }
    .result-line{ padding:8px 10px; border:1px solid #242424; border-radius:10px; background:#0d0d0d; }
    .result-list{ display:flex; flex-direction:column; gap:8px; margin:10px 0; }
    .xp-badge{ display:inline-block; background:#0f0; color:#000; font-weight:800; padding:2px 8px; border-radius:999px; }
    .modal .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  </style>
</head>
<body>
  <!-- Top/Bottom nav auto-injected -->
  <div id="top-nav"></div>

  <main class="container">
    <section class="section">
      <div class="status">
        <div class="row">
          <span id="status-pill" class="pill">Checking…</span>
          <span id="window-label" class="muted">—</span>
        </div>
        <div id="countdown" class="muted">—</div>
      </div>
      <div id="controls" class="row" style="margin-top:10px;">
        <div class="toggle" role="tablist" aria-label="Training Type">
          <button id="btn-batting" class="active" data-type="batting">Batting</button>
          <button id="btn-bowling" data-type="bowling">Bowling</button>
        </div>
        <span class="note">Select exactly <b>3</b> players.</span>
      </div>
    </section>

    <section id="players-section" class="section">
      <h3 style="margin:2px 0 10px 0;">Eligible Players</h3>
      <div id="players-grid" class="grid"></div>
      <div id="empty" class="muted" style="padding:8px 0; display:none;">No players found.</div>
    </section>

    <section class="footer">
      <div id="summary" class="muted">0 of 3 selected</div>
      <button id="train-btn" class="btn cta" disabled>Train Selected</button>
    </section>
  </main>

  <!-- Training Result Modal -->
  <div id="result-wrap" class="modal-backdrop hidden">
    <div class="modal">
      <h3>Training Result</h3>
      <div id="result-meta" class="muted"></div>
      <div class="result-list" id="result-list"></div>
      <div class="actions">
        <button id="result-close" class="btn">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden">Saved</div>
  <div id="bottom-nav"></div>

  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // --- Supabase (same as your nav-loader) ---
    const SUPABASE_URL = 'https://iukofcmatlfhfwcechdq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Tiny helpers ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); };

    // --- Time helpers (IST only) ---
    const MINUTES_IST = 5*60 + 30;
    const nowIST = () => {
      const now = new Date();
      return new Date(now.getTime() + (MINUTES_IST + now.getTimezoneOffset())*60000);
    };
    const startOfDayIST = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
    const mondayAnchorIST = (d) => {
      const x = startOfDayIST(d);
      const day = x.getDay(); // 0 Sun..6 Sat
      const diff = (day + 6) % 7; // days since Monday
      x.setDate(x.getDate() - diff);
      return x;
    };
    const fmtDateYYYYMMDD = (d) => d.toISOString().split('T')[0];

    // Windows: Mon 22:00 → Thu 07:00; Thu 22:00 → Mon 07:00 (IST)
    function windowStateIST(d = nowIST()) {
      const mon = mondayAnchorIST(d);
      const thu = new Date(mon); thu.setDate(mon.getDate()+3);

      const openMon = new Date(mon); openMon.setHours(22,0,0,0);
      const closeThu = new Date(thu); closeThu.setHours(7,0,0,0);

      const openThu = new Date(thu); openThu.setHours(22,0,0,0);
      const closeMonNext = new Date(mon); closeMonNext.setDate(mon.getDate()+7); closeMonNext.setHours(7,0,0,0);

      if (d >= openMon && d < closeThu) return { open:true, label:'Mon Session', which:'mon', closesAt: closeThu };
      if (d >= openThu && d < closeMonNext) return { open:true, label:'Thu Session', which:'thu', closesAt: closeMonNext };

      let nextOpen;
      if (d < openMon) nextOpen = openMon;
      else if (d < openThu) nextOpen = openThu;
      else { nextOpen = new Date(mon); nextOpen.setDate(mon.getDate()+7); nextOpen.setHours(22,0,0,0); }
      return { open:false, label:'Closed', which:'closed', opensAt: nextOpen };
    }

    function startStatusLoop() {
      const updateUI = () => {
        const st = windowStateIST();
        const pill = $('#status-pill');
        const label = $('#window-label');
        const cd = $('#countdown');
        const controls = $('#controls');

        if (st.open) {
          pill.textContent = 'OPEN';
          pill.classList.add('open'); pill.classList.remove('closed');
          label.textContent = st.label;
          const secs = Math.max(0, Math.floor((st.closesAt - nowIST())/1000));
          cd.textContent = `Closes in ${Math.floor(secs/3600)}h ${Math.floor((secs%3600)/60)}m`;
          controls.style.display = '';
        } else {
          pill.textContent = 'CLOSED';
          pill.classList.add('closed'); pill.classList.remove('open');
          label.textContent = '—';
          cd.textContent = `Opens ${st.opensAt.toLocaleString('en-IN')}`;
          controls.style.display = 'none';
        }
      };
      updateUI();
      setInterval(updateUI, 30_000);
    }

    // Age band → base growth (no display on card; used in backend calc)
    function baseGrowth(ageYears, ageDays=0) {
      const d = Number(ageDays ?? 0);
      if (ageYears > 30 || (ageYears === 30 && d >= 1)) return 0;
      if (d === 0) return 0; // table starts at .01
      switch (ageYears) {
        case 16: return 1.50;
        case 17: return 1.30;
        case 18: return 1.25;
        case 19: return 1.15;
        case 20: return 1.10;
        case 21: return 1.05;
        case 22: return 1.00;
        case 23: return 0.95;
        case 24: return 0.90;
        case 25: return 0.85;
        case 26: return 0.80;
        case 27: return 0.75;
        case 28: return 0.70;
        case 29: return 0.65;
        case 30: return 0.00;
        default: return 0;
      }
    }

    // Skill tiers
    function getSkillLevel(value) {
      if (value >= 101) return "The Boss";
      if (value >= 81) return "Titan";
      if (value >= 61) return "World Class";
      if (value >= 51) return "Supreme";
      if (value >= 41) return "National";
      if (value >= 31) return "Professional";
      if (value >= 21) return "Domestic";
      if (value >= 11) return "Trainee";
      return "Newbie";
    }
    const XP_BY_UPGRADE = {
      "Newbie>Trainee":10,
      "Trainee>Domestic":20,
      "Domestic>Professional":30,
      "Professional>National":40,
      "National>Supreme":50,
      "Supreme>World Class":100,
      "World Class>Titan":200,
      "Titan>The Boss":500
    };
    const overallLevelName = (p) => getSkillLevel(Math.max(p.batting||0, p.bowling||0, p.keeping||0));
    const weekAnchorStrIST = (d = nowIST()) => fmtDateYYYYMMDD(mondayAnchorIST(d));

    // Compute training deltas for a player (no UI display)
    function computeDeltasForPlayer(p, sessionType){
      const base = baseGrowth(p.age_years||0, p.age_days||0);
      const isWK = p.is_wk || String(p.role||'').toLowerCase()==='wicketkeeper';
      const role = String(p.role||'').toLowerCase();
      const deltas = { batting:0, bowling:0, keeping:0 };
      if (base === 0) return deltas;
      if (isWK) {
        if (sessionType==='bowling') return deltas;  // WK not allowed in bowling session
        deltas.batting = +(0.75 * base).toFixed(3);
        deltas.keeping = +(0.50 * base).toFixed(3);
        return deltas;
      }
      if (role==='allrounder') {
        if (sessionType==='batting') {
          deltas.batting = +(0.75 * base).toFixed(3);
          deltas.bowling = +(0.25 * base).toFixed(3);
        } else {
          deltas.bowling = +(0.75 * base).toFixed(3);
          deltas.batting = +(0.25 * base).toFixed(3);
        }
        return deltas;
      }
      if (sessionType==='batting') deltas.batting = +base.toFixed(3);
      else deltas.bowling = +base.toFixed(3);
      return deltas;
    }

    // --- Page state ---
    let sessionType='batting', players=[], teamId=null, currentUser=null, profile=null;

    // Controls
    $('#btn-batting').addEventListener('click', ()=>setType('batting'));
    $('#btn-bowling').addEventListener('click', ()=>setType('bowling'));
    $('#train-btn').addEventListener('click', onTrain);
    $('#result-close').addEventListener('click', ()=>$('#result-wrap').classList.add('hidden'));

    function setType(t){ sessionType=t; $$('.toggle button').forEach(b=>b.classList.toggle('active', b.dataset.type===t)); renderPlayers(); }

    async function init(){
      await loadSmoothUI();
      startStatusLoop();

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href='login.html'; return; }
      currentUser=user;
      const { data: prof } = await supabase.from('profiles')
        .select('user_id, team_id, xp, manager_name')
        .eq('user_id', user.id).maybeSingle();
      if (!prof) return; profile=prof; teamId=prof.team_id;

      const { data } = await supabase.from('players')
        .select('id, team_id, name, role, batting, bowling, keeping, age_years, age_days, image_url, is_wk, last_trained_week_anchor, last_trained_type, team_name, manager_name, skill_level')
        .eq('team_id', teamId)
        .order('name', { ascending:true });
      players = data || [];
      renderPlayers();
    }

    function renderPlayers(){
      const grid=$('#players-grid'); grid.innerHTML='';
      if(!players.length){ $('#empty').style.display='block'; return;}
      $('#empty').style.display='none';

      const weekAnchor=weekAnchorStrIST();
      const st=windowStateIST();

      // build list; hide WKs in Bowling tab
      const list = players.filter(p=>{
        const isWK = p.is_wk || String(p.role||'').toLowerCase()==='wicketkeeper';
        return !(sessionType==='bowling' && isWK);
      });

      list.forEach(p=>{
        const card=document.createElement('div'); card.className='card';

        const img=document.createElement('img'); img.className='avatar'; img.src=p.image_url||'/assets/player.png'; img.alt=p.name;
        card.append(img);

        const meta=document.createElement('div'); meta.className='meta';
        const title=document.createElement('div'); title.className='rowline';
        const nameEl=document.createElement('h4'); nameEl.textContent=p.name;
        const roleLbl=(p.is_wk||String(p.role||'').toLowerCase()==='wicketkeeper')?'Wicket Keeper':(p.role||'Player');
        const ageEl=document.createElement('span'); ageEl.className='muted'; ageEl.textContent=`• ${roleLbl} • Age ${p.age_years||0}y ${p.age_days||0}d`;
        title.append(nameEl, ageEl);

        // skills as tier names only
        const kv=document.createElement('div'); kv.className='kv';
        const row = (k,val)=>{ const kEl=document.createElement('div');kEl.className='k';kEl.textContent=k; const vEl=document.createElement('div');vEl.className='v';vEl.textContent=val; kv.append(kEl,vEl); };
        row('BAT', getSkillLevel(p.batting||0));
        row('BOW', getSkillLevel(p.bowling||0));
        row('KEEP', getSkillLevel(p.keeping||0));

        // eligibility line
        const info=document.createElement('div'); info.className='muted';
        const disabledByWeek = (p.last_trained_week_anchor && fmtDateYYYYMMDD(new Date(p.last_trained_week_anchor)) === weekAnchor);
        if (disabledByWeek) info.textContent='Already trained this week';
        else if (baseGrowth(p.age_years||0, p.age_days||0)===0) info.textContent='No gain at current age';
        else info.textContent='Eligible';

        // selection
        const select=document.createElement('label'); select.className='select';
        const chk=document.createElement('input'); chk.type='checkbox';
        const labelSpan=document.createElement('span'); labelSpan.textContent='Select';
        select.append(chk,labelSpan);
        chk.disabled = !st.open || disabledByWeek;
        chk.addEventListener('change', ()=>{
          const chosen = $$('#players-grid input[type="checkbox"]:checked').length;
          $('#summary').textContent = `${chosen} of 3 selected`;
          $('#train-btn').disabled = !(chosen===3 && st.open);
        });

        meta.append(title, kv, info, select);
        card.append(meta);
        if (!st.open || disabledByWeek) card.classList.add('disabled');
        grid.append(card);
      });

      $('#summary').textContent = `0 of 3 selected`;
      $('#train-btn').disabled = true;
    }

    async function onTrain(){
      const st = windowStateIST();
      if (!st.open) { toast('Training window closed'); return; }

      const checks = $$('#players-grid input[type="checkbox"]');
      const idxs = checks.map((c,i)=>c.checked ? i : -1).filter(i=>i>=0);
      if (idxs.length !== 3) { toast('Select exactly 3'); return; }

      const weekAnchor = weekAnchorStrIST();
      const now = new Date().toISOString();
      const allCards = $$('#players-grid .card');
      const chosen = idxs.map(i => {
        // map back to player from filtered list
        const isWK = (x)=> x.is_wk || String(x.role||'').toLowerCase()==='wicketkeeper';
        const filtered = players.filter(p=>!(sessionType==='bowling' && isWK(p)));
        return filtered[i];
      });

      // compute and persist updates
      const updates = [];
      let sessionXp = 50; // +50 for completing training
      let levelUpXpTotal = 0;
      const resultLines = [];

      for (const p of chosen){
        const beforeOverall = overallLevelName(p);
        const del = computeDeltasForPlayer(p, sessionType);

        const newBat = +( (p.batting||0) + (del.batting||0) ).toFixed(3);
        const newBow = +( (p.bowling||0) + (del.bowling||0) ).toFixed(3);
        const newKeep = +( (p.keeping||0) + (del.keeping||0) ).toFixed(3);

        const afterOverall = getSkillLevel(Math.max(newBat, newBow, newKeep));

        // Level-up XP per player
        if (beforeOverall !== afterOverall){
          const key = `${beforeOverall}>${afterOverall}`;
          const add = XP_BY_UPGRADE[key] || 0;
          if (add > 0){
            levelUpXpTotal += add;
            resultLines.push(`${p.name} (${(p.is_wk||String(p.role||'').toLowerCase()==='wicketkeeper')?'Wicket Keeper':(p.role||'Player')}) upgraded to ${afterOverall} level from ${beforeOverall} level. (User XP earned : + ${add} XP)`);
          }
        } else {
          // Show generic trained line (no level change)
          resultLines.push(`${p.name} (${(p.is_wk||String(p.role||'').toLowerCase()==='wicketkeeper')?'Wicket Keeper':(p.role||'Player')}) trained in ${sessionType.charAt(0).toUpperCase()+sessionType.slice(1)} (no level change).`);
        }

        updates.push({
          id: p.id,
          batting: newBat,
          bowling: newBow,
          keeping: newKeep,
          last_trained_week_anchor: weekAnchor,
          last_trained_session_at: now,
          last_trained_type: sessionType,
          skill_level: afterOverall
        });
      }

      // Save players
      for (const u of updates){
        const { error } = await supabase.from('players')
          .update({
            batting: u.batting,
            bowling: u.bowling,
            keeping: u.keeping,
            last_trained_week_anchor: u.last_trained_week_anchor,
            last_trained_session_at: u.last_trained_session_at,
            last_trained_type: u.last_trained_type,
            skill_level: u.skill_level
          })
          .eq('id', u.id);
        if (error) { console.error('Player update failed', error); toast('Save failed'); return; }
      }

      // Update user XP: +50 session + level-up total
      const addXp = sessionXp + levelUpXpTotal;
      if (addXp > 0){
        const { data: p0 } = await supabase.from('profiles').select('xp').eq('user_id', currentUser.id).maybeSingle();
        if (p0) {
          await supabase.from('profiles').update({ xp: (p0.xp||0) + addXp }).eq('user_id', currentUser.id);
        }
      }

      // Show Result modal
      showResultModal({
        lines: resultLines,
        totalXp: addXp,
        sessionXp,
        levelUpXp: levelUpXpTotal
      });

      // Refresh list
      const { data } = await supabase.from('players')
        .select('id, team_id, name, role, batting, bowling, keeping, age_years, age_days, image_url, is_wk, last_trained_week_anchor, last_trained_type, team_name, manager_name, skill_level')
        .eq('team_id', teamId)
        .order('name', { ascending:true });
      players = data || [];
      renderPlayers();
    }

    function showResultModal({ lines, totalXp, sessionXp, levelUpXp }){
      $('#result-meta').textContent = `You earned +${sessionXp} XP for completing the session` + (levelUpXp ? ` and +${levelUpXp} XP from level upgrades.` : '.');
      const listEl = $('#result-list'); listEl.innerHTML='';
      lines.forEach(t=>{
        const div=document.createElement('div');
        div.className='result-line';
        div.textContent=t;
        listEl.append(div);
      });
      const total = document.createElement('div');
      total.style.marginTop='6px';
      total.innerHTML = `<span class="xp-badge">Total XP: +${totalXp}</span>`;
      listEl.append(total);
      $('#result-wrap').classList.remove('hidden');
    }

    // Optional: post-match decline hook (–1 per skill; clamp ≥0)
    async function applyPostMatchDeclineForTeam(teamId){
      const { data } = await supabase
        .from('players')
        .select('id, batting, bowling, keeping')
        .eq('team_id', teamId);
      for (const p of (data||[])){
        const nb = Math.max(0, (p.batting||0) - 1);
        const nbo = Math.max(0, (p.bowling||0) - 1);
        const nk = Math.max(0, (p.keeping||0) - 1);
        await supabase.from('players').update({
          batting: nb, bowling: nbo, keeping: nk,
          skill_level: getSkillLevel(Math.max(nb,nbo,nk))
        }).eq('id', p.id);
      }
    }
    // window.applyPostMatchDeclineForTeam = applyPostMatchDeclineForTeam;

    // Boot
    init();
  </script>
</body>
</html>
