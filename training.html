<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training – TheCricketBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    :root { --card:#111; --muted:#8a8a8a; --accent:#00e676; }
    body { background:#0b0b0b; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .container { max-width:1000px; margin:0 auto; padding:12px; }
    .section { background:linear-gradient(180deg,#121212,#0f0f0f); border:1px solid #222; border-radius:14px; padding:12px; margin:12px 0; }
    .status { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; font-weight:700; border:1px solid #2b2b2b; }
    .open { color:#0f0; }
    .closed { color:#f55; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toggle { display:flex; gap:8px; background:#101010; border:1px solid #222; border-radius:10px; padding:6px; }
    .toggle button{ background:transparent; color:#ddd; border:0; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .toggle button.active{ background:#1a1a1a; color:#fff; outline:2px solid #2a2a2a; }
    .grid { display:grid; grid-template-columns: repeat(1,minmax(0,1fr)); gap:10px; }
    @media (min-width:600px){ .grid{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (min-width:900px){ .grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .card { background:#111; border:1px solid #222; border-radius:12px; padding:10px; display:grid; grid-template-columns:72px 1fr; gap:10px; align-items:center; }
    .avatar { width:72px; height:96px; border-radius:10px; object-fit:cover; object-position:50% 0%; background:#1a1a1a; border:1px solid #222; }
    .meta h4 { margin:0; font-size:15px; }
    .meta .rowline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:12px; }
    .kv { display:grid; grid-template-columns:auto 1fr; column-gap:8px; row-gap:4px; margin-top:6px; font-size:12px; }
    .kv .k { color:#aaa; }
    .kv .v { font-weight:600; }
    .select { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .select input { width:18px; height:18px; }
    .disabled { opacity:.55; pointer-events:none; }
    .footer { position:sticky; bottom:64px; background:#0d0d0d; border:1px solid #222; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .btn { background:#1d1d1d; color:#fff; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.cta { background:linear-gradient(90deg,#0f0,#00e676); color:#000; border:0; }
    .note { color:#bbb; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:70px; background:#141414; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:700; }
    .hidden { display:none; }

    /* Results section */
    #results-section h3 { margin:2px 0 8px 0; }
    .result-list{ display:flex; flex-direction:column; gap:8px; }
    .result-block{ border:1px solid #333; border-radius:12px; padding:10px; background:#141414; }
    .result-line{ padding:8px 10px; border:1px solid #242424; border-radius:10px; background:#0d0d0d; }
    .xp-badge{ display:inline-block; background:#0f0; color:#000; font-weight:800; padding:2px 8px; border-radius:999px; }
  </style>
</head>
<body>
  <div id="top-nav"></div>

  <main class="container">
    <section class="section">
      <div class="status">
        <div class="row">
          <span id="status-pill" class="pill">Checking…</span>
          <span id="window-label" class="muted">—</span>
        </div>
        <div id="countdown" class="muted">—</div>
      </div>
      <div id="controls" class="row" style="margin-top:10px;">
        <div class="toggle" role="tablist" aria-label="Training Type">
          <button id="btn-batting" class="active" data-type="batting">Batting</button>
          <button id="btn-bowling" data-type="bowling">Bowling</button>
        </div>
        <span id="controls-note" class="note">Select exactly <b>3</b> players.</span>
      </div>
    </section>

    <section id="players-section" class="section">
      <h3 style="margin:2px 0 10px 0;">Eligible Players</h3>
      <div id="players-grid" class="grid"></div>
      <div id="empty" class="muted" style="padding:8px 0; display:none;">No players found.</div>
    </section>

    <section class="footer">
      <div id="summary" class="muted">0 of 3 selected</div>
      <button id="train-btn" class="btn cta" disabled>Train Selected</button>
    </section>

    <section id="results-section" class="section">
      <h3>Training Results</h3>
      <div id="result-list" class="result-list"></div>
    </section>
  </main>

  <div id="toast" class="toast hidden">Saved</div>
  <div id="bottom-nav"></div>

  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://iukofcmatlfhfwcechdq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Helpers
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); };
    const num = (v) => v == null ? 0 : (typeof v === 'string' ? parseFloat(v) : v);
    const round = (x, d=3) => Math.round((x + Number.EPSILON) * 10**d) / 10**d;

    // Robust WK detector
    function isWicketKeeper(p){
      if (p?.is_wk) return true;
      const r = String(p?.role || '').toLowerCase().replace(/[-_]/g,' ');
      return r === 'wk' || r === 'wicket keeper' || r === 'wicketkeeper' ||
             r.includes('wicket') || r.includes('keeper');
    }

    // Time helpers (IST)
    const MINUTES_IST = 5*60 + 30;
    const nowIST = () => { const n = new Date(); return new Date(n.getTime() + (MINUTES_IST + n.getTimezoneOffset())*60000); };
    const startOfDayIST = d => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
    const mondayAnchorIST = d => { const x = startOfDayIST(d); const diff = (x.getDay()+6)%7; x.setDate(x.getDate()-diff); return x; };
    const fmtDateYYYYMMDD = d => d.toISOString().split('T')[0];

    function windowStateIST(d = nowIST()) {
      const mon = mondayAnchorIST(d);
      const thu = new Date(mon); thu.setDate(mon.getDate()+3);
      const openMon = new Date(mon); openMon.setHours(22,0,0,0);
      const closeThu = new Date(thu); closeThu.setHours(7,0,0,0);
      const openThu = new Date(thu); openThu.setHours(22,0,0,0);
      const closeMonNext = new Date(mon); closeMonNext.setDate(mon.getDate()+7); closeMonNext.setHours(7,0,0,0);
      if (d >= openMon && d < closeThu) return { open:true, label:'Mon Session', which:'mon', closesAt: closeThu };
      if (d >= openThu && d < closeMonNext) return { open:true, label:'Thu Session', which:'thu', closesAt: closeMonNext };
      let nextOpen;
      if (d < openMon) nextOpen = openMon;
      else if (d < openThu) nextOpen = openThu;
      else { nextOpen = new Date(mon); nextOpen.setDate(mon.getDate()+7); nextOpen.setHours(22,0,0,0); }
      return { open:false, label:'Closed', which:'closed', opensAt: nextOpen };
    }

    function startStatusLoop() {
      const updateUI = () => {
        const st = windowStateIST();
        const pill = $('#status-pill'), label = $('#window-label'), cd = $('#countdown');
        const controls = $('#controls'), note = $('#controls-note');
        const used = facilityUsedThisWindow();

        if (st.open && !used) {
          pill.textContent = 'OPEN'; pill.classList.add('open'); pill.classList.remove('closed');
          label.textContent = st.label;
          const secs = Math.max(0, Math.floor((st.closesAt - nowIST())/1000));
          cd.textContent = `Closes in ${Math.floor(secs/3600)}h ${Math.floor((secs%3600)/60)}m`;
          controls.style.display = '';
          note.textContent = "Select exactly 3 players.";
        } else if (st.open && used) {
          pill.textContent = 'OPEN'; pill.classList.add('open'); pill.classList.remove('closed');
          label.textContent = st.label;
          const secs = Math.max(0, Math.floor((st.closesAt - nowIST())/1000));
          cd.textContent = `Closes in ${Math.floor(secs/3600)}h ${Math.floor((secs%3600)/60)}m`;
          controls.style.display = 'none'; // hide selection UI if already used
          note.textContent = "Already trained this session.";
        } else {
          pill.textContent = 'CLOSED'; pill.classList.add('closed'); pill.classList.remove('open');
          label.textContent = '—';
          cd.textContent = `Opens ${st.opensAt.toLocaleString('en-IN')}`;
          controls.style.display = 'none';
          note.textContent = "Opens in the next window.";
        }
      };
      updateUI(); setInterval(updateUI, 30_000);
    }

    function baseGrowth(y, d=0){
      const day = Number(d ?? 0);
      if (y > 30 || (y===30 && day>=1)) return 0;
      if (day===0) return 0;
      switch(y){
        case 16: return 1.50; case 17: return 1.30; case 18: return 1.25; case 19: return 1.15;
        case 20: return 1.10; case 21: return 1.05; case 22: return 1.00; case 23: return 0.95;
        case 24: return 0.90; case 25: return 0.85; case 26: return 0.80; case 27: return 0.75;
        case 28: return 0.70; case 29: return 0.65; case 30: return 0.00; default: return 0;
      }
    }

    function getSkillLevel(v){
      if (v >= 101) return "The Boss";
      if (v >= 81) return "Titan";
      if (v >= 61) return "World Class";
      if (v >= 51) return "Supreme";
      if (v >= 41) return "National";
      if (v >= 31) return "Professional";
      if (v >= 21) return "Domestic";
      if (v >= 11) return "Trainee";
      return "Newbie";
    }

    const XP_BY_UPGRADE = {
      "Newbie>Trainee":10,"Trainee>Domestic":20,"Domestic>Professional":30,"Professional>National":40,
      "National>Supreme":50,"Supreme>World Class":100,"World Class>Titan":200,"Titan>The Boss":500
    };

    const overallLevelName = p => getSkillLevel(Math.max(num(p.batting), num(p.bowling), num(p.keeping)));
    const weekAnchorStrIST = (d = nowIST()) => fmtDateYYYYMMDD(mondayAnchorIST(d));

    function computeDeltasForPlayer(p, type){
      const base = baseGrowth(p.age_years||0, p.age_days||0);
      const del = { batting:0, bowling:0, keeping:0 };
      if (base===0) return del;
      if (isWicketKeeper(p)) {
        if (type==='bowling') return del;           // WK not allowed
        del.batting = +(0.75*base).toFixed(3);
        del.keeping = +(0.50*base).toFixed(3);
        return del;
      }
      const role = String(p.role||'').toLowerCase();
      if (role==='allrounder'){
        if (type==='batting'){ del.batting=+(0.75*base).toFixed(3); del.bowling=+(0.25*base).toFixed(3); }
        else { del.bowling=+(0.75*base).toFixed(3); del.batting=+(0.25*base).toFixed(3); }
        return del;
      }
      if (type==='batting') del.batting=+base.toFixed(3); else del.bowling=+base.toFixed(3);
      return del;
    }

    // ---- Page state
    let sessionType='batting', players=[], teamId=null, currentUser=null, profile=null;

    $('#btn-batting').addEventListener('click', ()=>setType('batting'));
    $('#btn-bowling').addEventListener('click', ()=>setType('bowling'));
    $('#train-btn').addEventListener('click', onTrain);

    function setType(t){ sessionType=t; $$('.toggle button').forEach(b=>b.classList.toggle('active', b.dataset.type===t)); renderPlayers(); }

    // Has this user already used the current window?
    function facilityUsedThisWindow(){
      if (!profile) return false;
      const st = windowStateIST();
      if (!st.open) return false;
      const anchor = weekAnchorStrIST();
      return profile.last_training_window_anchor === anchor && profile.last_training_window_which === st.which;
    }

    async function init(){
      await loadSmoothUI(); 
      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ location.href='login.html'; return; }
      currentUser=user;

      const { data: prof } = await supabase.from('profiles')
        .select('user_id, team_id, xp, manager_name, last_training_window_anchor, last_training_window_which')
        .eq('user_id', user.id).maybeSingle();
      if (!prof) return; profile=prof; teamId=prof.team_id;

      startStatusLoop(); // after profile is loaded (so it can read facilityUsedThisWindow)

      const { data } = await supabase.from('players')
        .select('id, team_id, name, role, batting, bowling, keeping, age_years, age_days, image_url, is_wk, last_trained_week_anchor, last_trained_type, team_name, manager_name, skill_level')
        .eq('team_id', teamId).order('name', { ascending:true });
      players = data || [];
      renderPlayers();
    }

    function renderPlayers(){
      const grid=$('#players-grid'); grid.innerHTML='';
      if(!players.length){ $('#empty').style.display='block'; return;} $('#empty').style.display='none';

      const weekAnchor=weekAnchorStrIST(); 
      const st=windowStateIST();
      const used = facilityUsedThisWindow();

      // hide WKs in Bowling tab
      const list = players.filter(p => !(sessionType==='bowling' && isWicketKeeper(p)));

      list.forEach(p=>{
        const card=document.createElement('div'); card.className='card';
        const img=document.createElement('img'); img.className='avatar'; img.src=p.image_url||'/assets/player.png'; img.alt=p.name; card.append(img);

        const meta=document.createElement('div'); meta.className='meta';
        const title=document.createElement('div'); title.className='rowline';
        const nameEl=document.createElement('h4'); nameEl.textContent=p.name;
        const roleLbl=isWicketKeeper(p)?'Wicket Keeper':(p.role||'Player');
        const ageEl=document.createElement('span'); ageEl.className='muted'; ageEl.textContent=`• ${roleLbl} • Age ${p.age_years||0}y ${p.age_days||0}d`;
        title.append(nameEl, ageEl);

        const kv=document.createElement('div'); kv.className='kv';
        const row=(k,v)=>{ const a=document.createElement('div');a.className='k';a.textContent=k; const b=document.createElement('div');b.className='v';b.textContent=v; kv.append(a,b); };
        row('BAT', getSkillLevel(num(p.batting)));
        row('BOW', getSkillLevel(num(p.bowling)));
        row('KEEP', getSkillLevel(num(p.keeping)));

        const info=document.createElement('div'); info.className='muted';
        const disabledByWeek = (p.last_trained_week_anchor && fmtDateYYYYMMDD(new Date(p.last_trained_week_anchor)) === weekAnchor);
        if (used) info.textContent='Already trained this session';
        else if (disabledByWeek) info.textContent='Already trained this week';
        else if (baseGrowth(p.age_years||0, p.age_days||0)===0) info.textContent='No gain at current age';
        else info.textContent='Eligible';

        const select=document.createElement('label'); select.className='select';
        const chk=document.createElement('input'); chk.type='checkbox';
        const labelSpan=document.createElement('span'); labelSpan.textContent='Select';
        select.append(chk,labelSpan);

        chk.disabled = !st.open || used || disabledByWeek;
        chk.addEventListener('change', ()=>{
          const chosen = $$('#players-grid input[type="checkbox"]:checked').length;
          $('#summary').textContent = `${chosen} of 3 selected`;
          $('#train-btn').disabled = !(chosen===3 && st.open && !used);
        });

        meta.append(title, kv, info, select); card.append(meta);
        if (!st.open || used || disabledByWeek) card.classList.add('disabled');
        grid.append(card);
      });

      $('#summary').textContent = `0 of 3 selected`;
      $('#train-btn').disabled = !(st.open && !facilityUsedThisWindow());
    }

    async function onTrain(){
      const st = windowStateIST(); 
      if (!st.open) { toast('Training window closed'); return; }
      if (facilityUsedThisWindow()) { toast('You already trained this session'); return; }

      const checks = $$('#players-grid input[type="checkbox"]');
      const idxs = checks.map((c,i)=>c.checked ? i : -1).filter(i=>i>=0);
      if (idxs.length !== 3) { toast('Select exactly 3'); return; }

      const weekAnchor = weekAnchorStrIST();
      const now = new Date().toISOString();

      const filteredList = players.filter(p => !(sessionType==='bowling' && isWicketKeeper(p)));
      const chosen = idxs.map(i => filteredList[i]);

      const updates = []; let sessionXp = 50; let levelUpXpTotal = 0; const resultLines = [];
      for (const p of chosen){
        const beforeOverall = overallLevelName(p);
        const del = computeDeltasForPlayer(p, sessionType);

        const newBat = round(num(p.batting) + (del.batting || 0), 3);
        const newBow = round(num(p.bowling) + (del.bowling || 0), 3);
        const newKeep = round(num(p.keeping) + (del.keeping || 0), 3);

        const afterOverall = getSkillLevel(Math.max(newBat, newBow, newKeep));

        if (beforeOverall !== afterOverall){
          const key = `${beforeOverall}>${afterOverall}`; const add = XP_BY_UPGRADE[key] || 0;
          if (add>0){
            levelUpXpTotal += add;
            const roleText = isWicketKeeper(p)?'Wicket Keeper':(p.role||'Player');
            resultLines.push(`${p.name} (${roleText}) upgraded to ${afterOverall} level from ${beforeOverall} level. (User XP earned : + ${add} XP)`);
          }
        } else {
          const roleText = isWicketKeeper(p)?'Wicket Keeper':(p.role||'Player');
          resultLines.push(`${p.name} (${roleText}) trained in ${sessionType.charAt(0).toUpperCase()+sessionType.slice(1)} (no level change).`);
        }

        updates.push({
          id: p.id, batting:newBat, bowling:newBow, keeping:newKeep,
          last_trained_week_anchor: weekAnchor,
          last_trained_session_at: now,
          last_trained_type: sessionType,
          skill_level: afterOverall
        });
      }

      // Save players
      for (const u of updates){
        const { error } = await supabase.from('players').update({
          batting:u.batting, bowling:u.bowling, keeping:u.keeping,
          last_trained_week_anchor:u.last_trained_week_anchor,
          last_trained_session_at:u.last_trained_session_at,
          last_trained_type:u.last_trained_type,
          skill_level:u.skill_level
        }).eq('id', u.id);
        if (error){ console.error('Player update failed', error); toast('Save failed'); return; }
      }

      // Mark the session as USED for this window on profiles
      await supabase.from('profiles').update({
        last_training_window_anchor: weekAnchor,
        last_training_window_which: st.which
      }).eq('user_id', currentUser.id);

      // Update user XP
      const addXp = 50 + levelUpXpTotal;
      const { data: p0 } = await supabase.from('profiles').select('xp').eq('user_id', currentUser.id).maybeSingle();
      if (p0){ await supabase.from('profiles').update({ xp: (p0.xp||0) + addXp }).eq('user_id', currentUser.id); }

      appendResult({ lines: resultLines, totalXp: addXp, sessionXp: 50, levelUpXp: levelUpXpTotal });

      // Refresh profile (so UI locks immediately) and players list
      const { data: prof2 } = await supabase.from('profiles')
        .select('user_id, team_id, xp, manager_name, last_training_window_anchor, last_training_window_which')
        .eq('user_id', currentUser.id).maybeSingle();
      if (prof2) profile = prof2;

      const { data } = await supabase.from('players')
        .select('id, team_id, name, role, batting, bowling, keeping, age_years, age_days, image_url, is_wk, last_trained_week_anchor, last_trained_type, team_name, manager_name, skill_level')
        .eq('team_id', teamId).order('name', { ascending:true });
      players = data || []; 
      renderPlayers();
      startStatusLoop(); // re-run to hide controls text
    }

    function appendResult({ lines, totalXp, sessionXp, levelUpXp }){
      const listEl = $('#result-list');
      const block = document.createElement('div'); block.className='result-block';
      const time = new Date().toLocaleString('en-IN');
      const meta = document.createElement('div'); meta.className='muted';
      meta.textContent = `${time} — You earned +${sessionXp} XP for completing this training` + (levelUpXp ? ` and +${levelUpXp} XP from level upgrades.` : '.');
      const ul = document.createElement('div'); ul.className='result-list';
      lines.forEach(t=>{ const d=document.createElement('div'); d.className='result-line'; d.textContent=t; ul.append(d); });
      const total = document.createElement('div'); total.style.marginTop='6px'; total.innerHTML = `<span class="xp-badge">Total XP: +${totalXp}</span>`;
      block.append(meta, ul, total);
      listEl.prepend(block);
    }

    // Optional decline hook
    async function applyPostMatchDeclineForTeam(teamId){
      const { data } = await supabase.from('players').select('id, batting, bowling, keeping').eq('team_id', teamId);
      for (const p of (data||[])){
        const nb = Math.max(0, num(p.batting)-1), nbo = Math.max(0, num(p.bowling)-1), nk = Math.max(0, num(p.keeping)-1);
        await supabase.from('players').update({
          batting: nb, bowling: nbo, keeping: nk,
          skill_level: getSkillLevel(Math.max(nb,nbo,nk))
        }).eq('id', p.id);
      }
    }
    // window.applyPostMatchDeclineForTeam = applyPostMatchDeclineForTeam;

    // Boot
    await loadSmoothUI(); // ensure nav first
    init();
  </script>
</body>
</html>
