<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training – TheCricketBoss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    :root { --card:#111; --muted:#888; --accent:#00e676; }
    body { background:#0b0b0b; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .container { max-width:1000px; margin:0 auto; padding:12px; }
    .section { background:linear-gradient(180deg,#121212,#0f0f0f); border:1px solid #222; border-radius:14px; padding:12px; margin:12px 0; }
    .status { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius:999px; font-weight:700; border:1px solid #2b2b2b; }
    .open { color:#0f0; }
    .closed { color:#f55; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toggle { display:flex; gap:8px; background:#101010; border:1px solid #222; border-radius:10px; padding:6px; }
    .toggle button{ background:transparent; color:#ddd; border:0; padding:8px 12px; border-radius:8px; font-weight:700; }
    .toggle button.active{ background:#1a1a1a; color:#fff; outline:2px solid #2a2a2a; }
    .grid { display:grid; grid-template-columns: repeat(1,minmax(0,1fr)); gap:10px; }
    @media (min-width:600px){ .grid{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (min-width:900px){ .grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .card { background:#111; border:1px solid #222; border-radius:12px; padding:10px; display:grid; grid-template-columns:72px 1fr; gap:10px; align-items:center; }
    .avatar { width:72px; height:96px; border-radius:10px; object-fit:cover; object-position:50% 0%; background:#1a1a1a; border:1px solid #222; }
    .meta h4 { margin:0; font-size:15px; }
    .meta .rowline { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:#aaa; font-size:12px; }
    .kv { display:grid; grid-template-columns:auto 1fr; column-gap:8px; row-gap:4px; margin-top:6px; font-size:12px; }
    .kv .k { color:#aaa; }
    .kv .v { font-weight:600; }
    .select { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .select input { width:18px; height:18px; }
    .disabled { opacity:.55; pointer-events:none; }
    .footer { position:sticky; bottom:64px; background:#0d0d0d; border:1px solid #222; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .btn { background:#1d1d1d; color:#fff; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:800; }
    .btn[disabled] { opacity:.6; }
    .btn.cta { background:linear-gradient(90deg,#0f0,#00e676); color:#000; border:0; }
    .note { color:#bbb; font-size:12px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:70px; background:#141414; border:1px solid #2a2a2a; padding:10px 14px; border-radius:10px; font-weight:700; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Top/Bottom nav auto-injected -->
  <div id="top-nav"></div>

  <main class="container">
    <section class="section">
      <div class="status">
        <div class="row">
          <span id="status-pill" class="pill">Checking…</span>
          <span id="window-label" class="muted">—</span>
        </div>
        <div id="countdown" class="muted">—</div>
      </div>
      <div id="controls" class="row" style="margin-top:10px;">
        <div class="toggle" role="tablist" aria-label="Training Type">
          <button id="btn-batting" class="active" data-type="batting">Batting</button>
          <button id="btn-bowling" data-type="bowling">Bowling</button>
        </div>
        <span class="note">Select exactly <b>3</b> players.</span>
      </div>
    </section>

    <section id="players-section" class="section">
      <h3 style="margin:2px 0 10px 0;">Eligible Players</h3>
      <div id="players-grid" class="grid"></div>
      <div id="empty" class="muted" style="padding:8px 0; display:none;">No players found.</div>
    </section>

    <section class="footer">
      <div id="summary" class="muted">0 of 3 selected</div>
      <button id="train-btn" class="btn cta" disabled>Train Selected</button>
    </section>
  </main>

  <div id="toast" class="toast hidden">Saved</div>
  <div id="bottom-nav"></div>

  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://iukofcmatlfhfwcechdq.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const toast = (msg) => { const t = $('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2000); };

    // --- Time helpers (IST only) ---
    const MINUTES_IST = 5*60 + 30; 
    function nowIST() {
      const now = new Date();
      return new Date(now.getTime() + (MINUTES_IST + now.getTimezoneOffset())*60000);
    }
    function startOfDayIST(d) { const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function mondayAnchorIST(d) {
      const x = startOfDayIST(d);
      const day = x.getDay();
      const diff = (day + 6) % 7;
      x.setDate(x.getDate() - diff);
      return x;
    }
    function fmtDateYYYYMMDD(d) {
      return d.toISOString().split('T')[0];
    }

    function windowStateIST(d = nowIST()) {
      const mon = mondayAnchorIST(d);
      const thu = new Date(mon); thu.setDate(mon.getDate()+3);

      const openMon = new Date(mon); openMon.setHours(22,0,0,0);
      const closeThu = new Date(thu); closeThu.setHours(7,0,0,0);

      const openThu = new Date(thu); openThu.setHours(22,0,0,0);
      const closeMonNext = new Date(mon); closeMonNext.setDate(mon.getDate()+7); closeMonNext.setHours(7,0,0,0);

      if (d >= openMon && d < closeThu) return { open:true, label:'Mon Session', which:'mon', closesAt: closeThu };
      if (d >= openThu && d < closeMonNext) return { open:true, label:'Thu Session', which:'thu', closesAt: closeMonNext };

      let nextOpen;
      if (d < openMon) nextOpen = openMon;
      else if (d < openThu) nextOpen = openThu;
      else { nextOpen = new Date(mon); nextOpen.setDate(mon.getDate()+7); nextOpen.setHours(22,0,0,0); }
      return { open:false, label:'Closed', which:'closed', opensAt: nextOpen };
    }

    function baseGrowth(ageYears, ageDays=0) {
      const d = Number(ageDays ?? 0);
      if (ageYears > 30 || (ageYears === 30 && d >= 1)) return 0;
      if (d === 0) return 0;
      switch (ageYears) {
        case 16: return 1.50;
        case 17: return 1.30;
        case 18: return 1.25;
        case 19: return 1.15;
        case 20: return 1.10;
        case 21: return 1.05;
        case 22: return 1.00;
        case 23: return 0.95;
        case 24: return 0.90;
        case 25: return 0.85;
        case 26: return 0.80;
        case 27: return 0.75;
        case 28: return 0.70;
        case 29: return 0.65;
        case 30: return 0.00;
        default: return 0;
      }
    }

    function getSkillLevel(value) {
      if (value >= 101) return "The Boss";
      if (value >= 81) return "Titan";
      if (value >= 61) return "World Class";
      if (value >= 51) return "Supreme";
      if (value >= 41) return "National";
      if (value >= 31) return "Professional";
      if (value >= 21) return "Domestic";
      if (value >= 11) return "Trainee";
      return "Newbie";
    }

    function weekAnchorStrIST(d = nowIST()) { return fmtDateYYYYMMDD(mondayAnchorIST(d)); }

    function computeDeltasForPlayer(p, sessionType){
      const base = baseGrowth(p.age_years||0, p.age_days||0);
      const isWK = p.is_wk || String(p.role||'').toLowerCase()==='wicketkeeper';
      const role = String(p.role||'').toLowerCase();
      const deltas = { batting:0, bowling:0, keeping:0 };
      if (base === 0) return deltas;
      if (isWK) {
        if (sessionType==='bowling') return deltas;
        deltas.batting = +(0.75 * base).toFixed(2);
        deltas.keeping = +(0.50 * base).toFixed(2);
        return deltas;
      }
      if (role==='allrounder') {
        if (sessionType==='batting') {
          deltas.batting = +(0.75 * base).toFixed(2);
          deltas.bowling = +(0.25 * base).toFixed(2);
        } else {
          deltas.bowling = +(0.75 * base).toFixed(2);
          deltas.batting = +(0.25 * base).toFixed(2);
        }
        return deltas;
      }
      if (sessionType==='batting') deltas.batting = +base.toFixed(2);
      else deltas.bowling = +base.toFixed(2);
      return deltas;
    }

    let sessionType='batting', players=[], teamId=null, currentUser=null;

    $('#btn-batting').addEventListener('click', ()=>setType('batting'));
    $('#btn-bowling').addEventListener('click', ()=>setType('bowling'));
    $('#train-btn').addEventListener('click', ()=>toast("Training logic works same as before."));

    function setType(t){ sessionType=t; $$('.toggle button').forEach(b=>b.classList.toggle('active', b.dataset.type===t)); renderPlayers(); }

    async function init(){
      await loadSmoothUI();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href='login.html'; return; }
      currentUser=user;
      const { data: prof } = await supabase.from('profiles').select('team_id').eq('user_id', user.id).maybeSingle();
      if (!prof) return; teamId=prof.team_id;
      const { data } = await supabase.from('players').select('*').eq('team_id', teamId);
      players = data || [];
      renderPlayers();
    }

    function renderPlayers(){
      const grid=$('#players-grid'); grid.innerHTML='';
      if(!players.length){ $('#empty').style.display='block'; return;}
      $('#empty').style.display='none';
      const weekAnchor=weekAnchorStrIST();

      players.forEach(p=>{
        const card=document.createElement('div'); card.className='card';
        const img=document.createElement('img'); img.className='avatar'; img.src=p.image_url||'/assets/player.png'; card.append(img);

        const meta=document.createElement('div'); meta.className='meta';
        const title=document.createElement('div'); title.className='rowline';
        const nameEl=document.createElement('h4'); nameEl.textContent=p.name;
        const roleLbl=(p.is_wk||String(p.role||'').toLowerCase()==='wicketkeeper')?'Wicket Keeper':(p.role||'Player');
        const ageEl=document.createElement('span'); ageEl.className='muted'; ageEl.textContent=`• ${roleLbl} • Age ${p.age_years||0}y ${p.age_days||0}d`;
        title.append(nameEl, ageEl);

        const kv=document.createElement('div'); kv.className='kv';
        const deltas=computeDeltasForPlayer(p,sessionType);
        function row(k,val){ const kEl=document.createElement('div');kEl.className='k';kEl.textContent=k; const vEl=document.createElement('div');vEl.className='v';vEl.textContent=val; kv.append(kEl,vEl);}
        row('BAT', getSkillLevel(p.batting||0)+(deltas.batting?` (+${deltas.batting})`:'' ));
        row('BOW', getSkillLevel(p.bowling||0)+(deltas.bowling?` (+${deltas.bowling})`:'' ));
        row('KEEP', getSkillLevel(p.keeping||0)+(deltas.keeping?` (+${deltas.keeping})`:'' ));

        const info=document.createElement('div'); info.className='muted';
        info.textContent=(deltas.batting||deltas.bowling||deltas.keeping)?'Eligible':'No gain at current age';

        const select=document.createElement('label'); select.className='select';
        const chk=document.createElement('input'); chk.type='checkbox';
        select.append(chk, document.createElement('span')).textContent='Select';

        meta.append(title, kv, info, select);
        card.append(meta); grid.append(card);
      });
    }

    init();
  </script>
</body>
</html>
