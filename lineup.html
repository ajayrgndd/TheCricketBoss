<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set Lineup â€“ TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css" />
  <style>
    .player-select {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .player-card {
      background: #2c2f4a;
      padding: 10px;
      border-radius: 8px;
      color: white;
    }
    .order-label {
      display: block;
      margin-top: 6px;
      font-size: 14px;
    }
    select {
      margin-top: 4px;
      width: 100%;
      padding: 4px;
      font-size: 14px;
    }
    button {
      background: #00e676;
      padding: 10px 16px;
      border: none;
      font-size: 16px;
      border-radius: 6px;
      margin-top: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="main">
    <h2>Set Your Lineup</h2>
    <div id="lineupForm"></div>
    <button id="saveLineupBtn">Save Lineup</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient("https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE");

    const params = new URLSearchParams(window.location.search);
    const match_id = params.get("match_id");

    if (!match_id) {
      alert("No match ID provided.");
      window.location.href = "fixture.html";
    }

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) window.location.href = "index.html";

    const { data: team } = await supabase.from("teams").select("*").eq("owner_id", user.id).single();
    const { data: players } = await supabase.from("players").select("*").eq("team_id", team.id);

    const formDiv = document.getElementById("lineupForm");

    players.sort((a, b) => (b.batting + b.bowling) - (a.batting + a.bowling)); // sort by skill

    const playingXI = players.slice(0, 11); // top 11 as default
    const bowlingCandidates = players;

    let battingOrder = Array(11).fill(null);
    let bowlingOrder = Array(5).fill(null);

    function buildForm() {
      formDiv.innerHTML = '<h3>Batting Order (Top 11)</h3>';
      playingXI.forEach((player, i) => {
        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `
          <strong>${player.name}</strong> (Skill: ${player.batting + player.bowling})<br/>
          <label class="order-label">Batting Position:
            <select class="batting-order" data-player-id="${player.id}">
              ${Array.from({ length: 11 }, (_, x) => `<option value="${x+1}">${x+1}</option>`).join("")}
            </select>
          </label>
        `;
        formDiv.appendChild(card);
      });

      formDiv.innerHTML += '<h3>Bowling Order (Max 4 overs per bowler, no consecutive overs)</h3>';
      bowlingCandidates.forEach((player) => {
        const card = document.createElement("div");
        card.className = "player-card";
        card.innerHTML = `
          <strong>${player.name}</strong> (Bowling: ${player.bowling})<br/>
          <label class="order-label">Bowling Position (Optional):
            <select class="bowling-order" data-player-id="${player.id}">
              <option value="">-- Not Bowling --</option>
              ${Array.from({ length: 10 }, (_, x) => `<option value="${x+1}">Over ${x+1}</option>`).join("")}
            </select>
          </label>
        `;
        formDiv.appendChild(card);
      });
    }

    buildForm();

    document.getElementById("saveLineupBtn").addEventListener("click", async () => {
      const battingSelectors = document.querySelectorAll(".batting-order");
      const bowlingSelectors = document.querySelectorAll(".bowling-order");

      const battingMap = {};
      battingSelectors.forEach(select => {
        const playerId = select.dataset.playerId;
        const pos = parseInt(select.value);
        if (!isNaN(pos)) battingMap[pos] = playerId;
      });

      const orderedBatting = Object.keys(battingMap).sort().map(pos => battingMap[pos]);
      if (orderedBatting.length !== 11) {
        alert("Please assign unique batting positions to all 11 players.");
        return;
      }

      const bowlingMap = {};
      bowlingSelectors.forEach(select => {
        const playerId = select.dataset.playerId;
        const over = parseInt(select.value);
        if (!isNaN(over)) bowlingMap[over] = playerId;
      });

      const orderedBowling = Object.keys(bowlingMap).sort((a, b) => a - b).map(over => bowlingMap[over]);

      // Save lineup to Supabase
      const { error } = await supabase.from("lineups").upsert({
        match_id,
        team_id: team.id,
        playing_xi: orderedBatting,
        batting_order: orderedBatting,
        bowling_order: orderedBowling
      }, { onConflict: "match_id,team_id" });

      if (!error) {
        alert("Lineup saved!");
        window.location.href = "home.html";
      } else {
        alert("Error saving lineup: " + error.message);
      }
    });
  </script>
</body>
</html>
