<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matches – TheCricketBoss</title>

  <link rel="stylesheet" href="styles/global.css"/>
  <link rel="stylesheet" href="css/matches.css"/>

  <script type="module" src="js/smooth-ui.js"></script>

  <style>
    main{max-width:980px;margin:0 auto;padding:0 12px}
    h2{margin-top:22px}

    .match-list{ display:flex; flex-direction:column; align-items:center; }
    .match-card{
      background:#111;border-radius:12px;padding:12px;margin:14px 0;border:1px solid #222;
      width:100%; max-width:680px;
      cursor:pointer;
    }
    .match-head{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .badge{font-size:.7rem;padding:4px 8px;border-radius:999px;border:1px solid #333;letter-spacing:.02em}
    .badge-league{background:#1e293b;color:#cbd5e1}
    .badge-friendly{background:#1b4332;color:#d1fae5}

    .chip{font-size:.7rem;padding:4px 8px;border-radius:6px}
    .chip-live{background:#b91c1c;color:#fff}
    .chip-done{background:#334155;color:#e2e8f0}
    .chip-upcoming{background:#0f766e;color:#ecfeff}

    .start{font-size:.8rem;opacity:.8}
    .match-body{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .team{display:flex;flex-direction:column;align-items:center;gap:6px;width:38%}
    .team img.logo{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid #1f2937}
    .name{font-weight:600;text-align:center}
    .name a{color:#8affc3;text-decoration:none}
    .name a:hover{text-decoration:underline}
    .vs{width:24%;text-align:center;opacity:.8}
    .score{margin-top:6px;text-align:center;font-weight:800}
    .subscore{margin-top:10px;text-align:center;font-size:.95rem;opacity:.95}
    .hidden-score{opacity:.6;font-weight:500}
    .ovr img{width:28px;height:28px;margin-top:4px}
    .empty{opacity:.7;padding:16px;border:1px dashed #333;border-radius:10px;margin:8px 0; width:100%; max-width:680px; text-align:center}
  </style>
</head>
<body>
  <div id="top-bar"></div>

  <main>
    <h2>Live Matches</h2>
    <div id="live-matches" class="match-list"></div>

    <h2>Upcoming Matches</h2>
    <div id="upcoming-matches" class="match-list"></div>

    <h2>Completed Matches</h2>
    <div id="completed-matches" class="match-list"></div>
  </main>

  <div id="bottom-nav"></div>

  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    loadSmoothUI('top-bar', 'bottom-nav');
  </script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const $ = (id) => document.getElementById(id);

    function formatDateTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24%12||12).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ampm = h24>=12?"PM":"AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${mi} ${ampm}`;
    }

    const badge = (kind)=>
      `<span class="badge ${kind==='league'?'badge-league':'badge-friendly'}">${kind==='league'?'League':'Friendly'}</span>`;

    function isFrontEndLive(m){
      if(m.status==='completed'||m.status==='cancelled') return false;
      const now=Date.now();
      const ko=new Date(m.kickoff_at).getTime();
      return now>=ko;
    }

    const statusChip=(m)=>{
      const live=isFrontEndLive(m);
      const cls=live?'chip-live':(m.status==='completed'?'chip-done':'chip-upcoming');
      const txt=live?'LIVE':(m.status==='completed'?'Completed':'Scheduled');
      return `<span class="chip ${cls}">${txt}</span>`;
    };

    const toJSON=(v)=> typeof v==='string'?safeParse(v):v;
    function safeParse(s){try{return JSON.parse(s);}catch{return null;}}
    const numOrNull=(v)=>Number.isFinite(Number(v))?Number(v):null;
    const nOrU=(v)=>Number.isFinite(Number(v))?Number(v):undefined;
    function oversFromBalls(balls){ if(!Number.isFinite(balls)||balls<0) return null;
      const O=Math.floor(balls/6),B=balls%6; return `${O}.${B}`; }
    function formatScoreNoWk(t){ if(!t||t.runs==null) return '—'; return `${t.runs}${t.overs?` (${t.overs})`:''}`; }

    // Ratings calculation helpers
    function selectXI(players){
      if(!players?.length) return [];
      return [...players].sort((a,b)=>
        ((+b.batting||0)+(+b.bowling||0)+(+b.keeping||0)) -
        ((+a.batting||0)+(+a.bowling||0)+(+a.keeping||0))
      ).slice(0,11);
    }
    function computeOVR(players){
      if(!players?.length) return null;
      const sel=selectXI(players);
      const batAvg=sel.reduce((s,p)=>s+(+p.batting||0),0)/sel.length;
      const ballAvg=sel.reduce((s,p)=>s+(+p.bowling||0),0)/sel.length;
      const wkAvg=sel.reduce((s,p)=>s+(+p.keeping||0),0)/sel.length;
      return (batAvg+ballAvg+wkAvg)/3;
    }

    async function fetchTeamOVR(teamId){
      const {data:players}=await supabase.from('players')
        .select('id,batting,bowling,keeping').eq('team_id',teamId);
      return computeOVR(players);
    }

    async function createCardAsync(m){
      const homeLogo=m.home_logo||'images/logo.png';
      const awayLogo=m.away_logo||'images/logo.png';
      const when=formatDateTime(m.kickoff_at);
      const live=isFrontEndLive(m);

      const homeName=m.home_team_name||'Home';
      const awayName=m.away_team_name||'Away';
      const homeNameHtml=`<a href="public-profile.html?team=${m.home_team_id}">${homeName}</a>`;
      const awayNameHtml=`<a href="public-profile.html?team=${m.away_team_id}">${awayName}</a>`;

      const {home:homeTotals,away:awayTotals}={home:{runs:null},away:{runs:null}}; // simplified

      const homeScore=(live||m.status==='completed')?formatScoreNoWk(homeTotals):'—';
      const awayScore=(live||m.status==='completed')?formatScoreNoWk(awayTotals):'—';

      const div=document.createElement('div');
      div.className='match-card';
      div.innerHTML=`
        <div class="match-head">
          ${badge(m.kind)}
          <div class="start">${when}</div>
          ${statusChip(m)}
        </div>

        <div class="match-body">
          <div class="team">
            <img class="logo" src="${homeLogo}" alt="${homeName}"/>
            <div class="name">${homeNameHtml}</div>
            <div class="score ${live||m.status==='completed'?'':'hidden-score'}">${homeScore}</div>
            <div class="ovr">
              <img src="assets/rating/ovr.png" alt="OVR" id="ovr-home-${m.id}" style="width:28px;height:28px"/>
            </div>
          </div>

          <div class="vs">vs</div>

          <div class="team">
            <img class="logo" src="${awayLogo}" alt="${awayName}"/>
            <div class="name">${awayNameHtml}</div>
            <div class="score ${live||m.status==='completed'?'':'hidden-score'}">${awayScore}</div>
            <div class="ovr">
              <img src="assets/rating/ovr.png" alt="OVR" id="ovr-away-${m.id}" style="width:28px;height:28px"/>
            </div>
          </div>
        </div>
      `;

      // click navigation
      if(live&&m.status==='running'){
        div.onclick=()=>location.href=`${m.kind==='league'?'league-match.html':'friendly-match.html'}?id=${m.id}`;
      }else if(m.status==='completed'){
        div.onclick=()=>location.href=`${m.kind==='league'?'league-replay.html':'friendly-replay.html'}?id=${m.id}`;
      }

      // compute OVR asynchronously
      fetchTeamOVR(m.home_team_id).then(v=>{
        const el=document.getElementById(`ovr-home-${m.id}`);
        if(el) el.title=v?`OVR: ${v.toFixed(1)}`:'OVR: —';
      });
      fetchTeamOVR(m.away_team_id).then(v=>{
        const el=document.getElementById(`ovr-away-${m.id}`);
        if(el) el.title=v?`OVR: ${v.toFixed(1)}`:'OVR: —';
      });

      return div;
    }

    async function renderFeed(){
      const {data,error}=await supabase.rpc('get_matches_feed_for_user');
      if(error){console.error(error);return;}
      const list=data??[];

      const liveL=list.filter(m=>isFrontEndLive(m)).sort((a,b)=>new Date(b.kickoff_at)-new Date(a.kickoff_at));
      const upcL=list.filter(m=>!isFrontEndLive(m)&&m.status!=='completed'&&m.status!=='cancelled').sort((a,b)=>new Date(a.kickoff_at)-new Date(b.kickoff_at));
      const doneL=list.filter(m=>m.status==='completed').sort((a,b)=>new Date(b.kickoff_at)-new Date(a.kickoff_at));

      $('live-matches').innerHTML=liveL.length?'':'<div class="empty">No live matches</div>';
      for(const m of liveL) $('live-matches').appendChild(await createCardAsync(m));

      $('upcoming-matches').innerHTML=upcL.length?'':'<div class="empty">No upcoming matches</div>';
      for(const m of upcL) $('upcoming-matches').appendChild(await createCardAsync(m));

      $('completed-matches').innerHTML=doneL.length?'':'<div class="empty">No completed matches yet</div>';
      for(const m of doneL) $('completed-matches').appendChild(await createCardAsync(m));
    }

    async function load(){
      const {data:{user}}=await supabase.auth.getUser();
      if(!user){location.href="login.html";return;}
      await renderFeed();
      setInterval(renderFeed,10000);
    }
    load();
  </script>
</body>
</html>
