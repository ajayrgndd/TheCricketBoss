<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matches – TheCricketBoss</title>
  <link rel="stylesheet" href="styles/global.css" />
  <script type="module" src="js/smooth-ui.js"></script>
  <style>
    body { background: #121212; color: white; font-family: Arial, sans-serif; }
    .section { margin: 20px; }
    .match-card {
      padding: 12px;
      background: #1e1e1e;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .hidden-score { color: gray; font-style: italic; }
  </style>
</head>
<body>
  <div class="section">
    <h2>Upcoming Matches</h2>
    <div id="upcoming-matches"></div>

    <h2>Live Matches</h2>
    <div id="live-matches"></div>

    <h2>Completed Matches</h2>
    <div id="completed-matches"></div>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    async function getUserId() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error || !session) {
        console.error("❌ No active session found", error);
        window.location.href = "login.html";
        return null;
      }
      return session.user.id;
    }

    async function fetchMatches(userId) {
      try {
        const today = new Date().toISOString().split("T")[0];

        // Friendly Matches
        const { data: friendlyMatches, error: fErr } = await supabase
          .from("matches")
          .select(`
            id, date, time, home_team_id, away_team_id, status, result, is_friendly
          `)
          .or(`home_team_id.eq.${userId},away_team_id.eq.${userId}`)
          .order("date", { ascending: true });

        if (fErr) throw fErr;

        // League Matches
        const { data: leagueMatches, error: lErr } = await supabase
          .from("fixtures")
          .select(`
            id, date, time, home_team_id, away_team_id, status, result
          `)
          .or(`home_team_id.eq.${userId},away_team_id.eq.${userId}`)
          .order("date", { ascending: true });

        if (lErr) throw lErr;

        return [...friendlyMatches, ...leagueMatches];
      } catch (err) {
        console.error("❌ Match fetch failed:", err);
        return [];
      }
    }

    function renderMatches(matches) {
      const upcomingEl = document.getElementById("upcoming-matches");
      const liveEl = document.getElementById("live-matches");
      const completedEl = document.getElementById("completed-matches");

      const now = new Date();

      matches.forEach(match => {
        const matchDateTime = new Date(`${match.date}T${match.time}`);
        const card = document.createElement("div");
        card.classList.add("match-card");

        if (match.status === "completed") {
          card.innerHTML = `<strong>Final:</strong> ${match.result?.score || "N/A"}`;
          completedEl.appendChild(card);
        }
        else if (match.status === "live") {
          card.innerHTML = `<strong>Live:</strong> ${
            now >= matchDateTime ? (match.result?.score || "In Progress") : `<span class="hidden-score">Score will be visible at start</span>`
          }`;
          liveEl.appendChild(card);
        }
        else {
          card.innerHTML = `<strong>Scheduled:</strong> ${match.date} ${match.time}`;
          upcomingEl.appendChild(card);
        }
      });
    }

    (async () => {
      const userId = await getUserId();
      if (!userId) return;

      const matches = await fetchMatches(userId);
      renderMatches(matches);
    })();
  </script>
</body>
</html>
