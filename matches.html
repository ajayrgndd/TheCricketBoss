<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matches – TheCricketBoss</title>

  <link rel="stylesheet" href="styles/global.css"/>
  <link rel="stylesheet" href="css/matches.css"/>

  <!-- JS (keep your existing includes) -->
  <script type="module" src="js/smooth-ui.js"></script>

  <style>
    /* badges & chips (your same look) */
    .match-card{background:#111;border-radius:12px;padding:12px;margin:14px 0;border:1px solid #222}
    .match-head{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .badge{font-size:.7rem;padding:4px 8px;border-radius:999px;border:1px solid #333;letter-spacing:.02em}
    .badge-league{background:#1e293b;color:#cbd5e1}
    .badge-friendly{background:#1b4332;color:#d1fae5}
    .chip{font-size:.7rem;padding:4px 8px;border-radius:6px}
    .chip-live{background:#b91c1c;color:#fff}
    .chip-done{background:#334155;color:#e2e8f0}
    .chip-upcoming{background:#0f766e;color:#ecfeff}
    .start{font-size:.8rem;opacity:.8}
    .match-body{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .team{display:flex;flex-direction:column;align-items:center;gap:6px;width:38%}
    .team img{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid #1f2937}
    .name{font-weight:600;text-align:center}
    .name a{color:#8affc3;text-decoration:none}
    .name a:hover{text-decoration:underline}
    .vs{width:24%;text-align:center;opacity:.8}
    .score{margin-top:6px;text-align:center;font-weight:800}
    .subscore{margin-top:2px;text-align:center;font-size:.85rem;opacity:.85}
    .hidden-score{opacity:.6;font-weight:500}
    .empty{opacity:.7;padding:16px;border:1px dashed #333;border-radius:10px;margin:8px 0}
  </style>
</head>
<body>
  <!-- Top bar (smooth-ui.js will fill) -->
  <div id="top-bar"></div>

  <main>
    <h2>Live Matches</h2>
    <div id="live-matches" class="match-list"></div>

    <h2>Upcoming Matches</h2>
    <div id="upcoming-matches" class="match-list"></div>

    <h2>Completed Matches</h2>
    <div id="completed-matches" class="match-list"></div>
  </main>

  <!-- Bottom nav (smooth-ui.js will fill) -->
  <div id="bottom-nav"></div>

  <!-- Call smooth UI into #top-bar / #bottom-nav -->
  <script type="module">
    import { loadSmoothUI } from './js/smooth-ui.js';
    loadSmoothUI('top-bar', 'bottom-nav');
  </script>

  <!-- Inline logic (uses RPC + realtime) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const $ = (id) => document.getElementById(id);

    // "DD-MM-YYYY, HH:MM AM/PM"
    function formatDateTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const h24 = d.getHours();
      const hh = String(h24 % 12 || 12).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      const ampm = h24 >= 12 ? "PM" : "AM";
      return `${dd}-${mm}-${yyyy}, ${hh}:${min} ${ampm}`;
    }

    const badge = (kind) =>
      `<span class="badge ${kind==='league'?'badge-league':'badge-friendly'}">${kind==='league'?'League':'Friendly'}</span>`;

    // Frontend: LIVE at/after kickoff
    function isFrontEndLive(m) {
      if (m.status === 'completed' || m.status === 'cancelled') return false;
      const now = Date.now();
      const ko = new Date(m.kickoff_at).getTime();
      return now >= ko;
    }

    const statusChip = (m) => {
      const s = m.status;
      const live = isFrontEndLive(m);
      const cls = live ? 'chip-live' : (s === 'completed' ? 'chip-done' : 'chip-upcoming');
      const txt = live ? 'LIVE' : (s === 'completed' ? 'Completed' : 'Scheduled');
      return `<span class="chip ${cls}">${txt}</span>`;
    };

    // ---------- Robust helpers ----------
    const toJSON = (v)=> (typeof v === 'string' ? safeParse(v) : v);
    function safeParse(s){ try { return JSON.parse(s); } catch { return null; } }

    const ob = (o,b) => {
      const O = Number(o) || 0;
      const B = Number(b);
      if (Number.isFinite(B) && B >= 0) return `${O}.${Math.min(5,B)}`;
      return String(o);
    };

    // compute overs from many shapes (fields, balls, or ball_by_ball)
    function inferOvers(totals, bbb, which=1){
      if (!totals) return null;
      const direct = totals.overs ?? totals.ov ?? totals.o ?? totals.over ?? totals.overs_f;
      if (direct != null && direct !== '') return String(direct);

      if (totals.balls != null) {
        const balls = Number(totals.balls);
        if (Number.isFinite(balls) && balls >= 0) {
          const O = Math.floor(balls/6), B = balls%6;
          return `${O}.${B}`;
        }
      }

      if (Array.isArray(bbb) && bbb.length){
        const filt = bbb.filter(d => (d.inning ?? d.innings ?? 1) === which);
        const arr = filt.length ? filt : bbb;
        const last = arr[arr.length-1];
        if (last?.over != null) return ob(last.over, last.ball);
        if (last?.o != null) return ob(last.o, last.b);
        if (last?.over_ball != null) return String(last.over_ball);
      }
      return null;
    }

    function extractCurrentTotals(result, homeId, awayId){
      if (!result) return { home:null, away:null, bbb:null };
      const bbb = result.ball_by_ball ?? result.bbb ?? null;

      if (Array.isArray(result.innings)) {
        let home = null, away = null;
        for (const [idx, inn] of result.innings.entries()) {
          const tid = String(inn.team_id ?? inn.team ?? '');
          const raw = inn.totals ?? {
            runs: inn.runs, wickets: inn.wickets ?? inn.wkts, overs: inn.overs ?? null
          };
          const overs = raw.overs ?? inferOvers(raw, bbb, idx+1);
          const totals = { ...raw, overs };
          if (String(homeId) === tid) home = totals;
          else if (String(awayId) === tid) away = totals;
        }
        return { home, away, bbb };
      }

      if (result.home || result.away) {
        const h = result.home ? {
          runs: result.home.runs ?? result.home.score,
          wickets: result.home.wickets ?? result.home.wkts,
          overs:  result.home.overs ?? result.home.ov ?? result.home.o ?? inferOvers(result.home, bbb, 1)
        } : null;
        const a = result.away ? {
          runs: result.away.runs ?? result.away.score,
          wickets: result.away.wickets ?? result.away.wkts,
          overs:  result.away.overs ?? result.away.ov ?? result.away.o ?? inferOvers(result.away, bbb, 2)
        } : null;
        return { home:h, away:a, bbb };
      }

      if (result.scoreboard && typeof result.scoreboard === 'object') {
        const fix = (x, which) => x ? ({
          runs: x.runs ?? x.score,
          wickets: x.wickets ?? x.wkts,
          overs: x.overs ?? x.ov ?? x.o ?? inferOvers(x, bbb, which)
        }) : null;
        return { home: fix(result.scoreboard[homeId],1), away: fix(result.scoreboard[awayId],2), bbb };
      }

      return { home:null, away:null, bbb };
    }

    function formatScore(totals){
      if (!totals) return '—';
      const r = totals.runs ?? totals.score;
      const w = totals.wickets ?? totals.wkts ?? 0;
      const o = totals.overs ?? inferOvers(totals, null, 1);
      let s = (r == null) ? '—' : `${r}/${w ?? 0}`;
      if (o != null && o !== '') s += ` (${o})`;
      return s;
    }

    function buildChaseText(result){
      if (!result) return '';
      if (result.target != null && result.balls_left != null) {
        const req = Number(result.target) - Number(result.current_runs ?? result.runs ?? 0);
        const left = Number(result.balls_left);
        if (Number.isFinite(req) && Number.isFinite(left))
          return `${Math.max(req,0)} runs required from ${Math.max(left,0)} balls`;
      }
      if (Array.isArray(result.innings) && result.innings.length>=2) {
        const t1 = result.innings[0]?.totals ?? result.innings[0];
        const t2 = result.innings[1]?.totals ?? result.innings[1];
        if (t1 && t2) {
          const target = Number(t1.runs ?? 0) + 1;
          const cur = Number(t2.runs ?? 0);
          const overStr = t2.overs ?? inferOvers(t2, result.ball_by_ball ?? null, 2);
          let ballsBowled = null;
          if (overStr != null) {
            const [ov, ball] = String(overStr).split('.').map(Number);
            if (Number.isFinite(ov)) ballsBowled = ov*6 + (Number.isFinite(ball)?ball:0);
          }
          const limit = Number(result.overs_limit ?? result.max_overs ?? 20);
          if (Number.isFinite(ballsBowled) && Number.isFinite(limit)) {
            const left = Math.max(limit*6 - ballsBowled, 0);
            const need = Math.max(target - cur, 0);
            return `${need} runs required from ${left} balls`;
          }
        }
      }
      return '';
    }

    function detectResultText(m, result, homeName, awayName){
      const txt = m.match_result || result?.result_text || result?.summary || result?.note;
      if (txt) return txt;

      const { home:h, away:a } = extractCurrentTotals(result, m.home_team_id, m.away_team_id);
      if (h && a && (h.runs != null) && (a.runs != null)) {
        if (h.runs === a.runs) return 'Match tied';
        if (a.runs > h.runs) {
          const wkLeft = 10 - Number(a.wickets ?? 0);
          return `${awayName} won by ${wkLeft > 0 ? wkLeft : 1} wicket${wkLeft===1?'':'s'}`;
        } else {
          const margin = Number(h.runs) - Number(a.runs);
          return `${homeName} won by ${margin} run${margin===1?'':'s'}`;
        }
      }
      if (m.winner_team_id) {
        const winner = (m.winner_team_id === m.home_team_id) ? homeName
                      : (m.winner_team_id === m.away_team_id) ? awayName : 'Winner';
        return `${winner} won`;
      }
      return '';
    }
    // ---------- /helpers ----------

    function card(m){
      const homeLogo = m.home_logo || 'images/logo.png';
      const awayLogo = m.away_logo || 'images/logo.png';
      const when = formatDateTime(m.kickoff_at);
      const live = isFrontEndLive(m);

      const homeName = m.home_team_name || 'Home';
      const awayName = m.away_team_name || 'Away';
      const homeNameHtml = `<a href="public-profile.html?team=${m.home_team_id}">${homeName}</a>`;
      const awayNameHtml = `<a href="public-profile.html?team=${m.away_team_id}">${awayName}</a>`;

      const res = toJSON(m.result) || {};
      const { home:homeTotals, away:awayTotals } = extractCurrentTotals(res, m.home_team_id, m.away_team_id);

      const homeScore = (live || m.status==='completed') ? formatScore(homeTotals) : '—';
      const awayScore = (live || m.status==='completed') ? formatScore(awayTotals) : '—';

      const chaseText  = (live && res) ? buildChaseText(res) : '';
      const resultText = (!live && m.status==='completed') ? detectResultText(m, res, homeName, awayName) : '';

      const div = document.createElement('div');
      div.className = 'match-card';
      div.innerHTML = `
        <div class="match-head">
          ${badge(m.kind)}
          <div class="start">${when}</div>
          ${statusChip(m)}
        </div>

        <div class="match-body">
          <div class="team">
            <img src="${homeLogo}" alt="${homeName}"/>
            <div class="name">${homeNameHtml}</div>
            <div class="score ${live || m.status==='completed' ? '' : 'hidden-score'}">${homeScore}</div>
          </div>

          <div class="vs">vs</div>

          <div class="team">
            <img src="${awayLogo}" alt="${awayName}"/>
            <div class="name">${awayNameHtml}</div>
            <div class="score ${live || m.status==='completed' ? '' : 'hidden-score'}">${awayScore}</div>
          </div>
        </div>

        ${live && chaseText ? `<div class="subscore">${chaseText}</div>` : ''}
        ${(!live && m.status==='completed' && resultText) ? `<div class="subscore">${resultText}</div>` : ''}
      `;

      if (live && m.status === 'running') {
        div.onclick = () => location.href = `friendly-match.html?id=${m.id}`;
        div.style.cursor = 'pointer';
      } else if (m.status === 'completed') {
        div.onclick = () => location.href = `friendly-replay.html?id=${m.id}`;
        div.style.cursor = 'pointer';
      } else {
        div.style.cursor = 'default';
      }
      return div;
    }

    // ---- Render lists & refresh ----
    async function renderFeed() {
      const { data, error } = await supabase.rpc('get_matches_feed_for_user');
      if (error) { console.error(error); return; }

      const list = data ?? [];

      const liveL  = list.filter(m => isFrontEndLive(m))
                         .sort((a,b)=> new Date(b.kickoff_at) - new Date(a.kickoff_at));
      const upcL   = list.filter(m => !isFrontEndLive(m) && m.status !== 'completed' && m.status !== 'cancelled')
                         .sort((a,b)=> new Date(a.kickoff_at) - new Date(b.kickoff_at));
      const doneL  = list.filter(m => m.status === 'completed')
                         .sort((a,b)=> new Date(b.kickoff_at) - new Date(a.kickoff_at));

      $('live-matches').innerHTML = liveL.length ? '' : '<div class="empty">No live matches</div>';
      liveL.forEach(m => $('live-matches').appendChild(card(m)));

      $('upcoming-matches').innerHTML = upcL.length ? '' : '<div class="empty">No upcoming matches</div>';
      upcL.forEach(m => $('upcoming-matches').appendChild(card(m)));

      $('completed-matches').innerHTML = doneL.length ? '' : '<div class="empty">No completed matches yet</div>';
      doneL.forEach(m => $('completed-matches').appendChild(card(m)));
    }

    async function load(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href = "login.html"; return; }

      await renderFeed();

      // Soft auto-refresh every 10s for live score progression
      setInterval(renderFeed, 10000);

      // Realtime: refresh when any of my team’s matches update (friendlies + fixtures)
      const { data: myTeam } = await supabase
        .from('teams').select('id').eq('owner_id', user.id).maybeSingle();
      if (myTeam?.id) {
        supabase.channel('matches-feed')
          .on('postgres_changes', { event:'UPDATE', schema:'public', table:'matches',  filter:`home_team_id=eq.${myTeam.id}` }, renderFeed)
          .on('postgres_changes', { event:'UPDATE', schema:'public', table:'matches',  filter:`away_team_id=eq.${myTeam.id}` }, renderFeed)
          .on('postgres_changes', { event:'UPDATE', schema:'public', table:'fixtures', filter:`home_team_id=eq.${myTeam.id}` }, renderFeed)
          .on('postgres_changes', { event:'UPDATE', schema:'public', table:'fixtures', filter:`away_team_id=eq.${myTeam.id}` }, renderFeed)
          .subscribe();
      }
    }

    load();
  </script>
</body>
</html>
