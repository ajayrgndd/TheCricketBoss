<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matches – TheCricketBoss</title>

  <link rel="stylesheet" href="styles/global.css"/>
  <link rel="stylesheet" href="css/matches.css"/>

  <!-- JS (keep your existing includes) -->
  <script type="module" src="js/smooth-ui.js"></script>

  <style>
    /* badges & chips (your same look) */
    .match-card{background:#111;border-radius:12px;padding:12px;margin:14px 0;border:1px solid #222}
    .match-head{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .badge{font-size:.7rem;padding:4px 8px;border-radius:999px;border:1px solid #333;letter-spacing:.02em}
    .badge-league{background:#1e293b;color:#cbd5e1}
    .badge-friendly{background:#1b4332;color:#d1fae5}
    .chip{font-size:.7rem;padding:4px 8px;border-radius:6px}
    .chip-live{background:#b91c1c;color:#fff}
    .chip-done{background:#334155;color:#e2e8f0}
    .chip-upcoming{background:#0f766e;color:#ecfeff}
    .start{font-size:.8rem;opacity:.8}
    .match-body{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .team{display:flex;flex-direction:column;align-items:center;gap:6px;width:38%}
    .team img{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#0b0b0b;border:1px solid #1f2937}
    .name{font-weight:600;text-align:center}
    .vs{width:24%;text-align:center;opacity:.8}
    .score{margin-top:10px;text-align:center;font-weight:700}
    .hidden-score{opacity:.6;font-weight:500}
    .empty{opacity:.7;padding:16px;border:1px dashed #333;border-radius:10px;margin:8px 0}
  </style>
</head>
<body>
  <!-- Top bar (smooth-ui.js will fill) -->
  <div id="top-bar"></div>

  <main>
    <h2>Upcoming Matches</h2>
    <div id="upcoming-matches" class="match-list"></div>

    <h2>Completed Matches</h2>
    <div id="completed-matches" class="match-list"></div>
  </main>

  <!-- Bottom nav (smooth-ui.js will fill) -->
  <div id="bottom-nav"></div>

  <!-- Inline logic (uses RPC + realtime) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://iukofcmatlfhfwcechdq.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1a29mY21hdGxmaGZ3Y2VjaGRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTczODQsImV4cCI6MjA2OTAzMzM4NH0.XMiE0OuLOQTlYnQoPSxwxjT3qYKzINnG6xq8f8Tb_IE"
    );

    const $ = (id) => document.getElementById(id);
    const fmtWhen = (ts) => ts ? new Date(ts).toLocaleString() : '';

    const badge = (kind) =>
      `<span class="badge ${kind==='league'?'badge-league':'badge-friendly'}">${kind==='league'?'League':'Friendly'}</span>`;

    const statusChip = (s) =>
      `<span class="chip ${
        s==='running' ? 'chip-live' :
        s==='completed'? 'chip-done' : 'chip-upcoming'
      }">${s==='running'?'LIVE':s==='completed'?'Completed':'Scheduled'}</span>`;

    function card(m){
      const homeLogo = m.home_logo || 'images/logo.png';
      const awayLogo = m.away_logo || 'images/logo.png';
      const when = fmtWhen(m.kickoff_at);

      const div = document.createElement('div');
      div.className = 'match-card';
      div.innerHTML = `
        <div class="match-head">
          ${badge(m.kind)}
          <div class="start">${when}</div>
          ${statusChip(m.status)}
        </div>

        <div class="match-body">
          <div class="team">
            <img src="${homeLogo}" alt="${m.home_team_name||'Home'}"/>
            <div class="name">${m.home_team_name||'Home'}</div>
            <div class="score ${m.status==='completed'?'':'hidden-score'}">
              ${m.status==='completed' ? (m.result?.home?.runs ?? '-') : '—'}
            </div>
          </div>

          <div class="vs">vs</div>

          <div class="team">
            <img src="${awayLogo}" alt="${m.away_team_name||'Away'}"/>
            <div class="name">${m.away_team_name||'Away'}</div>
            <div class="score ${m.status==='completed'?'':'hidden-score'}">
              ${m.status==='completed' ? (m.result?.away?.runs ?? '-') : '—'}
            </div>
          </div>
        </div>
      `;

      // Click behavior
      if (m.status === 'running') {
        div.onclick = () => location.href = `friendly-match.html?id=${m.id}`;
      } else if (m.status === 'completed') {
        // both league & friendly use the same replay route (ball_by_ball is public for completed)
        div.onclick = () => location.href = `friendly-replay.html?id=${m.id}`;
      }

      return div;
    }

    async function load(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href = "login.html"; return; }

      // Feed with names/logos (RLS-safe via RPC)
      const { data, error } = await supabase.rpc('get_matches_feed_for_user');
      if (error) { console.error(error); return; }

      // Split & sort by kickoff time desc/asc as you prefer
      const upcoming = (data ?? [])
        .filter(m => m.status === 'scheduled')
        .sort((a,b)=> new Date(a.kickoff_at) - new Date(b.kickoff_at));

      const completed = (data ?? [])
        .filter(m => m.status === 'completed')
        .sort((a,b)=> new Date(b.kickoff_at) - new Date(a.kickoff_at));

      $('upcoming-matches').innerHTML = upcoming.length
        ? '' : '<div class="empty">No upcoming matches</div>';
      upcoming.forEach(m => $('upcoming-matches').appendChild(card(m)));

      $('completed-matches').innerHTML = completed.length
        ? '' : '<div class="empty">No completed matches yet</div>';
      completed.forEach(m => $('completed-matches').appendChild(card(m)));

      // Realtime: refresh when any of my team’s matches update
      const { data: myTeam } = await supabase
        .from('teams').select('id').eq('owner_id', user.id).maybeSingle();
      if (!myTeam) return;

      supabase.channel('matches-feed')
        .on('postgres_changes', {
          event:'UPDATE', schema:'public', table:'matches',
          filter:`home_team_id=eq.${myTeam.id}`
        }, () => location.reload())
        .on('postgres_changes', {
          event:'UPDATE', schema:'public', table:'matches',
          filter:`away_team_id=eq.${myTeam.id}`
        }, () => location.reload())
        .subscribe();
    }

    load();
  </script>
</body>
</html>
